<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>לוח בקרה לניהול מכולות</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700&display=swap');
    
    :root {
      --primary: #4f46e5;
      --primary-light: #818cf8;
      --secondary: #f97316;
      --danger: #ef4444;
      --success: #10b981;
      --warning: #f59e0b;
      --setup: #3b82f6;
      --collection: #8b5cf6;
      --delivery: #ec4899;
    }
    
    body {
      font-family: 'Rubik', Arial, sans-serif;
      direction: rtl;
      background-color: #f8fafc;
    }
    
    .container-fade {
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
    }
    
    .metric-card {
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    
    .metric-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    
    .table-row:hover {
      background-color: #f1f5f9 !important;
    }
    
    .overdue-row {
      background-color: #fee2e2 !important;
    }
    
    .overdue-row:hover {
      background-color: #fecaca !important;
    }
    
    .today-row {
      background-color: #ecfdf5 !important;
    }
    
    .today-row:hover {
      background-color: #d1fae5 !important;
    }
    
    .closed-row {
      position: relative;
      background-color: #f3f4f6 !important;
    }
    
    .closed-row td {
      position: relative;
      color: #9ca3af !important;
    }
    
    .closed-row::after {
      content: "";
      position: absolute;
      left: 0;
      top: 50%;
      width: 100%;
      height: 1px;
      background-color: #d1d5db;
      transform: translateY(-50%);
    }
    
    .setup-row {
      background-color: #eff6ff !important;
    }
    
    .setup-row:hover {
      background-color: #dbeafe !important;
    }
    
    .collection-row {
      background-color: #f5f3ff !important;
    }
    
    .collection-row:hover {
      background-color: #ede9fe !important;
    }
    
    .delivery-row {
      background-color: #fce7f3 !important;
    }
    
    .delivery-row:hover {
      background-color: #fbcfe8 !important;
    }
    
    .chart-container {
      transition: all 0.3s ease;
    }
    
    .chart-container:hover {
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    
    .btn-primary {
      background-color: var(--primary);
      transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
      background-color: var(--primary-light);
    }
    
    .btn-secondary {
      background-color: var(--secondary);
      transition: all 0.3s ease;
    }
    
    .btn-secondary:hover {
      background-color: #fb923c;
    }
    
    .btn-success {
      background-color: var(--success);
      transition: all 0.3s ease;
    }
    
    .btn-success:hover {
      background-color: #34d399;
    }
    
    .badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .badge-primary {
      background-color: var(--primary-light);
      color: white;
    }
    
    .badge-danger {
      background-color: var(--danger);
      color: white;
    }
    
    .badge-success {
      background-color: var(--success);
      color: white;
    }
    
    .badge-warning {
      background-color: var(--warning);
      color: white;
    }
    
    .badge-setup {
      background-color: var(--setup);
      color: white;
    }
    
    .badge-collection {
      background-color: var(--collection);
      color: white;
    }
    
    .badge-delivery {
      background-color: var(--delivery);
      color: white;
    }
    
    .tooltip {
      position: relative;
      display: inline-block;
    }
    
    .tooltip .tooltip-text {
      visibility: hidden;
      width: 120px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -60px;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .tooltip:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }
    
    .alert-banner {
      animation: slideIn 0.5s ease-out;
    }
    
    @keyframes slideIn {
      from { transform: translateY(-100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    @media (max-width: 768px) {
      .metrics-grid {
        grid-template-columns: repeat(2, 1fr) !important;
      }
      
      .chart-grid {
        grid-template-columns: 1fr !important;
      }
    }
    
    @media (max-width: 480px) {
      .metrics-grid {
        grid-template-columns: 1fr !important;
      }
      
      .action-buttons {
        flex-direction: column !important;
        gap: 0.5rem !important;
      }
      
      .action-buttons button {
        width: 100% !important;
      }
    }
  </style>
</head>
<body class="min-h-screen">
  <div class="container mx-auto px-4 py-8 max-w-7xl">
    <!-- Alert Banner for Overdue Orders -->
    <div id="overdueAlert" class="hidden"></div>
    
    <!-- Header Section -->
    <header class="mb-8 text-center">
      <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2">לוח בקרה לניהול מכולות</h1>
      <p class="text-gray-600">ניהול וניתוח הזמנות מכולות בזמן אמת</p>
    </header>
    
    <!-- Action Buttons and Filters -->
    <div class="bg-white rounded-lg shadow-md p-4 mb-6">
      <div class="flex flex-wrap items-center justify-between gap-4">
        <div class="flex flex-wrap gap-2 action-buttons">
          <button id="newOrderBtn" class="btn-primary text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
            </svg>
            הזמנה חדשה
          </button>
          <button id="refreshBtn" class="btn-secondary text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
            </svg>
            רענן נתונים
          </button>
          <button id="showClosedBtn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-medium flex items-center gap-2 hover:bg-gray-300 transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
            הצג סגורות
          </button>
        </div>
        
        <div class="flex flex-wrap gap-3 items-center">
          <div class="relative">
            <input type="text" id="searchInput" placeholder="חיפוש הזמנה..." 
                   class="border border-gray-300 rounded-lg px-4 py-2 pr-10 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-3 top-2.5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
            </svg>
          </div>
          
          <select id="actionFilter" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">כל סוגי הפעולה</option>
          </select>
          
          <div class="relative">
            <input type="number" id="daysMax" placeholder="ימים שעברו (מקסימום)" 
                   class="border border-gray-300 rounded-lg px-4 py-2 w-40 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <span class="absolute left-3 top-2.5 text-gray-500 text-sm">ימים</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Metrics Cards -->
    <div class="metrics-grid grid grid-cols-4 gap-4 mb-6">
      <div class="metric-card bg-white rounded-lg p-4 shadow-sm border-l-4 border-blue-500">
        <h3 class="text-gray-500 text-sm font-medium mb-1">סה"כ הזמנות פתוחות</h3>
        <div class="flex items-center justify-between">
          <span id="totalOpen" class="text-2xl font-bold text-gray-800">0</span>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
          </svg>
        </div>
      </div>
      
      <div class="metric-card bg-white rounded-lg p-4 shadow-sm border-l-4 border-red-500">
        <h3 class="text-gray-500 text-sm font-medium mb-1">הזמנות חריגות (&gt; 10 ימים)</h3>
        <div class="flex items-center justify-between">
          <span id="overdue" class="text-2xl font-bold text-gray-800">0</span>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
      </div>
      
      <div class="metric-card bg-white rounded-lg p-4 shadow-sm border-l-4 border-green-500">
        <h3 class="text-gray-500 text-sm font-medium mb-1">פעולות איסוף היום</h3>
        <div class="flex items-center justify-between">
          <span id="todayActions" class="text-2xl font-bold text-gray-800">0</span>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
          </svg>
        </div>
      </div>
      
      <div class="metric-card bg-white rounded-lg p-4 shadow-sm border-l-4 border-orange-500">
        <h3 class="text-gray-500 text-sm font-medium mb-1">ממוצע ימים שעברו</h3>
        <div class="flex items-center justify-between">
          <span id="avgDays" class="text-2xl font-bold text-gray-800">0.0</span>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
      </div>
    </div>
    
    <!-- Charts Section -->
    <div class="chart-grid grid grid-cols-2 gap-6 mb-6">
      <div class="chart-container bg-white rounded-lg p-4 shadow-sm">
        <h3 class="text-gray-700 font-medium mb-3">התפלגות סוגי פעולה</h3>
        <canvas id="actionChart" height="150"></canvas>
      </div>
      <div class="chart-container bg-white rounded-lg p-4 shadow-sm">
        <h3 class="text-gray-700 font-medium mb-3">היסטוגרמת ימים שעברו</h3>
        <canvas id="daysChart" height="150"></canvas>
      </div>
    </div>
    
    <!-- Orders Table -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden mb-6">
      <div class="overflow-x-auto">
        <table id="ordersTable" class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">תעודה</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">שם לקוח</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">שם סוכן</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">מתאריך</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">סוג פעולה</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">ימים שעברו</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">מס" מכולה ירדה</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">מס" מכולה עלתה</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">ימים שעברו (עלתה)</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">פעולות</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <tr>
              <td colspan="10" class="px-6 py-4 text-center text-gray-500">טוען נתונים...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx7E0OrpJc7Yq4xhFTj376xVMo9VfvhLAjDZ6zdt8QGzXvlzKkANZxn4cV5AfvDPQ0m/exec';
    let allOrders = [];
    let actionChartInstance = null;
    let daysChartInstance = null;
    let showClosedOrders = false;

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
      // Add event listeners
      document.getElementById('refreshBtn').addEventListener('click', fetchOrders);
      document.getElementById('searchInput').addEventListener('input', debounce(filterOrders, 300));
      document.getElementById('actionFilter').addEventListener('change', filterOrders);
      document.getElementById('daysMax').addEventListener('input', debounce(filterOrders, 300));
      document.getElementById('showClosedBtn').addEventListener('click', toggleClosedOrders);
      
      // Initial fetch
      fetchOrders();
    });

    // Debounce function for better performance
    function debounce(func, wait) {
      let timeout;
      return function() {
        const context = this, args = arguments;
        clearTimeout(timeout);
        timeout = setTimeout(() => {
          func.apply(context, args);
        }, wait);
      };
    }

    // Toggle closed orders visibility
    function toggleClosedOrders() {
      showClosedOrders = !showClosedOrders;
      const btn = document.getElementById('showClosedBtn');
      
      if (showClosedOrders) {
        btn.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
          </svg>
          הסתר סגורות
        `;
        btn.classList.remove('bg-gray-200', 'hover:bg-gray-300');
        btn.classList.add('btn-success', 'hover:bg-green-500');
      } else {
        btn.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
          </svg>
          הצג סגורות
        `;
        btn.classList.add('bg-gray-200', 'hover:bg-gray-300');
        btn.classList.remove('btn-success', 'hover:bg-green-500');
      }
      
      filterOrders();
    }

    // Fetch orders from Google Sheets
    async function fetchOrders() {
      try {
        // Show loading state
        const tbody = document.querySelector('#ordersTable tbody');
        tbody.innerHTML = '<tr><td colspan="10" class="px-6 py-4 text-center text-gray-500"><div class="flex justify-center"><svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> טוען נתונים...</div></td></tr>';
        
        const res = await fetch(`${SCRIPT_URL}?action=list`);
        const data = await res.json();
        
        if (data.success) {
          allOrders = data.data.map(order => ({
            ...order,
            // Convert date string to proper format
            'מתאריך': formatDate(order['מתאריך']),
            // Mark as closed if status exists
            'סגורה': order['סטטוס'] === 'סגורה'
          }));
          
          populateActionFilter();
          updateDashboard(allOrders);
          checkOverdueOrders(allOrders);
        } else {
          showError('שגיאה בשליפת נתונים');
        }
      } catch (error) {
        showError('שגיאה בחיבור לשרת');
        console.error('Error fetching orders:', error);
      }
    }

    // Format date from ISO to local date string
    function formatDate(dateString) {
      if (!dateString) return '-';
      
      try {
        // Handle both ISO format (2025-08-11T21:00:00.000Z) and local date strings
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return dateString; // Return original if invalid
        
        return date.toLocaleDateString('he-IL');
      } catch (e) {
        return dateString; // Return original if parsing fails
      }
    }

    // Populate action filter dropdown
    function populateActionFilter() {
      const select = document.getElementById('actionFilter');
      const actions = [...new Set(allOrders.map(o => o['סוג פעולה']).filter(a => a))];
      select.innerHTML = '<option value="">כל סוגי הפעולה</option>';
      actions.forEach(a => {
        const option = document.createElement('option');
        option.value = a;
        option.textContent = a;
        select.appendChild(option);
      });
    }

    // Filter orders based on search criteria
    function filterOrders() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const actionFilter = document.getElementById('actionFilter').value;
      const daysMax = parseInt(document.getElementById('daysMax').value) || Infinity;

      const filtered = allOrders.filter(o => {
        // Skip closed orders if not showing them
        if (o['סגורה'] && !showClosedOrders) return false;
        
        const matchesSearch = o['שם לקוח']?.toLowerCase().includes(searchTerm) ||
                             o['שם סוכן']?.toLowerCase().includes(searchTerm) ||
                             o['תעודה']?.toLowerCase().includes(searchTerm);
        const matchesAction = actionFilter ? o['סוג פעולה'] === actionFilter : true;
        const matchesDays = parseInt(o['ימים שעברו'] || 0) <= daysMax;
        return matchesSearch && matchesAction && matchesDays;
      });

      updateDashboard(filtered);
    }

    // Update the dashboard with filtered orders
    function updateDashboard(orders) {
      // Update table
      updateOrdersTable(orders);
      
      // Update metrics (only count non-closed orders)
      const activeOrders = orders.filter(o => !o['סגורה']);
      updateMetrics(activeOrders);
      
      // Update charts
      updateCharts(activeOrders);
    }

    // Update the orders table
    function updateOrdersTable(orders) {
      const tbody = document.querySelector('#ordersTable tbody');
      tbody.innerHTML = '';
      
      if (orders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="px-6 py-4 text-center text-gray-500">לא נמצאו הזמנות תואמות.</td></tr>';
        return;
      }
      
      const today = new Date().toLocaleDateString('he-IL');
      
      orders.forEach(o => {
        const daysPassed = parseInt(o['ימים שעברו'] || 0);
        const isOverdue = daysPassed > 10;
        const isToday = o['מתאריך'] === today;
        const isClosed = o['סגורה'];
        
        // Determine row class based on action type and status
        let rowClass = 'table-row';
        if (isClosed) {
          rowClass = 'closed-row';
        } else if (o['סוג פעולה'] === 'הצבה') {
          rowClass = 'setup-row';
        } else if (o['סוג פעולה'] === 'איסוף') {
          rowClass = 'collection-row';
        } else if (o['סוג פעולה'] === 'מסירה') {
          rowClass = 'delivery-row';
        }
        
        if (isOverdue && !isClosed) rowClass += ' overdue-row';
        if (isToday && !isClosed) rowClass += ' today-row';
        
        const tr = document.createElement('tr');
        tr.className = rowClass;
        
        tr.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${isClosed ? 'text-gray-400' : 'text-gray-900'}">${o['תעודה'] || '-'}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm ${isClosed ? 'text-gray-400' : 'text-gray-500'}">${o['שם לקוח'] || '-'}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm ${isClosed ? 'text-gray-400' : 'text-gray-500'}">${o['שם סוכן'] || '-'}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm ${isClosed ? 'text-gray-400' : 'text-gray-500'}">${o['מתאריך'] || '-'}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm ${isClosed ? 'text-gray-400' : 'text-gray-500'}">
            ${o['סוג פעולה'] || '-'}
            ${isToday && !isClosed ? '<span class="badge badge-success ml-2">היום</span>' : ''}
            ${o['סוג פעולה'] === 'הצבה' ? '<span class="badge badge-setup ml-2">הצבה</span>' : ''}
            ${o['סוג פעולה'] === 'איסוף' ? '<span class="badge badge-collection ml-2">איסוף</span>' : ''}
            ${o['סוג פעולה'] === 'מסירה' ? '<span class="badge badge-delivery ml-2">מסירה</span>' : ''}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm ${isOverdue && !isClosed ? 'font-bold text-red-600' : (isClosed ? 'text-gray-400' : 'text-gray-500')}">
            ${o['ימים שעברו'] || '0'}
            ${isOverdue && !isClosed ? '<span class="badge badge-danger ml-2">חריגה</span>' : ''}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm ${isClosed ? 'text-gray-400' : 'text-gray-500'}">${o['מס" מכולה ירדה'] || '-'}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm ${isClosed ? 'text-gray-400' : 'text-gray-500'}">${o['מס" מכולה עלתה'] || '-'}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm ${isClosed ? 'text-gray-400' : 'text-gray-500'}">${o['ימים שעברו (עלתה)'] || '-'}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm ${isClosed ? 'text-gray-400' : 'text-gray-500'}">
            ${isClosed ? 
              '<button onclick="reopenOrder(\'' + o['תעודה'] + '\')" class="text-green-600 hover:text-green-800 tooltip mr-2">' +
                '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">' +
                  '<path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />' +
                '</svg>' +
                '<span class="tooltip-text">פתח מחדש</span>' +
              '</button>' :
              '<button onclick="editOrder(\'' + o['תעודה'] + '\')" class="text-blue-600 hover:text-blue-800 tooltip mr-2">' +
                '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">' +
                  '<path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />' +
                '</svg>' +
                '<span class="tooltip-text">ערוך הזמנה</span>' +
              '</button>' +
              '<button onclick="closeOrder(\'' + o['תעודה'] + '\')" class="text-red-600 hover:text-red-800 tooltip">' +
                '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">' +
                  '<path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />' +
                '</svg>' +
                '<span class="tooltip-text">סגור הזמנה</span>' +
              '</button>'
            }
          </td>
        `;
        
        tbody.appendChild(tr);
      });
    }

    // Update metrics cards
    function updateMetrics(orders) {
      const totalOpen = orders.length;
      const overdue = orders.filter(o => parseInt(o['ימים שעברו'] || 0) > 10).length;
      
      const today = new Date().toLocaleDateString('he-IL');
      const todayActions = orders.filter(o => o['סוג פעולה'] === 'איסוף' && o['מתאריך'] === today).length;
      
      const avgDays = orders.length ? 
        (orders.reduce((sum, o) => sum + parseInt(o['ימים שעברו'] || 0), 0) / orders.length).toFixed(1) : 
        '0.0';

      document.getElementById('totalOpen').textContent = totalOpen.toLocaleString();
      document.getElementById('overdue').textContent = overdue.toLocaleString();
      document.getElementById('todayActions').textContent = todayActions.toLocaleString();
      document.getElementById('avgDays').textContent = avgDays;
    }

    // Update charts
    function updateCharts(orders) {
      renderActionChart(orders);
      renderDaysChart(orders);
    }

    // Render action distribution chart
    function renderActionChart(orders) {
      const ctx = document.getElementById('actionChart').getContext('2d');
      const counts = {};
      const overdueOrders = {};
      
      // Count actions and overdue orders per action type
      orders.forEach(o => { 
        const actionType = o['סוג פעולה'] || 'לא מוגדר';
        counts[actionType] = (counts[actionType] || 0) + 1;
        
        // Check if order is overdue
        if (parseInt(o['ימים שעברו'] || 0) > 10) {
          overdueOrders[actionType] = (overdueOrders[actionType] || 0) + 1;
        }
      });
      
      const backgroundColors = generateColors(Object.keys(counts).length, 0.7);
      const borderColors = generateColors(Object.keys(counts).length, 1);

      if (actionChartInstance) actionChartInstance.destroy();
      
      actionChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(counts),
          datasets: [
            {
              label: 'מספר הזמנות',
              data: Object.values(counts),
              backgroundColor: backgroundColors,
              borderColor: borderColors,
              borderWidth: 1
            },
            {
              label: 'הזמנות חריגות',
              data: Object.keys(counts).map(action => overdueOrders[action] || 0),
              backgroundColor: 'rgba(239, 68, 68, 0.7)',
              borderColor: 'rgba(239, 68, 68, 1)',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'top',
              rtl: true
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.dataset.label || '';
                  const value = context.raw || 0;
                  const total = context.chart.data.datasets[0].data[context.dataIndex];
                  let tooltip = `${label}: ${value}`;
                  
                  if (context.datasetIndex === 1) {
                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                    tooltip += ` (${percentage}%)`;
                  }
                  
                  return tooltip;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0
              }
            }
          }
        }
      });
    }

    // Render days passed histogram
    function renderDaysChart(orders) {
      const ctx = document.getElementById('daysChart').getContext('2d');
      const daysData = orders.map(o => parseInt(o['ימים שעברו'] || 0)).sort((a, b) => a - b);
      
      // Group days into bins for better visualization
      const binSize = 5;
      const maxDays = Math.max(...daysData, 10);
      const bins = Math.ceil(maxDays / binSize);
      
      const labels = Array.from({ length: bins }, (_, i) => {
        const from = i * binSize;
        const to = (i + 1) * binSize;
        return `${from}-${to}`;
      });
      
      const data = Array(bins).fill(0);
      daysData.forEach(days => {
        const binIndex = Math.min(Math.floor(days / binSize), bins - 1);
        data[binIndex]++;
      });
      
      // Find overdue orders for highlighting
      const overdueIndex = Math.floor(10 / binSize);
      
      if (daysChartInstance) daysChartInstance.destroy();
      
      daysChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'מספר הזמנות',
            data: data,
            backgroundColor: labels.map((_, i) => 
              i >= overdueIndex ? 'rgba(239, 68, 68, 0.7)' : 'rgba(249, 115, 22, 0.7)'
            ),
            borderColor: labels.map((_, i) => 
              i >= overdueIndex ? 'rgba(239, 68, 68, 1)' : 'rgba(249, 115, 22, 1)'
            ),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'top',
              rtl: true
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `${context.dataset.label}: ${context.raw}`;
                },
                afterLabel: function(context) {
                  if (context.dataIndex >= overdueIndex) {
                    return 'הזמנות חריגות';
                  }
                }
              }
            },
            annotation: {
              annotations: {
                line1: {
                  type: 'line',
                  yMin: 0,
                  yMax: Math.max(...data),
                  xMin: overdueIndex - 0.5,
                  xMax: overdueIndex - 0.5,
                  borderColor: 'rgb(255, 0, 0)',
                  borderWidth: 2,
                  borderDash: [6, 6],
                  label: {
                    content: 'חריגה',
                    enabled: true,
                    position: 'top'
                  }
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0
              }
            }
          }
        }
      });
    }

    // Check for overdue orders and show alert
    function checkOverdueOrders(orders) {
      const overdueOrders = orders.filter(o => 
        !o['סגורה'] && parseInt(o['ימים שעברו'] || 0) > 10
      );
      
      if (overdueOrders.length > 0) {
        const alertBanner = document.getElementById('overdueAlert');
        alertBanner.className = 'alert-banner bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6';
        alertBanner.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="flex items-center">
              <svg class="h-5 w-5 text-red-500 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
              </svg>
              <p class="font-bold">התראה: ${overdueOrders.length} הזמנות חריגות (יותר מ-10 ימים)</p>
            </div>
            <button onclick="document.getElementById('overdueAlert').classList.add('hidden')" class="text-red-700 hover:text-red-900">
              <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
              </svg>
            </button>
          </div>
          <div class="mt-2">
            <p>מספרי הזמנות חריגות: ${overdueOrders.map(o => o['תעודה']).join(', ')}</p>
          </div>
        `;
        alertBanner.classList.remove('hidden');
      }
    }

    // Generate random colors for charts
    function generateColors(count, opacity) {
      const colors = [];
      const hueStep = 360 / count;
      
      for (let i = 0; i < count; i++) {
        const hue = i * hueStep;
        colors.push(`hsla(${hue}, 70%, 60%, ${opacity})`);
      }
      
      return colors;
    }

    // Show error message
    function showError(message) {
      const tbody = document.querySelector('#ordersTable tbody');
      tbody.innerHTML = `<tr><td colspan="10" class="px-6 py-4 text-center text-red-600">${message}</td></tr>`;
      
      // Reset metrics
      document.getElementById('totalOpen').textContent = '0';
      document.getElementById('overdue').textContent = '0';
      document.getElementById('todayActions').textContent = '0';
      document.getElementById('avgDays').textContent = '0.0';
      
      // Clear charts if they exist
      if (actionChartInstance) {
        actionChartInstance.destroy();
        actionChartInstance = null;
      }
      if (daysChartInstance) {
        daysChartInstance.destroy();
        daysChartInstance = null;
      }
    }

    // Close an order
    async function closeOrder(orderId) {
      if (!confirm('האם אתה בטוח שברצונך לסגור הזמנה זו?')) return;
      
      try {
        const res = await fetch(`${SCRIPT_URL}?action=close&id=${orderId}`);
        const data = await res.json();
        
        if (data.success) {
          alert('ההזמנה נסגרה בהצלחה');
          fetchOrders(); // Refresh data
        } else {
          alert('שגיאה בסגירת ההזמנה: ' + (data.message || ''));
        }
      } catch (error) {
        alert('שגיאה בחיבור לשרת');
        console.error('Error closing order:', error);
      }
    }

    // Reopen a closed order
    async function reopenOrder(orderId) {
      if (!confirm('האם אתה בטוח שברצונך לפתוח מחדש הזמנה זו?')) return;
      
      try {
        const res = await fetch(`${SCRIPT_URL}?action=reopen&id=${orderId}`);
        const data = await res.json();
        
        if (data.success) {
          alert('ההזמנה נפתחה מחדש בהצלחה');
          fetchOrders(); // Refresh data
        } else {
          alert('שגיאה בפתיחת ההזמנה: ' + (data.message || ''));
        }
      } catch (error) {
        alert('שגיאה בחיבור לשרת');
        console.error('Error reopening order:', error);
      }
    }

    // Edit order function
    function editOrder(orderId) {
      // This would be replaced with actual edit functionality
      const order = allOrders.find(o => o['תעודה'] === orderId);
      if (order) {
        alert(`עריכת הזמנה ${orderId}\nלקוח: ${order['שם לקוח']}\nסוכן: ${order['שם סוכן']}\nסוג פעולה: ${order['סוג פעולה']}`);
      } else {
        alert(`הזמנה ${orderId} לא נמצאה`);
      }
    }

    // Expose functions to global scope for button clicks
    window.editOrder = editOrder;
    window.closeOrder = closeOrder;
    window.reopenOrder = reopenOrder;
  </script>
</body>
</html>

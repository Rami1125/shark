<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª CRM ××ª×§×“××ª ×œ× ×™×”×•×œ ×©×›×™×¨×•×ª ××›×•×œ×•×ª</title>
    
    <!-- Chosen Palette: Calm Neutral Harmony (Green, Blue, White) -->
    <!-- Application Structure Plan: The application retains the highly effective three-section structure: Dashboard, Container Inventory, and Treatment Board. Now with an added Reports section. This structure provides a clear user flow, starting with a high-level overview (Dashboard), allowing for detailed asset management (Inventory), focusing on actionable items (Treatment Board), and offering analytical insights (Reports). The main interactions involve filtering the central data table from KPI cards and charts, managing orders through modals, and using a drag-and-drop Kanban board for workflow. This task-oriented design was chosen because it aligns perfectly with the typical workflow of a rental manager, prioritizing clarity, efficiency, and quick access to critical information. -->
    <!-- Visualization & Content Choices: 
        - Dashboard KPIs: Goal: Inform. Method: Styled HTML cards. Interaction: Click to filter main table. Justification: Provides a quick, scannable summary of key business metrics.
        - Charts: Goal: Compare/Show Proportions/Trend. Method: Bar/Doughnut Charts (Chart.js on Canvas). Interaction: Click to filter table. Justification: Effective for visualizing distributions and trends.
        - Main Table: Goal: Detail. Method: Dynamic HTML table. Interaction: Search/Filter/Sort. Justification: The central hub for all detailed order information.
        - Kanban Board: Goal: Manage workflow. Method: Drag-and-drop HTML/JS. Interaction: Drag cards between columns. Justification: Visually intuitive for tracking order statuses.
        - Modals: Goal: Edit/Add data. Method: HTML/JS pop-ups. Interaction: Form submission. Justification: Keeps the main interface clean while allowing for complex data entry.
        - The overall design prioritizes user experience by providing clear, distinct areas for different tasks, reducing cognitive load and improving efficiency. -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700&display=swap');
        :root {
            --primary-green: #4CAF50;
            --secondary-blue: #2196F3;
            --background-light: #F4F6F9;
            --surface-white: #FFFFFF;
            --text-dark: #333333;
            --text-light: #F4F6F9;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --border-radius: 12px;
            --transition-speed: 0.3s;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Heebo', sans-serif;
            background-color: var(--background-light);
            color: var(--text-dark);
            line-height: 1.6;
            direction: rtl;
            text-align: right;
            padding: 2rem;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        header {
            text-align: center;
            padding: 1.5rem 0;
            background: linear-gradient(135deg, var(--primary-green), #66BB6A);
            color: var(--text-light);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }
        
        header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }
        
        header p {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        .tab-navigation {
            display: flex;
            justify-content: center;
            background-color: var(--surface-white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 0.5rem;
            gap: 0.5rem;
        }
        .tab-navigation button {
            background-color: transparent;
            border: none;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            color: #888;
            transition: color var(--transition-speed), background-color var(--transition-speed);
            border-radius: var(--border-radius);
        }
        .tab-navigation button.active,
        .tab-navigation button:hover {
            background-color: var(--secondary-blue);
            color: var(--text-light);
        }
        
        .tab-content {
            display: none;
            background-color: var(--surface-white);
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }
        .tab-content.active {
            display: block;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .kpi-card {
            background-color: var(--background-light);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            text-align: center;
            cursor: pointer;
            transition: transform var(--transition-speed), box-shadow var(--transition-speed);
        }
        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }
        .kpi-card h3 {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            color: var(--secondary-blue);
        }
        .kpi-card .value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-green);
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .chart-card {
            background-color: var(--background-light);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .data-table-section {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .data-table-section h2 {
            font-size: 1.5rem;
            color: var(--secondary-blue);
            border-bottom: 2px solid var(--primary-green);
            padding-bottom: 0.5rem;
        }
        
        .table-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .search-container {
            position: relative;
            flex-grow: 1;
        }
        .search-container input {
            width: 100%;
            padding: 0.75rem 1rem;
            padding-right: 3rem;
            border-radius: var(--border-radius);
            border: 1px solid #ccc;
        }
        .search-container .search-icon {
            position: absolute;
            top: 50%;
            right: 1rem;
            transform: translateY(-50%);
            color: #888;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius);
            border: none;
            cursor: pointer;
            font-weight: 700;
            transition: transform var(--transition-speed);
        }
        .btn-primary {
            background-color: var(--primary-green);
            color: var(--text-light);
        }
        .btn-secondary {
            background-color: var(--secondary-blue);
            color: var(--text-light);
        }
        .btn-danger {
            background-color: #FF5252;
            color: var(--text-light);
        }
        .btn-refresh {
            background-color: #FFC107;
            color: var(--text-dark);
        }
        .btn-primary:hover, .btn-secondary:hover, .btn-danger:hover, .btn-refresh:hover {
            transform: translateY(-2px);
        }
        
        .table-responsive {
            overflow-x: auto;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .data-table th, .data-table td {
            text-align: right;
            padding: 1rem;
            border: 1px solid #ddd;
        }
        .data-table th {
            background-color: var(--secondary-blue);
            color: var(--text-light);
            cursor: pointer;
            white-space: nowrap;
        }
        .data-table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .data-table tbody tr:hover {
            background-color: #f1f1f1;
        }
        .data-table .actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: var(--surface-white);
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 600px;
            position: relative;
        }
        .close-btn {
            color: #aaa;
            float: left;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-btn:hover, .close-btn:focus {
            color: #000;
        }
        .modal-content h2 {
            border-bottom: 2px solid var(--primary-green);
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }
        .modal-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .modal-form label {
            display: flex;
            flex-direction: column;
            font-weight: bold;
            gap: 0.5rem;
        }
        .modal-form input, .modal-form select, .modal-form textarea {
            padding: 0.75rem;
            border: 1px solid #ccc;
            border-radius: var(--border-radius);
            font-size: 1rem;
        }
        .modal-form button {
            margin-top: 1rem;
        }

        .treatment-board {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            align-items: start;
        }
        .kanban-column {
            background-color: #eee;
            border-radius: var(--border-radius);
            padding: 1rem;
            min-height: 400px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .kanban-column h3 {
            text-align: center;
            color: var(--text-dark);
            margin-bottom: 1rem;
        }
        .kanban-card {
            background-color: var(--surface-white);
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            cursor: grab;
            transition: transform var(--transition-speed);
        }
        .kanban-card:active {
            cursor: grabbing;
        }
        .kanban-card p {
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        .kanban-card .customer-name {
            font-weight: bold;
            color: var(--secondary-blue);
        }

        .reports-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .report-form {
            background-color: var(--background-light);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .report-form h3 {
            font-size: 1.25rem;
            color: var(--secondary-blue);
            margin-bottom: 1rem;
        }
        .report-form .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .report-form label {
            font-weight: bold;
        }
        .report-form input, .report-form select {
            padding: 0.75rem;
            border-radius: var(--border-radius);
            border: 1px solid #ccc;
        }

        .alert-container {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 200;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            align-items: center;
            width: 90%;
            max-width: 500px;
        }
        .alert {
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            color: var(--text-light);
            font-weight: bold;
            text-align: center;
            opacity: 0;
            transform: scale(0.9);
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            box-shadow: var(--shadow);
            min-width: 250px;
        }
        .alert.show {
            opacity: 1;
            transform: scale(1);
        }
        .alert.success {
            background-color: #4CAF50;
        }
        .alert.error {
            background-color: #F44336;
        }
        .alert.info {
            background-color: #2196F3;
        }

        .scroll-to-top-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 99;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            background-color: var(--primary-green);
            color: var(--text-light);
            border: none;
            border-radius: 50%;
            box-shadow: var(--shadow);
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            transform: scale(0.9);
        }
        .scroll-to-top-btn:hover {
            transform: scale(1);
        }
        
    </style>
</head>
<body>

    <div class="container">
        <!-- Main Header -->
        <header>
            <h1>××¢×¨×›×ª CRM ××ª×§×“××ª ×œ× ×™×”×•×œ ×©×›×™×¨×•×ª ××›×•×œ×•×ª</h1>
            <p>× ×™×”×•×œ ×™×¢×™×œ ×©×œ ×œ×§×•×—×•×ª, ×”×–×× ×•×ª ×•××œ××™</p>
        </header>

        <!-- Alert Container -->
        <div id="alert-container" class="alert-container"></div>
        
        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button id="dashboard-tab" class="tab-btn active">×œ×•×— ××—×•×•× ×™×</button>
            <button id="inventory-tab" class="tab-btn">××œ××™ ××›×•×œ×•×ª</button>
            <button id="kanban-tab" class="tab-btn">×œ×•×— ×˜×™×¤×•×œ ×‘×”×–×× ×•×ª</button>
            <button id="reports-tab" class="tab-btn">×“×•×—×•×ª ×•× ×™×ª×•×—</button>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard-content" class="tab-content active">
            <!-- KPIs -->
            <div class="dashboard-grid">
                <div class="kpi-card" data-filter="active_orders">
                    <h3>×”×–×× ×•×ª ×¤×¢×™×œ×•×ª</h3>
                    <div class="value" id="kpi-active-orders">0</div>
                </div>
                <div class="kpi-card" data-filter="upcoming_expirations">
                    <h3>×—×™×“×•×©×™× ×§×¨×•×‘×™× (30 ×™×•×)</h3>
                    <div class="value" id="kpi-upcoming-expirations">0</div>
                </div>
                <div class="kpi-card" data-filter="available_containers">
                    <h3>××›×•×œ×•×ª ×¤× ×•×™×•×ª ×‘××œ××™</h3>
                    <div class="value" id="kpi-available-containers">0</div>
                </div>
                <div class="kpi-card" data-filter="total_revenue">
                    <h3>×”×›× ×¡×•×ª ×—×•×“×© × ×•×›×—×™</h3>
                    <div class="value" id="kpi-monthly-revenue">â‚ª0</div>
                </div>
            </div>
            
            <!-- Charts -->
            <div class="charts-container">
                <div class="chart-card">
                    <h3>×”×ª×¤×œ×’×•×ª ××›×•×œ×•×ª ×œ×¤×™ ×¡×•×’</h3>
                    <canvas id="container-type-chart"></canvas>
                </div>
                <div class="chart-card">
                    <h3>×”×–×× ×•×ª ×—×“×©×•×ª ×‘×—×•×“×©×™× ×”××—×¨×•× ×™×</h3>
                    <canvas id="monthly-orders-chart"></canvas>
                </div>
            </div>
            
            <!-- Data Table -->
            <div class="data-table-section">
                <h2>×˜×‘×œ×ª ×”×–×× ×•×ª</h2>
                <div class="table-controls">
                    <div class="search-container">
                        <input type="text" id="order-search" placeholder="×—×¤×© ×œ×¤×™ ×œ×§×•×—, ××›×•×œ×”, ×¢×™×¨...">
                        <span class="search-icon">ğŸ”</span>
                    </div>
                    <button class="btn btn-primary" id="new-order-btn">×”×–×× ×” ×—×“×©×”</button>
                </div>
                <div class="table-responsive">
                    <table id="orders-table" class="data-table">
                        <thead>
                            <tr>
                                <th data-sort="orderId">××¡' ×”×–×× ×”</th>
                                <th data-sort="customerName">×©× ×œ×§×•×—</th>
                                <th data-sort="containerId">××¡' ××›×•×œ×”</th>
                                <th data-sort="containerType">×¡×•×’</th>
                                <th data-sort="location">××™×§×•×</th>
                                <th data-sort="startDate">×ª××¨×™×š ×”×ª×—×œ×”</th>
                                <th data-sort="endDate">×ª××¨×™×š ×¡×™×•×</th>
                                <th data-sort="status">×¡×˜×˜×•×¡</th>
                                <th data-sort="monthlyPrice">××—×™×¨ ×—×•×“×©×™</th>
                                <th>×¤×¢×•×œ×•×ª</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be populated here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Container Inventory Section -->
        <div id="inventory-content" class="tab-content">
            <div class="data-table-section">
                <h2>××œ××™ ××›×•×œ×•×ª</h2>
                <div class="table-controls">
                    <div class="search-container">
                        <input type="text" id="container-search" placeholder="×—×¤×© ××›×•×œ×”...">
                        <span class="search-icon">ğŸ”</span>
                    </div>
                    <button class="btn btn-primary" id="new-container-btn">××›×•×œ×” ×—×“×©×”</button>
                </div>
                <div class="table-responsive">
                    <table id="containers-table" class="data-table">
                        <thead>
                            <tr>
                                <th data-sort="containerId">××¡' ××›×•×œ×”</th>
                                <th data-sort="containerType">×¡×•×’</th>
                                <th data-sort="status">×¡×˜×˜×•×¡</th>
                                <th data-sort="lastMaintenance">×ª×—×–×•×§×” ××—×¨×•× ×”</th>
                                <th>×¤×¢×•×œ×•×ª</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be populated here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Kanban Board Section -->
        <div id="kanban-content" class="tab-content">
            <h2>×œ×•×— ×˜×™×¤×•×œ ×‘×”×–×× ×•×ª</h2>
            <p style="margin-bottom: 1rem; color: #666;">×’×¨×•×¨ ×›×¨×˜×™×¡×™× ×‘×™×Ÿ ×”×¢××•×“×•×ª ×›×“×™ ×œ×©× ×•×ª ××ª ×¡×˜×˜×•×¡ ×”×”×–×× ×”.</p>
            <div class="treatment-board" id="kanban-board">
                <div class="kanban-column" id="pending-column">
                    <h3>×××ª×™×Ÿ ×œ×˜×™×¤×•×œ</h3>
                    <!-- Kanban cards will be populated here -->
                </div>
                <div class="kanban-column" id="in-progress-column">
                    <h3>×‘×ª×”×œ×™×š</h3>
                    <!-- Kanban cards will be populated here -->
                </div>
                <div class="kanban-column" id="completed-column">
                    <h3>×”×•×©×œ×</h3>
                    <!-- Kanban cards will be populated here -->
                </div>
            </div>
        </div>

        <!-- Reports Section -->
        <div id="reports-content" class="tab-content">
            <h2>×“×•×—×•×ª ×•× ×™×ª×•×— × ×ª×•× ×™×</h2>
            <div class="reports-container">
                <div class="report-form">
                    <h3>×©×œ×™×—×ª ×“×•×— ×¤×¢×™×œ×•×ª</h3>
                    <div class="form-group">
                        <label for="report-email">×›×ª×•×‘×ª ××™×™×œ:</label>
                        <input type="email" id="report-email" placeholder="×”×›× ×¡ ××™×™×œ">
                    </div>
                    <div class="form-group">
                        <label for="report-start-date">××ª××¨×™×š:</label>
                        <input type="date" id="report-start-date">
                    </div>
                    <div class="form-group">
                        <label for="report-end-date">×¢×“ ×ª××¨×™×š:</label>
                        <input type="date" id="report-end-date">
                    </div>
                    <button class="btn btn-primary" id="send-report-btn">×©×œ×— ×“×•×— ×œ××™×™×œ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for New/Edit Order -->
    <div id="order-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2 id="order-modal-title">×”×–×× ×” ×—×“×©×”</h2>
            <form id="order-form" class="modal-form">
                <input type="hidden" id="order-id">
                <label for="customerName">×©× ×œ×§×•×—:</label>
                <input type="text" id="customerName" required>
                <label for="containerId">××¡×¤×¨ ××›×•×œ×”:</label>
                <input type="text" id="containerId" required>
                <label for="containerType">×¡×•×’ ××›×•×œ×”:</label>
                <select id="containerType" required>
                    <option value="">×‘×—×¨ ×¡×•×’...</option>
                    <option value="20ft">20ft</option>
                    <option value="40ft">40ft</option>
                    <option value="40ft-HC">40ft-HC</option>
                    <option value="Reefer">Reefer</option>
                </select>
                <label for="location">××™×§×•×:</label>
                <input type="text" id="location" required>
                <label for="startDate">×ª××¨×™×š ×”×ª×—×œ×”:</label>
                <input type="date" id="startDate" required>
                <label for="endDate">×ª××¨×™×š ×¡×™×•×:</label>
                <input type="date" id="endDate" required>
                <label for="status">×¡×˜×˜×•×¡:</label>
                <select id="status" required>
                    <option value="×¤×¢×™×œ">×¤×¢×™×œ</option>
                    <option value="×”×•×©×œ×">×”×•×©×œ×</option>
                    <option value="×‘×”××ª× ×”">×‘×”××ª× ×”</option>
                </select>
                <label for="monthlyPrice">××—×™×¨ ×—×•×“×©×™ (â‚ª):</label>
                <input type="number" id="monthlyPrice" required>
                <button type="submit" class="btn btn-primary">×©××•×¨ ×”×–×× ×”</button>
            </form>
        </div>
    </div>

    <!-- Modal for New/Edit Container -->
    <div id="container-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2 id="container-modal-title">××›×•×œ×” ×—×“×©×”</h2>
            <form id="container-form" class="modal-form">
                <input type="hidden" id="container-id">
                <label for="newContainerId">××¡×¤×¨ ××›×•×œ×”:</label>
                <input type="text" id="newContainerId" required>
                <label for="newContainerType">×¡×•×’ ××›×•×œ×”:</label>
                <select id="newContainerType" required>
                    <option value="">×‘×—×¨ ×¡×•×’...</option>
                    <option value="20ft">20ft</option>
                    <option value="40ft">40ft</option>
                    <option value="40ft-HC">40ft-HC</option>
                    <option value="Reefer">Reefer</option>
                </select>
                <label for="containerStatus">×¡×˜×˜×•×¡:</label>
                <select id="containerStatus" required>
                    <option value="×¤× ×•×™">×¤× ×•×™</option>
                    <option value="××•×©×›×¨">××•×©×›×¨</option>
                    <option value="×‘×ª×—×–×•×§×”">×‘×ª×—×–×•×§×”</option>
                </select>
                <label for="lastMaintenance">×ª××¨×™×š ×ª×—×–×•×§×” ××—×¨×•× ×”:</label>
                <input type="date" id="lastMaintenance">
                <button type="submit" class="btn btn-primary">×©××•×¨ ××›×•×œ×”</button>
            </form>
        </div>
    </div>

    <!-- Scroll to Top Button -->
    <button onclick="scrollToTop()" id="scroll-to-top-btn" class="scroll-to-top-btn" title="×—×–×•×¨ ×œ××¢×œ×”">â†‘</button>

    <!-- Chart.js and other external scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Main Application Logic -->
    <script>
        // --- Global State and Constants ---
        let orders = [];
        let containers = [];
        let activeFilter = 'all';
        let sortDirection = {};
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzzT62T1VlqMh-9W9eF6x-y2cKx-1w-2w-2w-2w-2w/exec'; // Example URL. Replace with your actual Google Apps Script URL.
        const DRAG_TYPE = 'text/plain';

        // --- DOM Elements ---
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        const ordersTableBody = document.querySelector('#orders-table tbody');
        const containersTableBody = document.querySelector('#containers-table tbody');
        const orderSearchInput = document.getElementById('order-search');
        const containerSearchInput = document.getElementById('container-search');
        const orderModal = document.getElementById('order-modal');
        const containerModal = document.getElementById('container-modal');
        const orderForm = document.getElementById('order-form');
        const containerForm = document.getElementById('container-form');
        const newOrderBtn = document.getElementById('new-order-btn');
        const newContainerBtn = document.getElementById('new-container-btn');
        const sendReportBtn = document.getElementById('send-report-btn');
        const kanbanBoard = document.getElementById('kanban-board');
        const kanbanColumns = document.querySelectorAll('.kanban-column');
        const alertContainer = document.getElementById('alert-container');
        const scrollToTopBtn = document.getElementById('scroll-to-top-btn');

        // --- API & Data Handling Functions ---
        /**
         * Fetches data from a given API endpoint.
         * @param {string} endpoint The endpoint action to call.
         */
        async function fetchData(endpoint) {
            try {
                // Ensure SCRIPT_URL is defined before making the fetch call
                if (!SCRIPT_URL) {
                    throw new Error("SCRIPT_URL is not defined.");
                }

                const response = await fetch(`${SCRIPT_URL}?action=${endpoint}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                if (data.success) {
                    return data.data;
                } else {
                    showAlert(data.message || `×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™× ×-${endpoint}`, 'error');
                    console.error('API Error:', data.message);
                    return [];
                }
            } catch (error) {
                showAlert(`×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×: ${error.message}`, 'error');
                console.error('Fetch error:', error);
                return [];
            }
        }

        /**
         * Refreshes all application data by fetching from the API.
         */
        async function refreshData() {
            showAlert('××¨×¢× ×Ÿ × ×ª×•× ×™×...', 'info');
            
            // Fetch both orders and containers concurrently
            const [ordersData, containersData] = await Promise.all([
                fetchData('getOrders'),
                fetchData('getContainers')
            ]);
            
            orders = ordersData;
            containers = containersData;
            
            // Render the data
            renderOrdersTable(orders);
            renderContainersTable(containers);
            updateKPIs();
            updateCharts();
            renderKanbanBoard();

            showAlert('×”× ×ª×•× ×™× ×¢×•×“×›× ×• ×‘×”×¦×œ×—×”!', 'success');
        }

        /**
         * Sends data to the API for adding or updating an order.
         * @param {object} orderData The order data to save.
         */
        async function saveOrder(orderData) {
            const isUpdate = orderData.orderId;
            const action = isUpdate ? 'updateOrder' : 'addOrder';
            
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: action, data: orderData })
                });
                const data = await response.json();
                
                if (data.success) {
                    showAlert(`×”×”×–×× ×” × ×©××¨×” ×‘×”×¦×œ×—×”.`, 'success');
                    await refreshData();
                } else {
                    showAlert(`×©×’×™××” ×‘×©××™×¨×ª ×”×”×–×× ×”: ${data.message}`, 'error');
                }
            } catch (error) {
                showAlert(`×©×’×™××” ×‘×©××™×¨×ª ×”×”×–×× ×”: ${error.message}`, 'error');
                console.error('Save Order Error:', error);
            }
        }

        /**
         * Sends data to the API for adding or updating a container.
         * @param {object} containerData The container data to save.
         */
        async function saveContainer(containerData) {
            const isUpdate = !!containerData.containerId;
            const action = isUpdate ? 'updateContainer' : 'addContainer';
            
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: action, data: containerData })
                });
                const data = await response.json();
                
                if (data.success) {
                    showAlert('×”××›×•×œ×” × ×©××¨×” ×‘×”×¦×œ×—×”!', 'success');
                    await refreshData();
                } else {
                    showAlert(`×©×’×™××” ×‘×©××™×¨×ª ×”××›×•×œ×”: ${data.message}`, 'error');
                }
            } catch (error) {
                showAlert(`×©×’×™××” ×‘×©××™×¨×ª ×”××›×•×œ×”: ${error.message}`, 'error');
                console.error('Save Container Error:', error);
            }
        }

        /**
         * Deletes an order from the API.
         * @param {string} orderId The ID of the order to delete.
         */
        async function deleteOrder(orderId) {
            if (!confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×–×× ×” ××¡×¤×¨ ${orderId}?`)) {
                return;
            }
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'deleteOrder', data: { orderId } })
                });
                const data = await response.json();
                
                if (data.success) {
                    showAlert('×”×”×–×× ×” × ××—×§×” ×‘×”×¦×œ×—×”!', 'success');
                    await refreshData();
                } else {
                    showAlert(`×©×’×™××” ×‘××—×™×§×ª ×”×”×–×× ×”: ${data.message}`, 'error');
                }
            } catch (error) {
                showAlert(`×©×’×™××” ×‘××—×™×§×ª ×”×”×–×× ×”: ${error.message}`, 'error');
                console.error('Delete Order Error:', error);
            }
        }

        /**
         * Deletes a container from the API.
         * @param {string} containerId The ID of the container to delete.
         */
        async function deleteContainer(containerId) {
            if (!confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ××›×•×œ×” ××¡×¤×¨ ${containerId}?`)) {
                return;
            }
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'deleteContainer', data: { containerId } })
                });
                const data = await response.json();
                
                if (data.success) {
                    showAlert('×”××›×•×œ×” × ××—×§×” ×‘×”×¦×œ×—×”!', 'success');
                    await refreshData();
                } else {
                    showAlert(`×©×’×™××” ×‘××—×™×§×ª ×”××›×•×œ×”: ${data.message}`, 'error');
                }
            } catch (error) {
                showAlert(`×©×’×™××” ×‘××—×™×§×ª ×”××›×•×œ×”: ${error.message}`, 'error');
                console.error('Delete Container Error:', error);
            }
        }

        // --- UI Rendering Functions ---

        /**
         * Renders the orders data into the main table.
         * @param {Array} data The orders array to render.
         */
        function renderOrdersTable(data) {
            ordersTableBody.innerHTML = '';
            const filteredData = data.filter(order => {
                if (activeFilter === 'active_orders') {
                    return order.status === '×¤×¢×™×œ';
                }
                if (activeFilter === 'upcoming_expirations') {
                    const endDate = new Date(order.endDate);
                    const now = new Date();
                    const diffDays = Math.ceil((endDate - now) / (1000 * 60 * 60 * 24));
                    return order.status === '×¤×¢×™×œ' && diffDays > 0 && diffDays <= 30;
                }
                if (activeFilter === 'available_containers') {
                    // This filter is for containers, not orders, so we will show all orders
                    return true;
                }
                return true;
            });

            filteredData.forEach(order => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${order.orderId}</td>
                    <td>${order.customerName}</td>
                    <td>${order.containerId}</td>
                    <td>${order.containerType}</td>
                    <td>${order.location}</td>
                    <td>${formatDate(order.startDate)}</td>
                    <td>${formatDate(order.endDate)}</td>
                    <td>${order.status}</td>
                    <td>â‚ª${order.monthlyPrice.toLocaleString()}</td>
                    <td class="actions">
                        <button class="btn btn-secondary btn-sm" onclick="openOrderModal('${order.orderId}')">×¢×¨×•×š</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteOrder('${order.orderId}')">××—×§</button>
                    </td>
                `;
                ordersTableBody.appendChild(row);
            });
        }
        
        /**
         * Renders the containers data into the inventory table.
         * @param {Array} data The containers array to render.
         */
        function renderContainersTable(data) {
            containersTableBody.innerHTML = '';
            const filteredData = data.filter(container => {
                if (activeFilter === 'available_containers') {
                    return container.status === '×¤× ×•×™';
                }
                return true;
            });

            filteredData.forEach(container => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${container.containerId}</td>
                    <td>${container.containerType}</td>
                    <td>${container.status}</td>
                    <td>${container.lastMaintenance ? formatDate(container.lastMaintenance) : '××™×Ÿ × ×ª×•× ×™×'}</td>
                    <td class="actions">
                        <button class="btn btn-secondary btn-sm" onclick="openContainerModal('${container.containerId}')">×¢×¨×•×š</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteContainer('${container.containerId}')">××—×§</button>
                    </td>
                `;
                containersTableBody.appendChild(row);
            });
        }

        /**
         * Renders the kanban board with filtered order data.
         */
        function renderKanbanBoard() {
            // Clear existing cards
            document.getElementById('pending-column').innerHTML = '<h3>×××ª×™×Ÿ ×œ×˜×™×¤×•×œ</h3>';
            document.getElementById('in-progress-column').innerHTML = '<h3>×‘×ª×”×œ×™×š</h3>';
            document.getElementById('completed-column').innerHTML = '<h3>×”×•×©×œ×</h3>';

            orders.forEach(order => {
                const card = document.createElement('div');
                card.className = 'kanban-card';
                card.draggable = true;
                card.dataset.orderId = order.orderId;
                card.innerHTML = `
                    <p><strong>×œ×§×•×—:</strong> <span class="customer-name">${order.customerName}</span></p>
                    <p><strong>××›×•×œ×”:</strong> ${order.containerId}</p>
                    <p><strong>×ª××¨×™×š ×¡×™×•×:</strong> ${formatDate(order.endDate)}</p>
                `;

                if (order.status === '×‘×”××ª× ×”') {
                    document.getElementById('pending-column').appendChild(card);
                } else if (order.status === '×‘×ª×”×œ×™×š') {
                    document.getElementById('in-progress-column').appendChild(card);
                } else if (order.status === '×”×•×©×œ×') {
                    document.getElementById('completed-column').appendChild(card);
                }
            });
        }

        // --- Chart Functions ---
        let typeChartInstance, monthlyChartInstance;

        /**
         * Initializes and updates the charts.
         */
        function updateCharts() {
            const types = orders.map(o => o.containerType);
            const typeCounts = types.reduce((acc, type) => {
                acc[type] = (acc[type] || 0) + 1;
                return acc;
            }, {});

            if (typeChartInstance) {
                typeChartInstance.destroy();
            }
            const typeCtx = document.getElementById('container-type-chart').getContext('2d');
            typeChartInstance = new Chart(typeCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(typeCounts),
                    datasets: [{
                        label: '××¡×¤×¨ ××›×•×œ×•×ª',
                        data: Object.values(typeCounts),
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'
                        ],
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: '×”×ª×¤×œ×’×•×ª ××›×•×œ×•×ª ×œ×¤×™ ×¡×•×’' }
                    }
                }
            });

            // Monthly Orders Chart
            const monthlyOrders = {};
            orders.forEach(order => {
                const date = new Date(order.startDate);
                const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                monthlyOrders[monthYear] = (monthlyOrders[monthYear] || 0) + 1;
            });

            const sortedMonths = Object.keys(monthlyOrders).sort();
            const monthlyData = sortedMonths.map(month => monthlyOrders[month]);

            if (monthlyChartInstance) {
                monthlyChartInstance.destroy();
            }
            const monthlyCtx = document.getElementById('monthly-orders-chart').getContext('2d');
            monthlyChartInstance = new Chart(monthlyCtx, {
                type: 'bar',
                data: {
                    labels: sortedMonths,
                    datasets: [{
                        label: '××¡×¤×¨ ×”×–×× ×•×ª',
                        data: monthlyData,
                        backgroundColor: '#4BC0C0',
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    },
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: '×”×–×× ×•×ª ×—×“×©×•×ª ×‘×—×•×“×©×™× ×”××—×¨×•× ×™×' }
                    }
                }
            });
        }
        
        // --- KPI Functions ---
        function updateKPIs() {
            const activeOrders = orders.filter(o => o.status === '×¤×¢×™×œ').length;
            const now = new Date();
            const upcomingExpirations = orders.filter(o => {
                const endDate = new Date(o.endDate);
                const diffDays = Math.ceil((endDate - now) / (1000 * 60 * 60 * 24));
                return o.status === '×¤×¢×™×œ' && diffDays > 0 && diffDays <= 30;
            }).length;
            const availableContainers = containers.filter(c => c.status === '×¤× ×•×™').length;
            const currentMonthRevenue = orders.reduce((total, order) => {
                const startDate = new Date(order.startDate);
                if (order.status === '×¤×¢×™×œ' && startDate.getFullYear() === now.getFullYear() && startDate.getMonth() === now.getMonth()) {
                    return total + order.monthlyPrice;
                }
                return total;
            }, 0);

            document.getElementById('kpi-active-orders').textContent = activeOrders;
            document.getElementById('kpi-upcoming-expirations').textContent = upcomingExpirations;
            document.getElementById('kpi-available-containers').textContent = availableContainers;
            document.getElementById('kpi-monthly-revenue').textContent = `â‚ª${currentMonthRevenue.toLocaleString()}`;
        }

        // --- Modal & Form Functions ---

        /**
         * Opens the order modal with a specific order's data for editing, or empty for a new order.
         * @param {string} orderId The ID of the order to edit, or null for a new order.
         */
        function openOrderModal(orderId = null) {
            const modalTitle = document.getElementById('order-modal-title');
            const orderIdInput = document.getElementById('order-id');
            orderForm.reset();
            
            if (orderId) {
                const order = orders.find(o => o.orderId === orderId);
                if (order) {
                    modalTitle.textContent = '×¢×¨×•×š ×”×–×× ×”';
                    orderIdInput.value = order.orderId;
                    document.getElementById('customerName').value = order.customerName;
                    document.getElementById('containerId').value = order.containerId;
                    document.getElementById('containerType').value = order.containerType;
                    document.getElementById('location').value = order.location;
                    document.getElementById('startDate').value = order.startDate;
                    document.getElementById('endDate').value = order.endDate;
                    document.getElementById('status').value = order.status;
                    document.getElementById('monthlyPrice').value = order.monthlyPrice;
                }
            } else {
                modalTitle.textContent = '×”×–×× ×” ×—×“×©×”';
                orderIdInput.value = '';
            }
            orderModal.style.display = 'flex';
        }

        /**
         * Opens the container modal with a specific container's data for editing, or empty for a new container.
         * @param {string} containerId The ID of the container to edit, or null for a new container.
         */
        function openContainerModal(containerId = null) {
            const modalTitle = document.getElementById('container-modal-title');
            const containerIdInput = document.getElementById('container-id');
            containerForm.reset();
            
            if (containerId) {
                const container = containers.find(c => c.containerId === containerId);
                if (container) {
                    modalTitle.textContent = '×¢×¨×•×š ××›×•×œ×”';
                    containerIdInput.value = container.containerId;
                    document.getElementById('newContainerId').value = container.containerId;
                    document.getElementById('newContainerType').value = container.containerType;
                    document.getElementById('containerStatus').value = container.status;
                    document.getElementById('lastMaintenance').value = container.lastMaintenance;
                }
            } else {
                modalTitle.textContent = '××›×•×œ×” ×—×“×©×”';
                containerIdInput.value = '';
            }
            containerModal.style.display = 'flex';
        }
        
        /**
         * Closes a modal.
         * @param {HTMLElement} modal The modal element to close.
         */
        function closeModal(modal) {
            modal.style.display = 'none';
        }

        // --- Utility Functions ---

        /**
         * Formats a date string to a more readable format.
         * @param {string} dateString The date string to format.
         * @returns {string} The formatted date string.
         */
        function formatDate(dateString) {
            if (!dateString) return '';
            const options = { year: 'numeric', month: '2-digit', day: '2-digit' };
            return new Date(dateString).toLocaleDateString('he-IL', options);
        }

        /**
         * Displays a temporary alert message.
         * @param {string} message The message to display.
         * @param {string} type The type of alert ('success', 'error', 'info').
         */
        function showAlert(message, type) {
            // Check if alert container exists before trying to append child
            if (!alertContainer) {
                console.error("Alert container not found.");
                return;
            }
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.textContent = message;
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.classList.add('show');
            }, 10); // Small delay for CSS transition
            
            setTimeout(() => {
                alert.classList.remove('show');
                setTimeout(() => alert.remove(), 300); // Wait for transition before removing
            }, 3000);
        }

        /**
         * Sends an email report.
         */
        async function sendReportEmail() {
            const recipientEmail = document.getElementById('report-email').value;
            const startDate = document.getElementById('report-start-date').value;
            const endDate = document.getElementById('report-end-date').value;

            if (!recipientEmail) {
                showAlert('×™×© ×œ×”×–×™×Ÿ ×›×ª×•×‘×ª ××™×™×œ.', 'error');
                return;
            }
            showAlert('×©×•×œ×— ×“×•×—...', 'info');

            const filteredOrders = orders.filter(order => {
                const orderDate = new Date(order.startDate);
                const start = startDate ? new Date(startDate) : null;
                const end = endDate ? new Date(endDate) : new Date();
                return (!start || orderDate >= start) && (!end || orderDate <= end);
            });

            let emailBody = `×“×•×— ×¤×¢×™×œ×•×ª ××›×•×œ×•×ª ×œ×ª×§×•×¤×”: ${formatDate(startDate || '×”×ª×—×œ×”')} - ${formatDate(endDate || '×”×™×•×')}\n\n`;
            if (filteredOrders.length > 0) {
                emailBody += '×¤×™×¨×•×˜ ×”×–×× ×•×ª:\n';
                filteredOrders.forEach(order => {
                    emailBody += `- ×”×–×× ×” ${order.orderId}: ${order.customerName}, ××›×•×œ×” ${order.containerId} (${order.containerType}), ×¡×˜×˜×•×¡: ${order.status}\n`;
                });
            } else {
                emailBody += '×œ× × ××¦××• ×”×–×× ×•×ª ×‘×ª×§×•×¤×” ×–×•.';
            }

            try {
                // Ensure SCRIPT_URL is defined before making the fetch call
                if (!SCRIPT_URL) {
                    throw new Error("SCRIPT_URL is not defined.");
                }

                const EMAIL_SCRIPT_URL = SCRIPT_URL;
                const response = await fetch(`${EMAIL_SCRIPT_URL}?action=sendReportEmail&recipient=${encodeURIComponent(recipientEmail)}&subject=${encodeURIComponent(`×“×•×— ×¤×¢×™×œ×•×ª ××›×•×œ×•×ª: ${formatDate(startDate || '×”×ª×—×œ×”')} - ${formatDate(endDate || '×”×™×•×')}`)}&body=${encodeURIComponent(emailBody)}`);
                const data = await response.json();

                if (data.success) {
                    showAlert('×”×“×•×— × ×©×œ×— ×‘×”×¦×œ×—×” ×œ××™×™×œ!', 'success');
                } else {
                    showAlert(data.message || '×©×’×™××” ×‘×©×œ×™×—×ª ×”×“×•×—.', 'error');
                }
            } catch (error) {
                showAlert(`×©×’×™××” ×‘×©×œ×™×—×ª ×”×“×•×—: ${error.message}`, 'error');
                console.error('Email send error:', error);
            }
        }


        // --- Scroll to Top Functionality ---
        window.onscroll = function() {
            if (document.body.scrollTop > 100 || document.documentElement.scrollTop > 100) {
                scrollToTopBtn.style.display = "block";
                scrollToTopBtn.style.opacity = "1";
            } else {
                scrollToTopBtn.style.opacity = "0";
                setTimeout(() => { scrollToTopBtn.style.display = "none"; }, 300);
            }
        };

        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: "smooth"
            });
        }

        function scrollToOrdersTable() {
            document.getElementById('orders-table').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }


        // --- Event Listeners ---
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));
                
                button.classList.add('active');
                const targetTab = document.getElementById(button.id.replace('-tab', '-content'));
                if (targetTab) {
                    targetTab.classList.add('active');
                }
            });
        });

        document.getElementById('new-order-btn').addEventListener('click', () => openOrderModal());
        document.getElementById('new-container-btn').addEventListener('click', () => openContainerModal());
        document.getElementById('send-report-btn').addEventListener('click', sendReportEmail);
        
        document.querySelectorAll('.modal .close-btn').forEach(btn => {
            btn.addEventListener('click', (e) => closeModal(e.target.closest('.modal')));
        });
        window.addEventListener('click', (e) => {
            if (e.target === orderModal) closeModal(orderModal);
            if (e.target === containerModal) closeModal(containerModal);
        });

        orderForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const orderData = {
                orderId: document.getElementById('order-id').value || crypto.randomUUID(),
                customerName: document.getElementById('customerName').value,
                containerId: document.getElementById('containerId').value,
                containerType: document.getElementById('containerType').value,
                location: document.getElementById('location').value,
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                status: document.getElementById('status').value,
                monthlyPrice: parseFloat(document.getElementById('monthlyPrice').value)
            };
            await saveOrder(orderData);
            closeModal(orderModal);
        });

        containerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const containerData = {
                containerId: document.getElementById('newContainerId').value,
                containerType: document.getElementById('newContainerType').value,
                status: document.getElementById('containerStatus').value,
                lastMaintenance: document.getElementById('lastMaintenance').value
            };
            await saveContainer(containerData);
            closeModal(containerModal);
        });

        // Filter KPI cards
        document.querySelectorAll('.kpi-card').forEach(card => {
            card.addEventListener('click', () => {
                activeFilter = card.dataset.filter;
                renderOrdersTable(orders);
                renderContainersTable(containers);
                scrollToOrdersTable();
            });
        });
        
        // Sorting
        document.querySelectorAll('.data-table th').forEach(header => {
            header.addEventListener('click', () => {
                const sortBy = header.dataset.sort;
                if (!sortBy) return;

                const isOrdersTable = header.closest('table').id === 'orders-table';
                const data = isOrdersTable ? orders : containers;
                
                sortDirection[sortBy] = sortDirection[sortBy] === 'asc' ? 'desc' : 'asc';

                data.sort((a, b) => {
                    const valA = a[sortBy];
                    const valB = b[sortBy];
                    
                    if (typeof valA === 'string' && typeof valB === 'string') {
                        return sortDirection[sortBy] === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                    } else {
                        if (valA < valB) return sortDirection[sortBy] === 'asc' ? -1 : 1;
                        if (valA > valB) return sortDirection[sortBy] === 'asc' ? 1 : -1;
                        return 0;
                    }
                });
                
                if (isOrdersTable) {
                    renderOrdersTable(data);
                } else {
                    renderContainersTable(data);
                }
            });
        });
        
        // Search functionality
        orderSearchInput.addEventListener('input', () => {
            const searchTerm = orderSearchInput.value.toLowerCase();
            const filteredOrders = orders.filter(order =>
                Object.values(order).some(value =>
                    String(value).toLowerCase().includes(searchTerm)
                )
            );
            renderOrdersTable(filteredOrders);
        });
        containerSearchInput.addEventListener('input', () => {
            const searchTerm = containerSearchInput.value.toLowerCase();
            const filteredContainers = containers.filter(container =>
                Object.values(container).some(value =>
                    String(value).toLowerCase().includes(searchTerm)
                )
            );
            renderContainersTable(filteredContainers);
        });

        // Kanban Drag & Drop
        kanbanColumns.forEach(column => {
            column.addEventListener('dragover', (e) => {
                e.preventDefault();
                const afterElement = getDragAfterElement(column, e.clientY);
                const draggable = document.querySelector('.dragging');
                if (draggable) {
                    if (afterElement == null) {
                        column.appendChild(draggable);
                    } else {
                        column.insertBefore(draggable, afterElement);
                    }
                }
            });

            column.addEventListener('drop', (e) => {
                const draggable = document.querySelector('.dragging');
                if (draggable) {
                    draggable.classList.remove('dragging');
                    const orderId = draggable.dataset.orderId;
                    const newStatus = mapColumnIdToStatus(column.id);
                    
                    // Update the order status in the global state
                    const orderToUpdate = orders.find(o => o.orderId === orderId);
                    if (orderToUpdate && orderToUpdate.status !== newStatus) {
                        orderToUpdate.status = newStatus;
                        // Call saveOrder to persist the change to the API
                        saveOrder(orderToUpdate);
                    }
                }
            });
        });

        kanbanBoard.addEventListener('dragstart', (e) => {
            const target = e.target.closest('.kanban-card');
            if (target) {
                target.classList.add('dragging');
                e.dataTransfer.setData(DRAG_TYPE, target.dataset.orderId);
            }
        });

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.kanban-card:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
        
        function mapColumnIdToStatus(columnId) {
            switch (columnId) {
                case 'pending-column': return '×‘×”××ª× ×”';
                case 'in-progress-column': return '×‘×ª×”×œ×™×š';
                case 'completed-column': return '×”×•×©×œ×';
                default: return '';
            }
        }
        
        // Expose functions to the global scope for event handlers in HTML
        window.openOrderModal = openOrderModal;
        window.deleteOrder = deleteOrder;
        window.openContainerModal = openContainerModal;
        window.deleteContainer = deleteContainer;
        window.scrollToTop = scrollToTop;
        window.scrollToOrdersTable = scrollToOrdersTable;

        // --- Initial Application Load ---
        window.onload = () => {
            refreshData();
        };

    </script>
</body>
</html>

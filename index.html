<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <title>לוח בקרה לניהול מכולות</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; direction: rtl; padding: 20px; background: #f3f4f6; }
    h1 { text-align: center; }
    button { margin: 5px; padding: 10px 15px; cursor: pointer; }
    input, select { padding: 5px; margin: 5px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #eee; }
    .metrics { display: flex; flex-wrap: wrap; gap: 20px; margin-top: 20px; }
    .metric { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 0 5px #ccc; flex: 1; min-width: 150px; text-align: center; }
    canvas { background: #fff; margin-top: 20px; border-radius: 8px; padding: 10px; }
  </style>
</head>
<body>
  <h1>לוח בקרה לניהול מכולות</h1>

  <div>
    <button id="newOrderBtn">+ הזמנה חדשה</button>
    <button id="refreshBtn">רענן</button>
    <input type="text" id="searchInput" placeholder="הקלד לחיפוש...">
    <select id="actionFilter">
      <option value="">כל סוגי הפעולה</option>
    </select>
    <input type="number" id="daysMax" placeholder="ימים שעברו (מקסימום)">
  </div>

  <div class="metrics">
    <div class="metric">סה"כ פתוחות: <span id="totalOpen">0</span></div>
    <div class="metric">חריגות (&gt; 10 ימים): <span id="overdue">0</span></div>
    <div class="metric">פעולות איסוף היום: <span id="todayActions">0</span></div>
    <div class="metric">ממוצע ימים שעברו: <span id="avgDays">0.0</span></div>
  </div>

  <canvas id="actionChart" height="150"></canvas>
  <canvas id="daysChart" height="150"></canvas>

  <table id="ordersTable">
    <thead>
      <tr>
        <th>תעודה</th>
        <th>שם לקוח</th>
        <th>שם סוכן</th>
        <th>מתאריך</th>
        <th>סוג פעולה</th>
        <th>ימים שעברו</th>
        <th>מס" מכולה ירדה</th>
        <th>מס" מכולה עלתה</th>
        <th>ימים שעברו (עלתה)</th>
        <th>פעולות</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="10">לא נמצאו הזמנות תואמות.</td></tr>
    </tbody>
  </table>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx7E0OrpJc7Yq4xhFTj376xVMo9VfvhLAjDZ6zdt8QGzXvlzKkANZxn4cV5AfvDPQ0m/exec'; // החלף בכתובת ה-Web App של Code.gs
    let allOrders = [];

    document.getElementById('refreshBtn').addEventListener('click', fetchOrders);
    document.getElementById('searchInput').addEventListener('input', filterOrders);
    document.getElementById('actionFilter').addEventListener('change', filterOrders);

    async function fetchOrders() {
      const res = await fetch(`${SCRIPT_URL}?action=list`);
      const data = await res.json();
      if (data.success) {
        allOrders = data.data;
        populateActionFilter();
        updateDashboard(allOrders);
      } else {
        alert('שגיאה בשליפת נתונים');
      }
    }

    function populateActionFilter() {
      const select = document.getElementById('actionFilter');
      const actions = [...new Set(allOrders.map(o => o['סוג פעולה']).filter(a => a))];
      select.innerHTML = '<option value="">כל סוגי הפעולה</option>';
      actions.forEach(a => {
        const option = document.createElement('option');
        option.value = a;
        option.textContent = a;
        select.appendChild(option);
      });
    }

    function filterOrders() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const actionFilter = document.getElementById('actionFilter').value;
      const daysMax = parseInt(document.getElementById('daysMax').value) || Infinity;

      const filtered = allOrders.filter(o => {
        const matchesSearch = o['שם לקוח'].toLowerCase().includes(searchTerm) ||
                              o['שם סוכן'].toLowerCase().includes(searchTerm) ||
                              o['תעודה'].toLowerCase().includes(searchTerm);
        const matchesAction = actionFilter ? o['סוג פעולה'] === actionFilter : true;
        const matchesDays = parseInt(o['ימים שעברו']) <= daysMax;
        return matchesSearch && matchesAction && matchesDays;
      });

      updateDashboard(filtered);
    }

    function updateDashboard(orders) {
      // עדכון טבלה
      const tbody = document.querySelector('#ordersTable tbody');
      tbody.innerHTML = '';
      if (orders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10">לא נמצאו הזמנות תואמות.</td></tr>';
      } else {
        orders.forEach(o => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${o['תעודה']}</td>
            <td>${o['שם לקוח']}</td>
            <td>${o['שם סוכן']}</td>
            <td>${o['מתאריך']}</td>
            <td>${o['סוג פעולה']}</td>
            <td>${o['ימים שעברו']}</td>
            <td>${o['מס" מכולה ירדה']}</td>
            <td>${o['מס" מכולה עלתה']}</td>
            <td>${o['ימים שעברו (עלתה)']}</td>
            <td><button onclick="alert('עריכה עתידית')">ערוך</button></td>
          `;
          tbody.appendChild(tr);
        });
      }

      // עדכון מדדים
      const totalOpen = orders.length;
      const overdue = orders.filter(o => parseInt(o['ימים שעברו']) > 10).length;
      const today = orders.filter(o => o['סוג פעולה'] === 'איסוף' && o['מתאריך'] === new Date().toLocaleDateString('he-IL')).length;
      const avgDays = orders.length ? (orders.reduce((sum, o) => sum + parseInt(o['ימים שעברו']), 0)/orders.length).toFixed(1) : 0.0;

      document.getElementById('totalOpen').textContent = totalOpen;
      document.getElementById('overdue').textContent = overdue;
      document.getElementById('todayActions').textContent = today;
      document.getElementById('avgDays').textContent = avgDays;

      // גרפים
      renderActionChart(orders);
      renderDaysChart(orders);
    }

    function renderActionChart(orders) {
      const ctx = document.getElementById('actionChart').getContext('2d');
      const counts = {};
      orders.forEach(o => { counts[o['סוג פעולה']] = (counts[o['סוג פעולה']]||0)+1; });

      if(window.actionChartInstance) window.actionChartInstance.destroy();
      window.actionChartInstance = new Chart(ctx, {
        type: 'bar',
        data: { labels: Object.keys(counts), datasets: [{ label: 'התפלגות סוגי פעולה', data: Object.values(counts), backgroundColor: '#4f46e5' }] },
        options: { responsive: true }
      });
    }

    function renderDaysChart(orders) {
      const ctx = document.getElementById('daysChart').getContext('2d');
      const days = orders.map(o => parseInt(o['ימים שעברו'])).sort((a,b)=>a-b);
      if(window.daysChartInstance) window.daysChartInstance.destroy();
      window.daysChartInstance = new Chart(ctx, {
        type: 'bar',
        data: { labels: days, datasets: [{ label: 'היסטוגרמת ימים שעברו', data: days, backgroundColor: '#f97316' }] },
        options: { responsive: true }
      });
    }

    // אתחול
    fetchOrders();
  </script>
</body>
</html>

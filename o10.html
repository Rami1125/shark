<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>מכולות שוכבות — דף פנימי פרימיום</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
<style>
  :root{
    --glass: rgba(255,255,255,0.6);
    --accent: #6366f1; /* primary */
    --danger: #ef4444;
    --warn: #f59e0b;
    --success: #10b981;
    --muted: #6b7280;
  }
  body{background: linear-gradient(180deg,#f8fafc 0%,#eef2ff 100%);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
  .frost{backdrop-filter: blur(6px); background: linear-gradient(180deg, rgba(255,255,255,0.55), rgba(255,255,255,0.45));}
  .card{border-radius:16px; box-shadow: 0 10px 30px rgba(2,6,23,0.08);}
  .pulse-soft{animation: pulse 2s infinite;}
  @keyframes pulse{0%{transform:translateY(0)}50%{transform:translateY(-2px)}100%{transform:translateY(0)}}
  @keyframes blink-red {0%,100%{opacity:1}50%{opacity:0.5}}
  .blink-danger{animation: blink-red 1.6s infinite}
  /* typing effect */
  .typing { border-right: 2px solid rgba(0,0,0,0.12); white-space:nowrap; overflow:hidden}
  .emoji-badge{font-size:18px}
  /* responsive helpers */
  @media (max-width:640px){ .grid-cols-responsive{grid-template-columns: repeat(1, minmax(0,1fr));} }
</style>
</head>
<body class="p-4">
  <!-- Header: clickable logo + title + entry button -->
  <header class="max-w-6xl mx-auto mb-6 flex items-center gap-4">
    <button id="homeBtn" class="flex items-center gap-3 p-3 rounded-2xl frost card" title="דשבורד ראשי">
      <div class="w-12 h-12 rounded-xl grid place-items-center" style="background:linear-gradient(135deg,var(--accent),#4f46e5);color:white;font-weight:700">מ</div>
      <div class="text-right">
        <div class="text-sm text-gray-600">מערכת ניהול פרו</div>
        <div class="text-lg font-semibold">מכולות שוכבות</div>
      </div>
    </button>

    <div class="ms-auto flex items-center gap-3">
      <div class="text-sm text-gray-600">סך נזק משוער</div>
      <div id="totalLoss" class="text-xl font-bold text-red-600">₪0</div>
      <button id="openContainersPageBtn" class="px-4 py-2 rounded-2xl bg-gradient-to-r from-purple-600 to-indigo-600 text-white shadow-lg flex items-center gap-2 hover:scale-105 transition-transform">
        <span class="emoji-badge">📦</span>
        <span>כניסה למכולות שוכבות</span>
      </button>
    </div>
  </header>

  <main class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Left column: list + search -->
    <section class="lg:col-span-2 space-y-4">
      <div class="p-4 card frost">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-sm text-gray-500">חיפוש לקוח / תעודה</div>
            <div class="mt-2 flex gap-2">
              <input id="searchInput" type="search" placeholder="חפש שם לקוח / תעודה" class="px-3 py-2 rounded-xl border w-full" />
              <select id="filterDays" class="px-3 py-2 rounded-xl border"><option value="0">הכל</option><option value="1">>1 יום</option><option value="10">>10 ימים</option></select>
            </div>
          </div>
          <div class="text-right">
            <div class="text-xs text-gray-500">עיצוב דינאמי</div>
            <div class="text-sm text-gray-700 typing" id="typedStatus">טוען נתונים…</div>
          </div>
        </div>
      </div>

      <div id="listContainer" class="space-y-3"></div>
    </section>

    <!-- Right column: charts + details -->
    <aside class="space-y-4">
      <div class="p-4 card frost">
        <div class="flex items-center justify-between mb-2">
          <div>
            <div class="text-sm text-gray-500">תרשים נזק לשם לקוח</div>
            <div class="text-lg font-semibold">נזק כספי משוער לפי לקוח</div>
          </div>
          <div class="text-sm text-gray-500">עדכון אחרון: <span id="lastUpdate">--</span></div>
        </div>
        <canvas id="lossByCustomerChart" height="220"></canvas>
      </div>

      <div class="p-4 card frost">
        <div class="text-sm text-gray-500">פילוח חריגות</div>
        <div class="mt-2 grid grid-cols-3 gap-2 text-center">
          <div class="p-3 rounded-lg bg-red-50">
            <div class="text-xs text-gray-500">מעל 10 ימים</div>
            <div id="countOver10" class="text-xl font-bold text-red-600">0</div>
          </div>
          <div class="p-3 rounded-lg bg-yellow-50">
            <div class="text-xs text-gray-500">1-2 ימים</div>
            <div id="count1to2" class="text-xl font-bold text-yellow-700">0</div>
          </div>
          <div class="p-3 rounded-lg bg-green-50">
            <div class="text-xs text-gray-500">ללא חריגה</div>
            <div id="countOk" class="text-xl font-bold text-green-700">0</div>
          </div>
        </div>
      </div>

    </aside>
  </main>

  <!-- Popup advanced -->
  <div id="popup" class="fixed inset-0 hidden items-center justify-center bg-black/40 p-4">
    <div class="bg-white rounded-2xl max-w-2xl w-full p-4 card">
      <div class="flex items-start gap-4">
        <div class="w-14 h-14 rounded-lg grid place-items-center" id="popupBadge" style="background:linear-gradient(135deg,var(--accent),#4f46e5);color:white">ק</div>
        <div class="flex-1">
          <div class="flex items-center justify-between">
            <h3 id="popupTitle" class="text-lg font-bold">שם לקוח</h3>
            <div class="text-sm text-gray-500">תעודה: <span id="popupDoc">-</span></div>
          </div>
          <div id="popupMeta" class="mt-2 text-sm text-gray-600"></div>
          <div class="mt-3 grid grid-cols-2 gap-3">
            <div class="p-3 rounded-lg bg-gray-50">
              <div class="text-xs text-gray-500">ימים שעברו</div>
              <div id="popupDays" class="text-xl font-semibold">0</div>
            </div>
            <div class="p-3 rounded-lg bg-gray-50">
              <div class="text-xs text-gray-500">נזק יומי (₪)</div>
              <div id="popupDailyCost" class="text-xl font-semibold">0</div>
            </div>
          </div>

          <div class="mt-3">
            <div class="text-sm text-gray-500">נזק משוער (₪)</div>
            <div id="popupLoss" class="text-2xl font-bold text-red-600">₪0</div>
          </div>

          <div class="mt-4 flex gap-2">
            <a id="popupWhats" href="#" target="_blank" class="flex-1 px-3 py-2 rounded-xl text-center border">שלח וואטסאפ</a>
            <button id="popupClose" class="px-3 py-2 rounded-xl bg-red-600 text-white">סגור</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ====== CONFIG ======
    const API_URL = 'https://script.google.com/macros/s/AKfycbx7E0OrpJc7Yq4xhFTj376xVMo9VfvhLAjDZ6zdt8QGzXvlzKkANZxn4cV5AfvDPQ0m/exec'; // החלף בכתובת ה-exec שלך
    const DEFAULT_DAILY_COST = 150; // ₪ לערך ליום - יש לשנות לפי הסכם/לקוח

    // ====== STATE ======
    let orders = [];
    let chartInstance = null;

    // ====== UTIL ======
    function fmtMoney(v){ return '₪' + Number(v||0).toLocaleString('he-IL'); }
    function parseNum(v){ const n = parseFloat(String(v).replace(',', '.')); return isNaN(n)?0:n; }

    // Typing effect (simple) — will type messages into element
    function typeText(el, texts, speed=30, pause=1400){
      let idx=0, ti=0, forward=true;
      const tick = ()=>{
        const txt = texts[idx];
        if (forward){ ti++; el.textContent = txt.slice(0,ti); if (ti===txt.length){ forward=false; setTimeout(tick,pause); return; } }
        else { ti--; el.textContent = txt.slice(0,ti); if (ti===0){ forward=true; idx=(idx+1)%texts.length; } }
        setTimeout(tick, speed);
      };
      tick();
    }

    // ====== FETCH & PROCESS ======
    async function fetchOrders(){
      document.getElementById('typedStatus').textContent = 'מממשק נתונים...';
      try{
        const res = await fetch(API_URL + '?action=list');
        if (!res.ok) throw new Error('שגיאת רשת ' + res.status);
        const json = await res.json();
        if (!json || !Array.isArray(json.data)) throw new Error('פורמט נתונים לא תקין');
        orders = json.data.map(normalize);
        renderAll();
      }catch(e){
        console.error(e);
        document.getElementById('typedStatus').textContent = 'שגיאה בטעינה — טען דמו או בדוק הגדרות';
        // fallback to demo for visibility
        orders = getDemo(); renderAll();
      }
    }

    function normalize(o){
      return {
        doc: o['תעודה'] || o['תעודה מספר'] || o['מספר תעודה'] || '',
        client: o['שם לקוח'] || o['לקוח'] || 'לא ידוע',
        date: o['מתאריך'] || o['תאריך'] || '',
        days: parseInt(o['ימים שעברו']) || parseInt(o['ימי חריגה']) || 0,
        container: o['מס" מכולה ירדה'] || o['מס\" מכולה ירדה'] || o['מס מכולה'] || o['מס מכולה ירדה'] || '',
        dailyCost: parseNum(o['עלות יומית']) || parseNum(o['נזק יומי']) || DEFAULT_DAILY_COST
      };
    }

    // ====== RENDER LIST ======
    function renderAll(){
      document.getElementById('typedStatus').textContent = 'מוצג ' + orders.length + ' רשומות';
      document.getElementById('lastUpdate').textContent = new Date().toLocaleString('he-IL');

      const list = document.getElementById('listContainer'); list.innerHTML = '';
      // sort by days desc
      const sorted = [...orders].sort((a,b)=>b.days - a.days);
      let totalLoss = 0;
      let over10=0, oneToTwo=0, ok=0;

      for(const o of sorted){
        const loss = o.days * o.dailyCost;
        totalLoss += loss;
        if (o.days > 10) over10++; else if (o.days>=1 && o.days<=2) oneToTwo++; else ok++;

        const item = document.createElement('div');
        item.className = 'p-3 card flex items-center justify-between gap-3';
        // color band
        const band = document.createElement('div'); band.style.width='6px'; band.style.borderRadius='8px';
        if (o.days > 10) { band.style.background='linear-gradient(180deg, rgba(239,68,68,0.9), rgba(239,68,68,0.5))'; band.classList.add('blink-danger') }
        else if (o.days>=1 && o.days<=2) { band.style.background='linear-gradient(180deg, rgba(245,158,11,0.9), rgba(245,158,11,0.4))' }
        else { band.style.background='linear-gradient(180deg, rgba(16,185,129,0.9), rgba(16,185,129,0.4))' }

        const inner = document.createElement('div'); inner.className='flex-1';
        inner.innerHTML = `
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm text-gray-500">${o.doc} <span class="text-xs text-gray-400">• ${o.container || '—'}</span></div>
              <div class="text-lg font-semibold text-blue-700 cursor-pointer">${o.client}</div>
            </div>
            <div class="text-right">
              <div class="text-sm text-gray-500">ימים: <span class="font-medium">${o.days}</span></div>
              <div class="text-lg font-bold text-red-600">${fmtMoney(loss)}</div>
            </div>
          </div>
        `;

        item.appendChild(band); item.appendChild(inner);
        item.addEventListener('click', ()=>openPopup(o));
        list.appendChild(item);
      }

      document.getElementById('totalLoss').textContent = fmtMoney(totalLoss);
      document.getElementById('countOver10').textContent = over10;
      document.getElementById('count1to2').textContent = oneToTwo;
      document.getElementById('countOk').textContent = ok;

      // update chart
      updateChart(sorted);
    }

    // ====== CHART ======
    function updateChart(sorted){
      // top 8 customers by loss
      const losses = {};
      for(const o of sorted){ const l = o.days * o.dailyCost; losses[o.client] = (losses[o.client]||0) + l }
      const entries = Object.entries(losses).sort((a,b)=>b[1]-a[1]).slice(0,8);
      const labels = entries.map(e=>e[0]);
      const data = entries.map(e=>e[1]);

      const ctx = document.getElementById('lossByCustomerChart');
      if (chartInstance) chartInstance.destroy();
      chartInstance = new Chart(ctx, {
        type:'bar', data:{labels, datasets:[{label:'נזק משוער (₪)', data, backgroundColor: labels.map(l=> '#ef4444')}]},
        options:{indexAxis:'y', responsive:true, plugins:{legend:{display:false}, tooltip:{callbacks:{label:ctx=> fmtMoney(ctx.raw)}}}, scales:{x:{ticks:{callback:v=> '₪' + v}}}
      });
    }

    // ====== POPUP ======
    function openPopup(o){
      document.getElementById('popupTitle').textContent = o.client;
      document.getElementById('popupDoc').textContent = o.doc;
      document.getElementById('popupMeta').textContent = 'מכולה: ' + (o.container||'—') + ' • תאריך: ' + (o.date||'—');
      document.getElementById('popupDays').textContent = o.days;
      document.getElementById('popupDailyCost').textContent = fmtMoney(o.dailyCost).replace('₪','');
      document.getElementById('popupLoss').textContent = fmtMoney(o.days * o.dailyCost);
      const phone = o.phone || ''; // אם יש שדה טלפון
      const wa = phone ? `https://wa.me/${phone.replace(/[^0-9+]/g,'')}?text=${encodeURIComponent('שלום, לגבי מכולה '+(o.container||'')+' — נשמח לתיאום')}` : '#';
      const popupWhats = document.getElementById('popupWhats'); popupWhats.href = wa;
      document.getElementById('popup').classList.remove('hidden');
    }
    document.getElementById('popupClose').addEventListener('click', ()=> document.getElementById('popup').classList.add('hidden'));

    // ====== PAGE NAV ======
    document.getElementById('openContainersPageBtn').addEventListener('click', ()=>{ window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'}); document.getElementById('filterDays').value = '10'; filterAndRender(); });
    document.getElementById('homeBtn').addEventListener('click', ()=> { window.location.href = '#'; });

    // ====== FILTERS & SEARCH ======
    function filterAndRender(){
      const q = document.getElementById('searchInput').value.trim().toLowerCase();
      const minDays = parseInt(document.getElementById('filterDays').value,10) || 0;
      const filtered = orders.filter(o => (o.client + ' ' + o.doc + ' ' + (o.container||'')).toLowerCase().includes(q) && o.days >= minDays);
      orders = filtered.concat(orders.filter(o=> !filtered.includes(o))).slice(0,200); // keep sorted but filtered
      renderAll();
    }
    document.getElementById('searchInput').addEventListener('input', debounce(filterAndRender, 250));
    document.getElementById('filterDays').addEventListener('change', filterAndRender);

    function debounce(fn,ms=200){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); } }

    // ====== DEMO DATA ======
    function getDemo(){ return [
      { 'תעודה':'INV-9001','שם לקוח':'חברת זק', 'מתאריך':'2025-07-10','ימים שעברו':22,'מס" מכולה ירדה':'C-9001','עלות יומית':200,'phone':'972508860896' },
      { 'תעודה':'INV-9002','שם לקוח':'אלון הסעות', 'מתאריך':'2025-08-05','ימים שעברו':12,'מס" מכולה ירדה':'C-9002','עלות יומית':150,'phone':'972508860897' },
      { 'תעודה':'INV-9003','שם לקוח':'י.ק. היסעים', 'מתאריך':'2025-08-12','ימים שעברו':1,'מס" מכולה ירדה':'C-9003','עלות יומית':120,'phone':'972508860898' },
      { 'תעודה':'INV-9004','שם לקוח':'דקל', 'מתאריך':'2025-08-13','ימים שעברו':0,'מס" מכולה ירדה':'C-9004','עלות יומית':100 }
    ].map(normalize);
    }

    // ====== INIT ======
    typeText(document.getElementById('typedStatus'), ['טוען נתונים…','מחשב נזקים משוערים…','מייצר תרשימים ודו"חות…'], 30, 900);
    fetchOrders();
  </script>
</body>
</html>

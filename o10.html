<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title> 拽专  转</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /*
      Combined and enhanced CSS styles from both files.
      Using a modern, clean design with Tailwind CSS and custom classes.
    */
    @import url('https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700&display=swap');
    
    :root {
      --primary: #4f46e5;
      --primary-light: #818cf8;
      --secondary: #f97316;
      --danger: #ef4444;
      --success: #10b981;
      --warning: #f59e0b;
    }
    
    body {
      font-family: 'Rubik', Arial, sans-serif;
      direction: rtl;
      background-color: #f8fafc;
    }
    
    .container-fade {
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
      border-radius: 12px;
      padding: 1.5rem;
    }
    
    .metric-card {
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      border-radius: 10px;
      padding: 1.25rem;
    }
    
    .metric-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 18px -4px rgba(0, 0, 0, 0.15), 0 5px 8px -2px rgba(0, 0, 0, 0.08);
    }
    
    .table-row:hover {
      background-color: #e2e8f0 !important;
    }

    /* Conditional styling based on action type */
    .action-爪 { background-color: #dcfce7 !important; }
    .action-爪:hover { background-color: #bbf7d0 !important; }

    .action-住祝 { background-color: #fee2e2 !important; }
    .action-住祝:hover { background-color: #fecaca !important; }

    .action-驻专拽 { background-color: #eff6ff !important; }
    .action-驻专拽:hover { background-color: #dbeafe !important; }

    .action-注 { background-color: #fffbeb !important; }
    .action-注:hover { background-color: #fef3c7 !important; }

    .action-驻 { background-color: #ffedd5 !important; }
    .action-驻:hover { background-color: #fed7aa !important; }

    .action-爪 { background-color: #fce7e7 !important; }
    .action-爪:hover { background-color: #fcc2c2 !important; }

    .action-驻-拽, .action- { background-color: #ede9fe !important; }
    .action-驻-拽:hover, .action-:hover { background-color: #ddd6fe !important; }

    /* General overdue and today rows */
    .overdue-row {
      background-color: #fca5a5 !important;
      color: #7f1d1d;
      font-weight: 600;
    }
    
    .overdue-row:hover {
      background-color: #f87171 !important;
    }
    
    .today-row {
      background-color: #a7f3d0 !important;
      color: #065f46;
      font-weight: 600;
    }
    
    .today-row:hover {
      background-color: #6ee7b7 !important;
    }

    /* Closed order styling */
    .closed-row {
      text-decoration: line-through;
      color: #a0a0a0;
      background-color: #e9e9e9 !important;
      font-style: italic;
    }
    
    .closed-row:hover {
      background-color: #d9d9d9 !important;
    }
    
    .chart-container {
      transition: all 0.3s ease;
      border-radius: 10px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    
    .chart-container:hover {
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    
    .btn-primary {
      background-color: var(--primary);
      transition: all 0.3s ease;
      border-radius: 8px;
      padding: 0.6rem 1.2rem;
    }
    
    .btn-primary:hover {
      background-color: var(--primary-light);
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .btn-secondary {
      background-color: var(--secondary);
      transition: all 0.3s ease;
      border-radius: 8px;
      padding: 0.6rem 1.2rem;
    }
    
    .btn-secondary:hover {
      background-color: #fb923c;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .btn-danger {
      background-color: var(--danger);
      transition: all 0.3s ease;
      border-radius: 8px;
      padding: 0.6rem 1.2rem;
    }

    .btn-danger:hover {
      background-color: #dc2626;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .badge-primary {
      background-color: var(--primary-light);
      color: white;
    }
    
    .badge-danger {
      background-color: var(--danger);
      color: white;
    }
    
    .badge-success {
      background-color: var(--success);
      color: white;
    }
    
    .badge-warning {
      background-color: var(--warning);
      color: white;
    }
    
    .tooltip {
      position: relative;
      display: inline-block;
    }
    
    .tooltip .tooltip-text {
      visibility: hidden;
      width: 120px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -60px;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .tooltip:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }

    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background-color: #fefefe;
      margin: auto;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      width: 80%;
      max-width: 400px;
      text-align: center;
    }

    .close-button {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }

    .close-button:hover,
    .close-button:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }

    /* Flashing emoji animation */
    @keyframes flash {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.2; }
    }
    .flashing-emoji {
      animation: flash 1.5s infinite ease-in-out;
      display: inline-block;
      margin-right: 4px;
      font-size: 1.1em;
    }

    /* Flashing container number for overdue rows */
    @keyframes containerFlash {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    .flashing-container-number {
      animation: containerFlash 1.8s infinite ease-in-out;
      font-weight: bold;
    }
    
    /* Table column divider style */
    .table-divider {
      border-left: 2px solid #a0a0a0;
    }

    /* Specific styles for table headers and cells to make text bolder and darker */
    #ordersTable thead th {
        font-weight: 800;
        color: #333;
    }

    #ordersTable tbody td {
        font-weight: 600;
        color: #444;
    }

    @media (max-width: 768px) {
      .metrics-grid {
        grid-template-columns: repeat(2, 1fr) !important;
      }
      
      .chart-grid {
        grid-template-columns: 1fr !important;
      }
    }
    
    @media (max-width: 480px) {
      .metrics-grid {
        grid-template-columns: 1fr !important;
      }
    }
  </style>
</head>
<body class="min-h-screen">
  <div class="container mx-auto px-4 py-8 max-w-7xl container-fade">
    <!-- Header Section -->
    <header class="mb-8 text-center">
      <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-2"> 拽专  转</h1>
      <p class="text-gray-700 font-medium"> 转 转 转  转</p>
      
      <!-- Overdue Orders Banner -->
      <div id="overdueOrdersBanner" class="mt-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg shadow-md hidden">
        <h2 class="font-bold text-xl mb-3 flex items-center justify-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
          拽转 砖专:
        </h2>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-red-300">
            <thead class="bg-red-50">
              <tr>
                <th class="px-4 py-2 text-right text-xs font-semibold text-red-600 uppercase tracking-wider">转注</th>
                <th class="px-4 py-2 text-right text-xs font-semibold text-red-600 uppercase tracking-wider">砖 拽</th>
                <th class="px-4 py-2 text-right text-xs font-semibold text-red-600 uppercase tracking-wider">转转</th>
                <th class="px-4 py-2 text-right text-xs font-semibold text-red-600 uppercase tracking-wider"> 专</th>
                <th class="px-4 py-2 text-right text-xs font-semibold text-red-600 uppercase tracking-wider"> 专</th>
              </tr>
            </thead>
            <tbody id="overdueOrdersTableBody" class="bg-red-50 divide-y divide-red-200">
              <!-- Overdue orders will be listed here -->
            </tbody>
          </table>
        </div>
      </div>
    </header>
    
    <!-- Action Buttons and Filters -->
    <div class="bg-white rounded-lg shadow-md p-4 mb-6">
      <div class="flex flex-wrap items-center justify-between gap-4">
        <div class="flex flex-wrap gap-2">
          <button id="newOrderBtn" class="btn-primary text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
            </svg>
             砖
          </button>
          <button id="refreshBtn" class="btn-secondary text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
            </svg>
            专注 转
          </button>
        </div>
        
        <div class="flex flex-wrap gap-3 items-center">
          <div class="relative">
            <input type="text" id="searchInput" placeholder="驻砖 ..." 
                   class="border border-gray-300 rounded-lg px-4 py-2 pr-10 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-3 top-2.5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
            </svg>
          </div>
          
          <select id="actionFilter" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value=""> 住 驻注</option>
          </select>
          
          <div class="relative">
            <input type="number" id="daysMax" placeholder=" 砖注专 (拽住)" 
                   class="border border-gray-300 rounded-lg px-4 py-2 w-40 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <span class="absolute left-3 top-2.5 text-gray-500 text-sm"></span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Metrics Cards -->
    <div class="metrics-grid grid grid-cols-4 gap-4 mb-6">
      <div class="metric-card bg-white rounded-lg p-4 shadow-sm border-l-4 border-blue-500">
        <h3 class="text-gray-700 text-sm font-semibold mb-1">住" 转 驻转转</h3>
        <div class="flex items-center justify-between">
          <span id="totalOpen" class="text-3xl font-extrabold text-gray-900">0</span>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
          </svg>
        </div>
      </div>
      
      <div class="metric-card bg-white rounded-lg p-4 shadow-sm border-l-4 border-red-500">
        <h3 class="text-gray-700 text-sm font-semibold mb-1">转 专转 (&gt; 10 )</h3>
        <div class="flex items-center justify-between">
          <span id="overdue" class="text-3xl font-extrabold text-gray-900">0</span>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
      </div>
      
      <div class="metric-card bg-white rounded-lg p-4 shadow-sm border-l-4 border-green-500">
        <h3 class="text-gray-700 text-sm font-semibold mb-1">驻注转 住祝 </h3>
        <div class="flex items-center justify-between">
          <span id="todayActions" class="text-3xl font-extrabold text-gray-900">0</span>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
          </svg>
        </div>
      </div>
      
      <div class="metric-card bg-white rounded-lg p-4 shadow-sm border-l-4 border-orange-500">
        <h3 class="text-gray-700 text-sm font-semibold mb-1">爪注  砖注专</h3>
        <div class="flex items-center justify-between">
          <span id="avgDays" class="text-3xl font-extrabold text-gray-900">0.0</span>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
      </div>
    </div>
    
    <!-- Charts Section -->
    <div class="chart-grid grid grid-cols-2 gap-6 mb-6">
      <div class="chart-container bg-white rounded-lg p-4 shadow-sm">
        <h3 class="text-gray-800 font-semibold mb-3">转驻转 住 驻注</h3>
        <canvas id="actionChart" height="150"></canvas>
      </div>
      <div class="chart-container bg-white rounded-lg p-4 shadow-sm">
        <h3 class="text-gray-800 font-semibold mb-3">住专转  砖注专</h3>
        <canvas id="daysChart" height="150"></canvas>
      </div>
    </div>
    
    <!-- Orders Table -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden mb-6">
      <div class="overflow-x-auto">
        <table id="ordersTable" class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-6 py-3 text-right text-xs font-bold text-gray-700 uppercase tracking-wider table-divider">转注</th>
              <th class="px-6 py-3 text-right text-xs font-bold text-gray-700 uppercase tracking-wider table-divider">砖 拽</th>
              <th class="px-6 py-3 text-right text-xs font-bold text-gray-700 uppercase tracking-wider table-divider">砖 住</th>
              <th class="px-6 py-3 text-right text-xs font-bold text-gray-700 uppercase tracking-wider table-divider">转转</th>
              <th class="px-6 py-3 text-right text-xs font-bold text-gray-700 uppercase tracking-wider table-divider"> 砖注专</th>
              <th class="px-6 py-3 text-right text-xs font-bold text-gray-700 uppercase tracking-wider table-divider">转专</th>
              <th class="px-6 py-3 text-right text-xs font-bold text-gray-700 uppercase tracking-wider table-divider">住 驻注</th>
              <th class="px-6 py-3 text-right text-xs font-bold text-gray-700 uppercase tracking-wider table-divider">住"  专</th>
              <th class="px-6 py-3 text-right text-xs font-bold text-gray-700 uppercase tracking-wider table-divider">住"  注转</th>
              <th class="px-6 py-3 text-right text-xs font-bold text-gray-700 uppercase tracking-wider table-divider"> 砖注专 (注转)</th>
              <th class="px-6 py-3 text-right text-xs font-bold text-gray-700 uppercase tracking-wider">驻注转</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <tr>
              <td colspan="11" class="px-6 py-4 text-center text-gray-500">注 转...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmModal" class="modal">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <p id="modalMessage" class="text-lg font-semibold mb-4 text-gray-800"></p>
      <div class="flex justify-center gap-4">
        <button id="modalConfirmBtn" class="btn-danger text-white px-4 py-2 rounded-lg font-medium">砖专</button>
        <button id="modalCancelBtn" class="btn-secondary text-white px-4 py-2 rounded-lg font-medium"></button>
      </div>
    </div>
  </div>

  <script>
    // URL for the Google Apps Script Web App for data communication
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx7E0OrpJc7Yq4xhFTj376xVMo9VfvhLAjDZ6zdt8QGzXvlzKkANZxn4cV5AfvDPQ0m/exec';
    let allOrders = []; // Stores all fetched orders
    let actionChartInstance = null; // Chart.js instance for action distribution
    let daysChartInstance = null; // Chart.js instance for days passed histogram
    let stuckContainersGlobal = new Set(); // Global set to track "stuck" containers

    // Define the required fields for a row to be displayed and considered complete.
    // These correspond to columns in your Google Sheet (A:J in the provided example).
    const REQUIRED_FIELDS_FOR_DISPLAY = [
        '转专', // A
        '转注',  // B
        '砖 住', // C
        '砖 拽', // D
        '转转',   // E
        '住 驻注', // F
        ' 砖注专', // G
        '住"  专', // H
        '住"  注转', // I
        ' 砖注专 (注转)' // J
    ];

    // Initialize the dashboard when the DOM is fully loaded
    document.addEventListener('DOMContentLoaded', function() {
      // Event listeners for filtering and refreshing
      document.getElementById('refreshBtn').addEventListener('click', fetchOrders);
      // Debounce search and daysMax inputs to prevent excessive function calls
      document.getElementById('searchInput').addEventListener('input', debounce(filterOrders, 300));
      document.getElementById('actionFilter').addEventListener('change', filterOrders);
      document.getElementById('daysMax').addEventListener('input', debounce(filterOrders, 300));
      
      // Event listeners for the custom confirmation modal
      document.querySelector('.close-button').addEventListener('click', closeModal);
      document.getElementById('modalCancelBtn').addEventListener('click', closeModal);
      // Close modal if user clicks outside of the modal content
      window.addEventListener('click', (event) => {
        if (event.target === document.getElementById('confirmModal')) {
          closeModal();
        }
      });

      // Initial data fetch to populate the dashboard
      fetchOrders();
    });

    /**
     * Debounces a function to limit how often it's called.
     * Useful for input events like search to prevent too many updates.
     * @param {function} func The function to debounce.
     * @param {number} wait The number of milliseconds to wait before calling the function.
     */
    function debounce(func, wait) {
      let timeout;
      return function() {
        const context = this, args = arguments;
        clearTimeout(timeout);
        timeout = setTimeout(() => {
          func.apply(context, args);
        }, wait);
      };
    }

    /**
     * Formats a date string (or Google Sheets serial number) into DD/MM/YYYY.
     * @param {string|number} isoString The date in ISO format or a Google Sheets serial number.
     * @returns {string} The formatted date or '-' if invalid.
     */
    function formatDate(isoString) {
      if (!isoString) return '-';
      try {
        let date;
        // Check if it's a Google Sheets date number (a large positive number)
        const numValue = Number(isoString);
        if (!isNaN(numValue) && numValue > 0) {
            // Google Sheets date serial starts from 1899-12-30. Excel's is 1900-01-01.
            // Adjusting for common Excel serial dates which start from Jan 1, 1900.
            // 25569 is the difference in days between 1970-01-01 (JS epoch) and 1899-12-30.
            date = new Date((numValue - 25569) * 86400 * 1000); 
        } else {
            // Otherwise, assume it's a date string parsable by Date constructor
            date = new Date(isoString);
        }
        
        if (isNaN(date.getTime())) { // Check for invalid date after parsing
          return isoString; // Return original if parsing failed
        }
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0'); // Month is 0-indexed
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
      } catch (e) {
        console.error("Error parsing date:", isoString, e);
        return isoString; // Fallback to original string if error occurs
      }
    }

    /**
     * Identifies "stuck" containers. A container is considered stuck if:
     * 1. It has a '住"  专' record.
     * 2. It does NOT have a corresponding '住"  注转' record anywhere in the dataset.
     * 3. Its '住"  专' action is NOT '爪' or '驻 拽' (which implies it's permanently removed).
     * @param {Array<Object>} orders The array of all order objects.
     * @returns {Set<string>} A set of container numbers that are stuck.
     */
    function identifyStuckContainers(orders) {
        const containersDownRecords = new Map(); // Map: containerNum -> [{order, actionType}, ...] for '专'
        const containersUpSet = new Set();   // Set of container numbers that have '注转' records
        
        // Populate containersDownRecords and containersUpSet
        orders.forEach(o => {
            const containerDown = String(o['住"  专'] || '').trim();
            const containerUp = String(o['住"  注转'] || '').trim();
            const actionType = String(o['住 驻注'] || '').trim();

            if (containerDown && containerDown !== '0') {
                if (!containersDownRecords.has(containerDown)) {
                    containersDownRecords.set(containerDown, []);
                }
                containersDownRecords.get(containerDown).push({order: o, actionType: actionType});
            }
            if (containerUp && containerUp !== '0') {
                containersUpSet.add(containerUp);
            }
        });

        const stuck = new Set();
        // Iterate through all containers that ever went down
        containersDownRecords.forEach((records, containerNum) => {
            // Check if this container number has ever gone up
            if (!containersUpSet.has(containerNum)) {
                // If it never went up, then it's stuck unless its 'down' record was a final removal type
                const isTrulyStuck = records.some(record => 
                    record.actionType !== '爪' && record.actionType !== '驻 拽'
                );
                if (isTrulyStuck) {
                    stuck.add(containerNum);
                }
            }
        });
        return stuck;
    }

    /**
     * Fetches order data from the Google Apps Script Web App.
     * Displays a loading spinner while fetching.
     */
    async function fetchOrders() {
      try {
        // Show loading spinner in the table body
        const tbody = document.querySelector('#ordersTable tbody');
        tbody.innerHTML = '<tr><td colspan="11" class="px-6 py-4 text-center text-gray-500"><div class="flex justify-center"><svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> 注 转...</div></td></tr>';
        
        const res = await fetch(`${SCRIPT_URL}?action=list`);
        const data = await res.json();
        
        if (data.success) {
          allOrders = data.data.map(order => {
            // Ensure 'closed' status is a boolean based on 'TRUE' string from sheet
            return { 
              ...order, 
              closed: String(order.closed).toUpperCase() === 'TRUE' 
            }; 
          });
          stuckContainersGlobal = identifyStuckContainers(allOrders); // Recalculate stuck containers after fresh data fetch
          populateActionFilter(); // Populate action type filter dropdown
          updateDashboard(); // Update all dashboard components
        } else {
          showError('砖 砖驻转 转: ' + (data.message || '转  转拽 砖专转.'));
        }
      } catch (error) {
        showError('砖 专 砖专转.   砖住拽专驻 专  .');
        console.error('Error fetching orders:', error);
      }
    }

    /**
     * Populates the 'Action Type' filter dropdown with unique action types from the data.
     */
    function populateActionFilter() {
      const select = document.getElementById('actionFilter');
      // Extract unique and non-empty action types, then sort them alphabetically
      const actions = [...new Set(allOrders.map(o => String(o['住 驻注'] || '').trim()).filter(a => a !== ''))].sort();
      select.innerHTML = '<option value=""> 住 驻注</option>'; // Default option
      actions.forEach(a => {
        const option = document.createElement('option');
        option.value = a;
        option.textContent = a;
        select.appendChild(option);
      });
    }

    /**
     * Filters the orders based on current input values (search, action type, days max).
     * This function now acts as a trigger to update the entire dashboard.
     */
    function filterOrders() {
        updateDashboard();
    }

    /**
     * Updates all sections of the dashboard: table, metrics, charts, and overdue banner.
     * It intelligently filters data for each section's specific requirements.
     */
    function updateDashboard() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const actionFilterValue = document.getElementById('actionFilter').value;
        const daysMax = parseInt(document.getElementById('daysMax').value) || Infinity;

        // Determine which orders should be considered "active" (not closed) AND match current filters
        // This subset is used for metrics, charts, and the overdue banner
        const activeAndFilteredOrders = allOrders.filter(o => {
            // Exclude orders explicitly marked as closed for active calculations
            if (o.closed) return false;

            // Apply search filter (checks across multiple relevant fields)
            const matchesSearch = (String(o['砖 拽'] || '').toLowerCase().includes(searchTerm) ||
                                 String(o['砖 住'] || '').toLowerCase().includes(searchTerm) ||
                                 String(o['转注'] || '').toLowerCase().includes(searchTerm) ||
                                 String(o['转转'] || '').toLowerCase().includes(searchTerm));

            // Apply action type filter
            const matchesAction = actionFilterValue ? (String(o['住 驻注'] || '') === actionFilterValue) : true;
            
            // Apply days max filter
            const matchesDays = parseInt(o[' 砖注专'] || 0) <= daysMax;

            return matchesSearch && matchesAction && matchesDays;
        });

        // The main table displays ALL orders that meet the basic completeness criteria
        // (i.e., having all REQUIRED_FIELDS_FOR_DISPLAY), and *then* applies
        // visual styling based on search/filter/status (overdue, today, closed).
        // This ensures users can still see filtered/searched items even if they are closed.
        updateOrdersTable(allOrders); 
        
        // Update metrics, charts, and overdue banner using the subset of active and filtered orders
        updateMetrics(activeAndFilteredOrders);
        updateCharts(activeAndFilteredOrders);
        updateOverdueBanner(activeAndFilteredOrders);
    }

    /**
     * Updates the main orders table with order data, applying conditional styling.
     * @param {Array<Object>} orders The array of all order objects.
     */
    function updateOrdersTable(orders) {
      const tbody = document.querySelector('#ordersTable tbody');
      tbody.innerHTML = ''; // Clear existing rows
      
      const today = new Date().toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit', year: 'numeric' });
      
      // Get current filter values to determine which rows to display in the table
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const actionFilterValue = document.getElementById('actionFilter').value;
      const daysMax = parseInt(document.getElementById('daysMax').value) || Infinity;

      // Filter orders specifically for table display based on completeness and user filters
      const ordersToDisplayInTable = orders.filter(o => {
        // First, check if the row has all required fields for basic display
        const isRowComplete = REQUIRED_FIELDS_FOR_DISPLAY.every(field => {
            const value = o[field];
            // A field is considered complete if its value is not null, undefined, or an empty string after trimming
            return value !== null && value !== undefined && String(value).trim() !== '';
        });
        if (!isRowComplete) return false; // Skip rows that are missing essential data

        // Then, apply the user's search and filter criteria to decide if it should be visible in the table
        const matchesSearch = (String(o['砖 拽'] || '').toLowerCase().includes(searchTerm) ||
                             String(o['砖 住'] || '').toLowerCase().includes(searchTerm) ||
                             String(o['转注'] || '').toLowerCase().includes(searchTerm) ||
                             String(o['转转'] || '').toLowerCase().includes(searchTerm));
        const matchesAction = actionFilterValue ? (String(o['住 驻注'] || '') === actionFilterValue) : true;
        const matchesDays = parseInt(o[' 砖注专'] || 0) <= daysMax;

        // Display the order in the table if it's complete AND matches the current filters.
        // Even closed orders are displayed if they match filters, but with strikethrough.
        return matchesSearch && matchesAction && matchesDays;
      });

      if (ordersToDisplayInTable.length === 0) {
        tbody.innerHTML = '<tr><td colspan="11" class="px-6 py-4 text-center text-gray-500 font-bold"> 爪 转 转转 驻专.</td></tr>';
        return;
      }

      // Populate the table with filtered and styled rows
      ordersToDisplayInTable.forEach(o => {
        const daysPassed = parseInt(o[' 砖注专'] || 0);
        const isOverdue = daysPassed > 10 && !o.closed; // Overdue only for open orders
        const orderDateFormatted = formatDate(o['转专']);
        const isToday = orderDateFormatted === today && !o.closed; // "Today" only for open orders

        let actionTypeClass = '';
        if (o['住 驻注']) {
            // Create a CSS class name from the action type (e.g., "爪" becomes "action-爪")
            actionTypeClass = `action-${String(o['住 驻注']).trim().replace(/\s/g, '-')}`; 
        }

        let rowClass = `table-row ${actionTypeClass}`;
        // Apply main row class based on status (closed takes precedence, then overdue, then today)
        if (o.closed) {
            rowClass = `table-row closed-row`;
        } else if (isOverdue) {
            rowClass += ` overdue-row`;
        } else if (isToday) {
            rowClass += ` today-row`;
        }
        
        const tr = document.createElement('tr');
        tr.className = rowClass;
        tr.setAttribute('data-order-id', o['转注']); // Store order ID on the row

        // Logic for the flashing lightbulb emoji for "stuck" containers
        const containerDownNum = String(o['住"  专'] || '').trim();
        let flashingEmojiHtml = '';
        // Display emoji if the container is globally identified as stuck and the current order's action
        // is not one that would resolve the "stuck" status (e.g., '爪' or '驻 拽')
        if (stuckContainersGlobal.has(containerDownNum) && 
            String(o['住 驻注'] || '').trim() !== '爪' && String(o['住 驻注'] || '').trim() !== '驻 拽') {
            flashingEmojiHtml = '<span class="flashing-emoji"></span>'; 
        }

        // Apply flashing effect to container number if the order is overdue
        const containerDownDisplay = `<span class="${isOverdue ? 'flashing-container-number' : ''}">${o['住"  专'] || '-'}</span>`;

        // HTML for the "Close Order" button, only visible for open orders
        const closeButtonHtml = o.closed ? '' : `
            <button onclick="confirmCloseOrder('${o['转注']}')" class="text-red-600 hover:text-red-900 tooltip mr-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
              </svg>
              <span class="tooltip-text">住专 </span>
            </button>
        `;
        
        // HTML for the "Delete Order" button
        const deleteButtonHtml = `
            <button onclick="confirmDeleteOrder('${o['转注']}')" class="text-gray-500 hover:text-gray-800 tooltip">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1z" clip-rule="evenodd" />
                </svg>
                <span class="tooltip-text">拽 </span>
            </button>
        `;

        // Construct the table row's inner HTML
        tr.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900 table-divider">${o['转注'] || '-'}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-800 table-divider">${o['砖 拽'] || '-'}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-800 table-divider">${o['砖 住'] || '-'}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-800 table-divider">${o['转转'] || '-'}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-800 table-divider">${o[' 砖注专'] || '0'}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-800 table-divider">${formatDate(o['转专'])}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-800 table-divider">
            ${o['住 驻注'] || '-'}
            ${isToday ? '<span class="badge badge-success ml-2"></span>' : ''}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-800 table-divider">${flashingEmojiHtml}${containerDownDisplay}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-800 table-divider">${o['住"  注转'] || '-'}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-800 table-divider">${o[' 砖注专 (注转)'] || '-'}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-800 flex items-center">
            <button onclick="editOrder('${o['转注']}')" class="text-blue-600 hover:text-blue-900 tooltip mr-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
              </svg>
              <span class="tooltip-text">注专 </span>
            </button>
            ${closeButtonHtml}
            ${deleteButtonHtml}
          </td>
        `;
        
        tbody.appendChild(tr);
      });
    }

    /**
     * Updates the four metric cards (Total Open, Overdue, Today's Actions, Average Days).
     * @param {Array<Object>} orders The array of filtered orders for metrics calculation.
     */
    function updateMetrics(orders) {
      const totalOpen = orders.length; 
      const overdue = orders.filter(o => parseInt(o[' 砖注专'] || 0) > 10).length;
      
      const today = new Date().toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit', year: 'numeric' });
      // Count '住祝' actions specifically for today's date
      const todayActions = orders.filter(o => String(o['住 驻注'] || '').trim() === '住祝' && formatDate(o['转专']) === today).length;
      
      const avgDays = orders.length ? 
        (orders.reduce((sum, o) => sum + parseInt(o[' 砖注专'] || 0), 0) / orders.length).toFixed(1) : 
        '0.0';

      document.getElementById('totalOpen').textContent = totalOpen;
      document.getElementById('overdue').textContent = overdue;
      document.getElementById('todayActions').textContent = todayActions;
      document.getElementById('avgDays').textContent = avgDays;
    }

    /**
     * Updates both Chart.js graphs based on the provided orders data.
     * @param {Array<Object>} orders The array of filtered orders for chart rendering.
     */
    function updateCharts(orders) {
      renderActionChart(orders);
      renderDaysChart(orders);
    }

    /**
     * Renders or updates the bar chart showing the distribution of action types.
     * @param {Array<Object>} orders The orders data to base the chart on.
     */
    function renderActionChart(orders) {
      const ctx = document.getElementById('actionChart').getContext('2d');
      const counts = {};
      
      orders.forEach(o => { 
        const action = String(o['住 驻注'] || '').trim();
        if (action) { 
            counts[action] = (counts[action] || 0) + 1; 
        }
      });
      
      const backgroundColors = generateColors(Object.keys(counts).length, 0.7); // Semi-transparent colors
      const borderColors = generateColors(Object.keys(counts).length, 1); // Solid colors for borders

      // Destroy previous chart instance if it exists to avoid memory leaks/rendering issues
      if (actionChartInstance) actionChartInstance.destroy();
      
      actionChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(counts),
          datasets: [{
            label: '住驻专 转',
            data: Object.values(counts),
            backgroundColor: backgroundColors,
            borderColor: borderColors,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'top',
              labels: {
                font: {
                  family: 'Rubik',
                  size: 14,
                  weight: 'bold'
                }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `${context.dataset.label}: ${context.raw}`;
                }
              },
              titleFont: {
                family: 'Rubik'
              },
              bodyFont: {
                family: 'Rubik'
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0,
                font: {
                  family: 'Rubik'
                }
              },
              grid: {
                color: '#e0e0e0' 
              }
            },
            x: {
              ticks: {
                font: {
                  family: 'Rubik'
                }
              },
              grid: {
                color: '#e0e0e0'
              }
            }
          }
        }
      });
    }

    /**
     * Renders or updates the bar chart showing the histogram of "days passed".
     * Groups days into bins for better visualization.
     * @param {Array<Object>} orders The orders data to base the chart on.
     */
    function renderDaysChart(orders) {
      const ctx = document.getElementById('daysChart').getContext('2d');
      // Extract 'days passed' values and sort them
      const days = orders.map(o => parseInt(o[' 砖注专'] || 0)).sort((a, b) => a - b);
      
      const bins = {};
      const maxDays = Math.max(...days, 0);
      const binSize = 5; // Group days into 5-day intervals
      
      // Initialize bins (e.g., "0-4 ", "5-9 ", etc.)
      for (let i = 0; i <= maxDays + binSize; i += binSize) {
        const binStart = i;
        const binEnd = i + binSize - 1;
        const binLabel = `${binStart}-${binEnd} `;
        bins[binLabel] = 0;
      }

      // Populate bins with data counts
      days.forEach(d => {
        const binIndex = Math.floor(d / binSize) * binSize;
        const binLabel = `${binIndex}-${binIndex + binSize - 1} `;
        const foundBin = Object.keys(bins).find(key => {
            const [start, end] = key.split('-').map(s => parseInt(s.replace(' ', '')));
            return d >= start && d <= end;
        });
        if (foundBin) {
            bins[foundBin]++;
        } else { // Handle cases where a day count might fall slightly outside initial bin range
            const lastBinKey = Object.keys(bins)[Object.keys(bins).length - 1];
            if (lastBinKey && d > parseInt(lastBinKey.split('-')[0])) {
                bins[lastBinKey]++;
            }
        }
      });

      // Remove empty bins for cleaner chart display
      for (const key in bins) {
          if (bins[key] === 0) {
              delete bins[key];
          }
      }

      const chartLabels = Object.keys(bins);
      const chartData = Object.values(bins);
      
      // Destroy previous chart instance if it exists
      if (daysChartInstance) daysChartInstance.destroy();
      
      daysChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: chartLabels,
          datasets: [{
            label: '住驻专 转',
            data: chartData,
            backgroundColor: 'rgba(249, 115, 22, 0.7)', // Orange with transparency
            borderColor: 'rgba(249, 115, 22, 1)', // Solid orange border
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'top',
              labels: {
                font: {
                  family: 'Rubik',
                  size: 14,
                  weight: 'bold'
                }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return ` : ${context.label}, 住驻专 转: ${context.raw}`;
                }
              },
              titleFont: {
                family: 'Rubik'
              },
              bodyFont: {
                family: 'Rubik'
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0,
                font: {
                  family: 'Rubik'
                }
              },
              grid: {
                color: '#e0e0e0'
              }
            },
            x: {
                title: {
                    display: true,
                    text: '  砖注专',
                    font: {
                      family: 'Rubik',
                      size: 14,
                      weight: 'bold'
                    }
                },
                ticks: {
                  font: {
                    family: 'Rubik'
                  }
                },
                grid: {
                  color: '#e0e0e0'
                }
            }
          }
        }
      });
    }

    /**
     * Generates an array of HSL colors for chart datasets.
     * @param {number} count The number of colors to generate.
     * @param {number} opacity The opacity value (0-1).
     * @returns {string[]} An array of HSL color strings.
     */
    function generateColors(count, opacity) {
      const colors = [];
      const hueStep = 360 / count; // Distribute hues evenly across the color wheel
      
      for (let i = 0; i < count; i++) {
        const hue = i * hueStep;
        colors.push(`hsla(${hue}, 70%, 60%, ${opacity})`); // HSL with consistent saturation and lightness
      }
      
      return colors;
    }

    /**
     * Displays a custom confirmation/alert modal.
     * @param {string} message The message to display in the modal.
     * @param {function} [onConfirm=null] Optional callback function to execute if confirmed.
     */
    function showModal(message, onConfirm = null) {
      document.getElementById('modalMessage').textContent = message;
      const confirmBtn = document.getElementById('modalConfirmBtn');
      if (onConfirm) {
        confirmBtn.style.display = 'inline-block'; // Show confirm button
        confirmBtn.onclick = () => {
          onConfirm(); // Execute callback
          closeModal(); // Close modal after action
        };
      } else {
        confirmBtn.style.display = 'none'; // Hide confirm button if no callback
      }
      document.getElementById('confirmModal').style.display = 'flex'; // Show modal
    }

    /**
     * Closes the custom modal.
     */
    function closeModal() {
      document.getElementById('confirmModal').style.display = 'none';
      document.getElementById('modalConfirmBtn').onclick = null; // Clear callback
    }

    /**
     * Displays an error message in the table area and resets metrics/charts.
     * @param {string} message The error message to display.
     */
    function showError(message) {
      const tbody = document.querySelector('#ordersTable tbody');
      tbody.innerHTML = `<tr><td colspan="11" class="px-6 py-4 text-center text-red-600 font-bold">${message}</td></tr>`; 
      
      // Reset metric cards
      document.getElementById('totalOpen').textContent = '0';
      document.getElementById('overdue').textContent = '0';
      document.getElementById('todayActions').textContent = '0';
      document.getElementById('avgDays').textContent = '0.0';
      
      // Destroy chart instances if they exist
      if (actionChartInstance) {
        actionChartInstance.destroy();
        actionChartInstance = null;
      }
      if (daysChartInstance) {
        daysChartInstance.destroy();
        daysChartInstance = null;
      }
      // Hide overdue banner on error
      document.getElementById('overdueOrdersBanner').classList.add('hidden');
    }

    /**
     * Placeholder function for editing an order. Shows a modal message.
     * @param {string} orderId The ID of the order to edit.
     */
    function editOrder(orderId) {
      showModal(`注专转  ${orderId} - 驻拽爪转  转驻转 砖.`);
    }

    /**
     * Prompts the user to confirm closing an order using a custom modal.
     * @param {string} orderId The ID of the order to close.
     */
    function confirmCloseOrder(orderId) {
        showModal(` 转  砖专爪 住专 转  住驻专 ${orderId}?`, () => closeOrder(orderId));
    }

    /**
     * Sends a request to the backend to close a specific order.
     * Updates the local data and refreshes the dashboard on success.
     * @param {string} orderId The ID of the order to close.
     */
    async function closeOrder(orderId) {
        try {
            const res = await fetch(`${SCRIPT_URL}?action=close&orderId=${orderId}`);
            const data = await res.json();

            if (data.success) {
                // Find and update the 'closed' status in the local allOrders array
                const index = allOrders.findIndex(o => o['转注'] === orderId);
                if (index !== -1) {
                    allOrders[index].closed = true; 
                }
                showModal(` ${orderId} 住专 爪!`);
                stuckContainersGlobal = identifyStuckContainers(allOrders); // Recalculate stuck containers after status change
                updateDashboard(); // Refresh the dashboard to reflect the change
            } else {
                showModal(`砖 住专转  ${orderId}: ${data.message || '住 砖 专 转专.'}`);
            }
        } catch (error) {
            console.error('Error closing order:', error);
            showModal(`砖 专 砖专转 注转 住专转  ${orderId}.`);
        }
    }

    /**
     * Prompts the user to confirm deleting an order using a custom modal.
     * @param {string} orderId The ID of the order to delete.
     */
    function confirmDeleteOrder(orderId) {
        showModal(` 转  砖专爪 拽 转  住驻专 ${orderId}? 驻注  转 驻!`, () => deleteOrder(orderId));
    }

    /**
     * Sends a request to the backend to delete a specific order.
     * Removes the order from local data and refreshes the dashboard on success.
     * @param {string} orderId The ID of the order to delete.
     */
    async function deleteOrder(orderId) {
        try {
            const res = await fetch(`${SCRIPT_URL}?action=delete&orderId=${orderId}`); // Assumes your Google Script handles a 'delete' action
            const data = await res.json();

            if (data.success) {
                // Remove the order from the local allOrders array
                allOrders = allOrders.filter(o => o['转注'] !== orderId);
                showModal(` ${orderId} 拽 爪!`);
                stuckContainersGlobal = identifyStuckContainers(allOrders); // Recalculate stuck containers after deletion
                updateDashboard(); // Refresh the dashboard
            } else {
                showModal(`砖 拽转  ${orderId}: ${data.message || '住 砖 专 转专.'}`);
            }
        } catch (error) {
            console.error('Error deleting order:', error);
            showModal(`砖 专 砖专转 注转 拽转  ${orderId}.`);
        }
    }

    /**
     * Updates the overdue orders banner with a list of overdue orders.
     * @param {Array<Object>} orders The array of orders to check for overdue status.
     */
    function updateOverdueBanner(orders) {
      const overdueTableBody = document.getElementById('overdueOrdersTableBody');
      const overdueBanner = document.getElementById('overdueOrdersBanner');
      
      overdueTableBody.innerHTML = ''; // Clear previous overdue list

      // Filter for orders that are overdue (>10 days passed) and are not closed
      const overdueOrders = orders.filter(o => parseInt(o[' 砖注专'] || 0) > 10 && !o.closed);

      if (overdueOrders.length > 0) {
        overdueBanner.classList.remove('hidden'); // Show the banner
        overdueOrders.forEach(o => {
          const tr = document.createElement('tr');
          tr.className = 'hover:bg-red-200'; // Hover effect for overdue rows in banner
          tr.innerHTML = `
            <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-red-800">${o['转注'] || '-'}</td>
            <td class="px-4 py-2 whitespace-nowrap text-sm text-red-700">${o['砖 拽'] || '-'}</td>
            <td class="px-4 py-2 whitespace-nowrap text-sm text-red-700">${o['转转'] || '-'}</td> 
            <td class="px-4 py-2 whitespace-nowrap text-sm text-red-700">${o['住"  专'] || '-'}</td>
            <td class="px-4 py-2 whitespace-nowrap text-sm font-bold text-red-800">${o[' 砖注专'] || '0'}</td>
          `;
          overdueTableBody.appendChild(tr);
        });
      } else {
        overdueBanner.classList.add('hidden'); // Hide the banner if no overdue orders
      }
    }

    // Expose functions to the global window object so they can be called from inline HTML event handlers
    window.editOrder = editOrder;
    window.confirmCloseOrder = confirmCloseOrder;
    window.confirmDeleteOrder = confirmDeleteOrder; 
    // You'll need to implement the actual 'new order' functionality, possibly with another modal or form
    document.getElementById('newOrderBtn').addEventListener('click', () => showModal('驻拽爪转 " 砖" 转驻转 砖.'));
  </script>
</body>
</html>

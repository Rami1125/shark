<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת CRM - לוח בקרה למנהל (משודרג)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for advanced charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <!-- DataTables.js CDN for smart tables -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.min.css"/>
    <script type="text/javascript" src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Google Fonts for Roboto Mono (for flight board effect) and Heebo -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&family=Heebo:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Custom Styles - for general app theme and overrides -->
    <link rel="stylesheet" href="style.css"> 
    <style>
        /* Define a new, cold, luxurious color palette as CSS variables for easy theming */
        :root {
            /* Light Theme Palette */
            --primary-brand: #3f51b5; /* Deep Indigo Blue */
            --secondary-brand: #7986cb; /* Lighter Indigo */
            --accent-color: #00bcd4; /* Cyan Accent */
            --background-light: #eceff1; /* Light Gray Blue */
            --surface-light: #ffffff; /* Pure White Card Surface */
            --text-dark: #263238; /* Dark Charcoal Text */
            --text-medium: #607d8b; /* Medium Slate Text */
            --border-light: #cfd8dc; /* Light Gray Border */
            --notification-error: #ef5350; /* Red for errors */
            --notification-warning: #ffb300; /* Amber for warnings */
            --notification-info: #2196f3; /* Blue for info */

            /* Dark Theme Palette (inspired by Monokai Pro / futuristic UI) */
            --dark-primary-brand: #80cbc4; /* Teal Accent for Dark */
            --dark-secondary-brand: #4dd0e1; /* Lighter Cyan for Dark */
            --dark-accent-color: #cddc39; /* Lime Green for Dark Accent */
            --dark-background-dark: #263238; /* Charcoal Blue Background */
            --dark-surface-dark: #37474f; /* Darker Slate Card Surface */
            --dark-text-light: #eceff1; /* Light Gray Blue Text */
            --dark-text-medium: #90a4ae; /* Medium Gray Text */
            --dark-border-dark: #546e7a; /* Dark Slate Border */
            --dark-notification-error: #d32f2f; /* Darker Red */
            --dark-notification-warning: #f57f17; /* Darker Amber */
            --dark-notification-info: #1976d2; /* Darker Blue */

            /* Glow Effect Colors */
            --glow-color-light: rgba(121, 134, 203, 0.7); /* Light Indigo for glow */
            --glow-color-dark: rgba(128, 203, 196, 0.7); /* Teal for dark glow */
        }

        body {
            font-family: 'Heebo', 'Roboto Mono', sans-serif; /* Prioritize Heebo for Hebrew, Roboto Mono for numbers, sans-serif as fallback */
            background-color: var(--background-light);
            color: var(--text-dark);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        body.dark {
            background-color: var(--dark-background-dark);
            color: var(--dark-text-light);
        }
        .container-wrapper {
            max-width: 1500px; /* Even wider container for dashboard */
            margin: 0 auto;
            padding: 2rem;
        }
        .card {
            background-color: var(--surface-light);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 1.5rem;
            transition: all 0.3s ease-in-out;
            border: 1px solid var(--border-light);
        }
        body.dark .card {
            background-color: var(--dark-surface-dark);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            border-color: var(--dark-border-dark);
        }
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
        }

        /* Flight Board Metric Cards Styling */
        .btn-metric {
            @apply flex flex-col items-center justify-center p-6 rounded-xl shadow-lg transition-transform transform hover:scale-105 active:scale-95 text-white font-bold text-center cursor-pointer;
            background: linear-gradient(135deg, var(--primary-brand), var(--secondary-brand));
            min-height: 140px; /* Slightly taller */
            border: none;
            outline: none;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4), /* Deeper shadow */
                        inset 0 0 15px rgba(255, 255, 255, 0.2); /* Inner highlight */
            position: relative;
            overflow: hidden;
            z-index: 1;
            /* Glow effect on hover */
            box-shadow: 0 0 15px var(--glow-color-light);
            transition: all 0.3s ease;
        }
        body.dark .btn-metric {
            background: linear-gradient(135deg, var(--dark-primary-brand), var(--dark-secondary-brand));
            box-shadow: 0 0 15px var(--glow-color-dark);
        }
        .btn-metric:hover {
            box-shadow: 0 0 25px var(--glow-color-light);
            transform: translateY(-5px);
        }
        body.dark .btn-metric:hover {
            box-shadow: 0 0 25px var(--glow-color-dark);
        }

        .metric-value-container {
            perspective: 1000px;
            height: 50px; /* Fixed height for consistent flip */
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .metric-value-flip {
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); /* Bouncy effect */
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .metric-value-front, .metric-value-back {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            backface-visibility: hidden;
            font-size: 2.8rem; /* Large number */
            line-height: 1;
            font-family: 'Roboto Mono', monospace; /* Monospace for numbers */
            color: #fff; /* Base white color */
            text-shadow: 
                0 0 8px #fff,  /* subtle glow */
                0 0 15px #fff, /* stronger glow */
                0 0 25px #fff; /* largest spread */
            animation: none; /* Remove previous glow animation */
        }
        .metric-value-back {
            transform: rotateX(180deg);
        }
        .metric-value-flip.flipped {
            transform: rotateX(-180deg);
        }

        .btn-metric .metric-label {
            font-size: 1.2rem; /* Slightly larger label */
            line-height: 1.3;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
        }

        /* Specific gradient colors for metric buttons */
        .btn-metric.bg-blue { background: linear-gradient(135deg, #3f51b5, #5c6bc0); } /* Indigo */
        .btn-metric.bg-green { background: linear-gradient(135deg, #4caf50, #81c784); } /* Green */
        .btn-metric.bg-purple { background: linear-gradient(135deg, #673ab7, #9575cd); } /* Deep Purple */
        .btn-metric.bg-red { background: linear-gradient(135deg, #f44336, #e57373); } /* Red */
        .btn-metric.bg-yellow-500 { background: linear-gradient(135deg, #ffc107, #ffd54f); } /* Amber */
        .btn-metric.bg-indigo-500 { background: linear-gradient(135deg, #3f51b5, #7986cb); } /* Indigo for returning customers */

        body.dark .btn-metric.bg-blue { background: linear-gradient(135deg, var(--dark-primary-brand), var(--dark-secondary-brand)); }
        body.dark .btn-metric.bg-green { background: linear-gradient(135deg, #66bb6a, #81c784); }
        body.dark .btn-metric.bg-purple { background: linear-gradient(135deg, #7e57c2, #9575cd); }
        body.dark .btn-metric.bg-red { background: linear-gradient(135deg, #e53935, #ef5350); }
        body.dark .btn-metric.bg-yellow-500 { background: linear-gradient(135deg, #ffca28, #ffe082); }
        body.dark .btn-metric.bg-indigo-500 { background: linear-gradient(135deg, var(--dark-primary-brand), var(--dark-secondary-brand)); }


        /* Notification Board Styling - Ticker Effect */
        #notification-board {
            background: linear-gradient(145deg, var(--background-light), var(--surface-light)); /* Light gradient background */
            border-radius: 16px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border-light);
            position: relative;
            overflow: hidden; /* Hide overflow for ticker */
            height: 150px; /* Fixed height for ticker */
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        body.dark #notification-board {
            background: linear-gradient(145deg, var(--dark-background-dark), var(--dark-surface-dark));
            border-color: var(--dark-border-dark);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
        }
        #notification-board h2 {
            color: var(--text-dark); /* Dark red for title */
            margin-bottom: 1rem;
            text-shadow: 0 0 5px rgba(0,0,0,0.1);
        }
        body.dark #notification-board h2 {
            color: var(--dark-text-light);
            text-shadow: 0 0 5px rgba(255,255,255,0.1);
        }

        #notifications-ticker-container {
            flex-grow: 1;
            overflow: hidden;
            position: relative;
        }
        #notifications-list {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            display: flex;
            flex-direction: column;
            transition: transform 0.5s ease-in-out; /* Smooth scrolling */
        }
        .notification-item {
            min-height: 80px; /* Ensure consistent height for scrolling */
            background-color: var(--surface-light); /* White background for each cube */
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            padding: 1rem 1.25rem;
            display: flex;
            align-items: center;
            border: 1px solid var(--border-light);
            transition: all 0.3s ease;
            cursor: pointer; /* Indicate it's clickable */
            position: relative; /* For pin icon positioning */
            color: var(--text-dark);
            margin-bottom: 0.5rem; /* Spacing between items in ticker */
        }
        body.dark .notification-item {
            background-color: var(--dark-surface-dark);
            border-color: var(--dark-border-dark);
            color: var(--dark-text-light);
        }
        /* Specific colors for notification types */
        .notification-item.error { background-color: var(--notification-error); color: white; border-color: var(--notification-error); }
        .notification-item.warning { background-color: var(--notification-warning); color: white; border-color: var(--notification-warning); }
        .notification-item.info { background-color: var(--notification-info); color: white; border-color: var(--notification-info); }

        body.dark .notification-item.error { background-color: var(--dark-notification-error); }
        body.dark .notification-item.warning { background-color: var(--dark-notification-warning); }
        body.dark .notification-item.info { background-color: var(--dark-notification-info); }

        .notification-item.error .notification-icon,
        .notification-item.warning .notification-icon,
        .notification-item.info .notification-icon {
            color: white; /* Icons in notifications are white */
            text-shadow: 0 0 5px rgba(255,255,255,0.5); /* Subtle icon glow */
        }

        .notification-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }
        .notification-item.handled {
            opacity: 0.7; /* Make lighter */
            text-decoration: line-through;
            background-color: var(--background-light); /* Lighter background for handled */
            color: var(--text-medium);
            border-color: var(--border-light);
        }
        body.dark .notification-item.handled {
            background-color: var(--dark-background-dark); /* Darker, less prominent for handled in dark mode */
            color: var(--dark-text-medium);
            border-color: var(--dark-border-dark);
        }
        .notification-item.handled .notification-icon {
            color: var(--text-medium); /* Desaturate icon color */
        }
        body.dark .notification-item.handled .notification-icon {
            color: var(--dark-text-medium);
        }

        .notification-item .pin-icon {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            font-size: 1rem;
            color: var(--text-medium);
            cursor: pointer;
            transition: color 0.2s ease;
        }
        body.dark .notification-item .pin-icon {
            color: var(--dark-text-medium);
        }
        .notification-item .pin-icon:hover {
            color: var(--primary-brand);
        }
        .notification-item.handled .pin-icon {
            color: var(--notification-info); /* Green when handled */
        }
        .notification-icon {
            font-size: 1.8rem; /* Larger icons */
            margin-right: 0.75rem;
            min-width: 1.8rem; /* Prevent text from pushing icon */
            text-align: center;
        }
        .notification-message {
            flex-grow: 1;
            font-size: 1rem;
            line-height: 1.5;
            font-weight: 500; /* Bold text for messages */
            font-family: 'Heebo', sans-serif;
        }

        /* Chart Styling - adapted for Chart.js */
        .chart-container-crm {
            background-color: var(--surface-light);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-light);
            position: relative;
        }
        body.dark .chart-container-crm {
            background-color: var(--dark-surface-dark);
            border-color: var(--dark-border-dark);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        .chart-container-crm h3 {
            font-size: 1.25rem; /* Larger chart titles */
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--text-dark);
        }
        body.dark .chart-container-crm h3 {
            color: var(--dark-text-light);
        }
        .chart-canvas-container {
            width: 100%;
            height: 380px; /* Slightly more height for charts */
            position: relative;
        }
        /* Overrides for Chart.js tooltips etc. to match theme */
        .chartjs-tooltip {
            background: var(--dark-surface-dark) !important;
            color: var(--dark-text-light) !important;
            border: 1px solid var(--dark-border-dark) !important;
            border-radius: 8px !important;
            font-family: 'Heebo', sans-serif !important;
            padding: 8px 12px !important;
            opacity: 1 !important;
        }
        .chartjs-tooltip table {
            margin: 0 !important;
        }
        .chartjs-tooltip-key {
            display: inline-block;
            width: 10px;
            height: 10px;
            margin-right: 5px;
            border-radius: 50%;
        }

        /* DataTables.js Styling */
        .dataTables_wrapper .dataTables_length,
        .dataTables_wrapper .dataTables_filter,
        .dataTables_wrapper .dataTables_info,
        .dataTables_wrapper .dataTables_paginate {
            color: var(--text-medium);
            font-family: 'Heebo', sans-serif;
            margin-top: 1rem;
            margin-bottom: 1rem;
        }
        body.dark .dataTables_wrapper .dataTables_length,
        body.dark .dataTables_wrapper .dataTables_filter,
        body.dark .dataTables_wrapper .dataTables_info,
        body.dark .dataTables_wrapper .dataTables_paginate {
            color: var(--dark-text-medium);
        }

        .dataTables_wrapper .dataTables_filter input {
            background-color: var(--background-light);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            color: var(--text-dark);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
            transition: all 0.2s ease-in-out;
            font-family: 'Heebo', sans-serif;
        }
        body.dark .dataTables_wrapper .dataTables_filter input {
            background-color: var(--dark-surface-dark);
            border-color: var(--dark-border-dark);
            color: var(--dark-text-light);
        }
        .dataTables_wrapper .dataTables_filter input:focus {
            outline: none;
            border-color: var(--primary-brand);
            box-shadow: 0 0 0 2px rgba(var(--primary-brand-rgb), 0.2);
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button {
            background-color: var(--surface-light);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 0.5rem 0.8rem;
            margin: 0 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-dark) !important; /* Override DataTables default */
            font-family: 'Heebo', sans-serif;
        }
        body.dark .dataTables_wrapper .dataTables_paginate .paginate_button {
            background-color: var(--dark-surface-dark);
            border-color: var(--dark-border-dark);
            color: var(--dark-text-light) !important;
        }
        .dataTables_wrapper .dataTables_paginate .paginate_button.current,
        .dataTables_wrapper .dataTables_paginate .paginate_button.current:hover {
            background-color: var(--primary-brand);
            color: white !important;
            border-color: var(--primary-brand);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        body.dark .dataTables_wrapper .dataTables_paginate .paginate_button.current,
        body.dark .dataTables_wrapper .dataTables_paginate .paginate_button.current:hover {
            background-color: var(--dark-primary-brand);
            color: var(--dark-text-dark) !important;
            border-color: var(--dark-primary-brand);
        }
        .dataTables_wrapper .dataTables_paginate .paginate_button:hover:not(.current) {
            background-color: var(--background-light);
            color: var(--primary-brand) !important;
        }
        body.dark .dataTables_wrapper .dataTables_paginate .paginate_button:hover:not(.current) {
            background-color: var(--dark-background-dark);
            color: var(--dark-primary-brand) !important;
        }
        .dataTables_wrapper .dataTables_paginate .paginate_button.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            color: var(--text-medium) !important;
        }
        body.dark .dataTables_wrapper .dataTables_paginate .paginate_button.disabled {
            color: var(--dark-text-medium) !important;
        }
        .dataTables_wrapper .dataTables_length select {
            background-color: var(--surface-light);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            color: var(--text-dark);
            font-family: 'Heebo', sans-serif;
        }
        body.dark .dataTables_wrapper .dataTables_length select {
            background-color: var(--dark-surface-dark);
            border-color: var(--dark-border-dark);
            color: var(--dark-text-light);
        }
        /* Table Styling (reused from style.css but with mobile adaptations) */
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
            background-color: var(--surface-light);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 1.5rem;
            border: 1px solid var(--border-light);
        }
        body.dark .table-container {
            background-color: var(--dark-surface-dark);
            border-color: var(--dark-border-dark);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        table.dataTable { /* Target DataTables specifically */
            width: 100%;
            border-collapse: collapse;
            min-width: 700px; /* Ensure table is still readable horizontally on small screens */
            color: var(--text-dark);
        }
        body.dark table.dataTable {
            color: var(--dark-text-light);
        }
        table.dataTable th, table.dataTable td {
            padding: 0.8rem 1rem;
            text-align: right;
            border-bottom: 1px solid var(--border-light);
            font-size: 1rem;
            font-weight: 500; /* Regular weight for data cells */
            text-shadow: none; /* Remove subtle glow */
            font-family: 'Heebo', sans-serif;
        }
        body.dark table.dataTable th, body.dark table.dataTable td {
            border-color: var(--dark-border-dark);
        }
        table.dataTable thead th {
            background-color: var(--background-light);
            font-weight: 700; /* Ensure header is bold */
            color: var(--text-dark);
            cursor: pointer;
            text-shadow: 0 0 1px rgba(0, 0, 0, 0.1);
        }
        body.dark table.dataTable thead th {
            background-color: var(--dark-background-dark);
            color: var(--dark-text-light);
            text-shadow: 0 0 1px rgba(255, 255, 255, 0.1);
        }
        table.dataTable tr:last-child td {
            border-bottom: none;
        }
        table.dataTable tbody tr:hover {
            background-color: var(--background-light);
        }
        body.dark table.dataTable tbody tr:hover {
            background-color: var(--dark-background-dark);
        }
        /* Styling for DataTables sorting icons */
        table.dataTable thead .sorting,
        table.dataTable thead .sorting_asc,
        table.dataTable thead .sorting_desc,
        table.dataTable thead .sorting_asc_disabled,
        table.dataTable thead .sorting_desc_disabled {
            padding-right: 25px; /* Make space for icon */
            position: relative;
        }
        table.dataTable thead .sorting::before,
        table.dataTable thead .sorting::after,
        table.dataTable thead .sorting_asc::before,
        table.dataTable thead .sorting_asc::after,
        table.dataTable thead .sorting_desc::before,
        table.dataTable thead .sorting_desc::after {
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
            position: absolute;
            bottom: 0.8em;
            right: 0.5em;
            opacity: 0.3;
            font-size: 0.8em;
            color: var(--text-medium);
        }
        body.dark table.dataTable thead .sorting::before,
        body.dark table.dataTable thead .sorting::after,
        body.dark table.dataTable thead .sorting_asc::before,
        body.dark table.dataTable thead .sorting_asc::after,
        body.dark table.dataTable thead .sorting_desc::before,
        body.dark table.dataTable thead .sorting_desc::after {
            color: var(--dark-text-medium);
        }
        table.dataTable thead .sorting::before { content: "\f0d8"; /* up arrow */ }
        table.dataTable thead .sorting::after { content: "\f0d7"; /* down arrow */ }
        table.dataTable thead .sorting_asc::before { content: "\f0d8"; opacity: 1; }
        table.dataTable thead .sorting_asc::after { content: "\f0d7"; display: none; }
        table.dataTable thead .sorting_desc::before { content: "\f0d8"; display: none; }
        table.dataTable thead .sorting_desc::after { content: "\f0d7"; opacity: 1; }

        /* Other common styles */
        .whatsapp-share-btn {
            @apply inline-flex items-center justify-center px-4 py-2 bg-green-600 text-white rounded-md shadow hover:bg-green-700 transition-colors text-sm font-medium;
        }
        .btn-secondary {
            @apply inline-flex items-center justify-center px-4 py-2 bg-gray-200 text-gray-700 rounded-md shadow hover:bg-gray-300 transition-colors text-sm font-medium;
        }
        body.dark .btn-secondary {
            @apply bg-gray-600 text-gray-200 hover:bg-gray-700;
        }
        .modal-content {
            background-color: var(--surface-light);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.25);
            max-width: 600px;
            width: 90%;
            position: relative;
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            max-height: 90vh; /* Limit modal height */
            overflow-y: auto; /* Enable scrolling for modal content */
        }
        body.dark .modal-content {
            background-color: var(--dark-surface-dark);
        }
        .modal-overlay.active .modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        .modal-full-width {
            max-width: 90%; /* Wider for tables/charts */
        }
        /* Mobile Drawer for modals */
        .modal-overlay.mobile-drawer .modal-content {
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            max-width: 100%;
            border-radius: 0;
            padding: 1.5rem;
            transform: translateX(100%);
            opacity: 1;
            transition: transform 0.3s ease;
        }
        .modal-overlay.active.mobile-drawer .modal-content {
            transform: translateX(0);
        }
        .container-pill {
            @apply inline-block bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded-full dark:bg-blue-900 dark:text-blue-200 cursor-pointer transition-colors hover:bg-blue-200 dark:hover:bg-blue-800;
            margin-left: 0.25rem;
            margin-bottom: 0.25rem;
        }

        /* WhatsApp Button Styling */
        .whatsapp-btn-icon {
            @apply text-green-500 hover:text-green-600 transition-colors cursor-pointer mr-2; /* Adjusted margin-right to mr-2 */
            font-size: 1.5rem; /* Larger icon */
        }
        
        /* Loader */
        .loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .loader-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .loader {
            border: 8px solid #f3f3f3;
            border-top: 8px solid var(--primary-brand);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        body.dark .loader {
            border-top: 8px solid var(--dark-primary-brand);
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Alert (Toast) Container */
        #alert-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 350px;
        }
        .alert-item {
            background-color: var(--surface-light);
            color: var(--text-dark);
            padding: 1rem 1.2rem;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            opacity: 1;
            transform: translateX(0);
            transition: opacity 0.3s ease, transform 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            border: 1px solid var(--border-light);
        }
        body.dark .alert-item {
            background-color: var(--dark-surface-dark);
            color: var(--dark-text-light);
            border-color: var(--dark-border-dark);
        }
        .alert-item.alert-success { border-left: 5px solid #28a745; }
        .alert-item.alert-error { border-left: 5px solid #dc3545; }
        .alert-item.alert-warning { border-left: 5px solid #ffc107; }
        .alert-item.alert-info { border-left: 5px solid #17a2b8; }

        .close-alert-btn {
            background: none;
            border: none;
            color: var(--text-medium);
            font-size: 1rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        body.dark .close-alert-btn {
            color: var(--dark-text-medium);
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Loader Spinner -->
    <div id="loader-overlay" class="loader-overlay hidden active">
        <div class="loader"></div>
    </div>

    <!-- Container for Alerts (Toasts) -->
    <div id="alert-container" aria-live="polite" aria-atomic="true"></div>

    <!-- Modals (reused from index.html/index2.html for consistency, if needed for detailed views) -->
    <!-- This CRM page primarily focuses on reports and dashboard, so most modals might be for details/history -->
    <!-- The structure is assumed to follow the existing modal pattern for consistency -->
    <!-- Order Details Modal -->
    <div id="order-details-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="details-modal-title">
        <div class="modal-content modal-full-width">
            <button class="modal-close-btn" onclick="closeOrderDetailsModal()" aria-label="סגור חלון"><i class="fas fa-times"></i></button>
            <h2 id="details-modal-title" class="text-2xl font-bold mb-6 text-center text-gray-700 dark:text-gray-200">פרטי הזמנה</h2>
            <div class="modal-body">
                <div id="current-order-card" class="order-card-detail">
                    <!-- Current order details will be loaded here -->
                </div>
            </div>
            <div class="flex justify-end mt-4">
                <button class="btn btn-secondary" onclick="closeOrderDetailsModal()" aria-label="סגור">סגור</button>
            </div>
        </div>
    </div>

    <!-- Container History Modal (for container details from reports) -->
    <div id="container-history-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="container-history-modal-title">
        <div class="modal-content modal-full-width">
            <button class="modal-close-btn" onclick="closeContainerHistoryModal()" aria-label="סגור חלון"><i class="fas fa-times"></i></button>
            <h2 id="container-history-modal-title" class="text-2xl font-bold mb-6 text-center text-gray-700 dark:text-gray-200">היסטוריית מכולה: <span id="history-container-number"></span></h2>
            <div class="modal-body table-container">
                <table id="container-history-table" class="min-w-full">
                    <thead>
                        <tr>
                            <th>תאריך הזמנה</th>
                            <th>תעודה</th>
                            <th>שם לקוח</th>
                            <th>סוג פעולה</th>
                            <th>מספר מכולה ירדה</th>
                            <th>מספר מכולה עלתה</th>
                            <th>סטטוס הזמנה</th>
                            <th>תאריך סיום צפוי</th>
                            <th>WhatsApp</th> <!-- New Column -->
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
                <p id="no-container-history" class="text-center text-gray-500 mt-4 hidden">אין היסטוריית שינויים עבור מכולה זו.</p>
            </div>
            <div class="flex justify-end mt-4">
                <button class="btn btn-secondary" onclick="closeContainerHistoryModal()" aria-label="סגור">סגור</button>
            </div>
        </div>
    </div>

    <!-- Top Moving Containers Modal -->
    <div id="top-moving-containers-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="top-moving-containers-title">
        <div class="modal-content modal-full-width">
            <button class="modal-close-btn" onclick="closeTopMovingContainersModal()" aria-label="סגור חלון"><i class="fas fa-times"></i></button>
            <h2 id="top-moving-containers-title" class="text-2xl font-bold mb-6 text-center text-gray-700 dark:text-gray-200">מכולות מובילות בתזוזה</h2>
            <div class="flex justify-end gap-3 mb-4"> <!-- Added for print button -->
                <button class="btn btn-secondary" onclick="printReport('top-moving-containers-table')">
                    <i class="fas fa-print ml-2"></i> הדפס
                </button>
            </div>
            <div class="modal-body table-container">
                <table id="top-moving-containers-table" class="min-w-full">
                    <thead>
                        <tr>
                            <th>מכולה</th>
                            <th>מספר תזוזות</th>
                            <th>הצג היסטוריה</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
                <p id="no-top-moving-containers" class="text-center text-gray-500 mt-4 hidden">אין מכולות עם תזוזות רבות כרגע.</p>
            </div>
            <div class="flex justify-end mt-4">
                <button class="btn btn-secondary" onclick="closeTopMovingContainersModal()" aria-label="סגור">סגור</button>
            </div>
        </div>
    </div>

    <!-- Returning Customers Modal -->
    <div id="returning-customers-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="returning-customers-title">
        <div class="modal-content modal-full-width">
            <button class="modal-close-btn" onclick="closeReturningCustomersModal()" aria-label="סגור חלון"><i class="fas fa-times"></i></button>
            <h2 id="returning-customers-title" class="text-2xl font-bold mb-6 text-center text-gray-700 dark:text-gray-200">לקוחות חוזרים (בעלי הזמנות רבות)</h2>
            <div class="flex justify-end gap-3 mb-4"> <!-- Added for print button -->
                <button class="btn btn-secondary" onclick="printReport('returning-customers-table')">
                    <i class="fas fa-print ml-2"></i> הדפס
                </button>
            </div>
            <div class="modal-body table-container">
                <table id="returning-customers-table" class="min-w-full">
                    <thead>
                        <tr>
                            <th>שם לקוח</th>
                            <th>כתובת</th>
                            <th>כמות הזמנות</th>
                            <th>מכולות פעילות</th>
                            <th>היסטוריה חריגה</th>
                            <th>WhatsApp</th> <!-- New Column -->
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
                <p id="no-returning-customers" class="text-center text-gray-500 mt-4 hidden">אין לקוחות חוזרים כרגע.</p>
            </div>
            <div class="flex justify-end mt-4">
                <button class="btn btn-secondary" onclick="closeReturningCustomersModal()" aria-label="סגור">סגור</button>
            </div>
        </div>
    </div>

    <!-- WhatsApp Message Modal -->
    <div id="whatsapp-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="whatsapp-modal-title">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeWhatsAppModal()" aria-label="סגור חלון"><i class="fas fa-times"></i></button>
            <h2 id="whatsapp-modal-title" class="text-2xl font-bold mb-6 text-center text-gray-700 dark:text-gray-200">
                <i class="fab fa-whatsapp text-green-500 ml-2"></i> שליחת הודעת WhatsApp
            </h2>
            <div class="mb-4">
                <label for="whatsapp-phone-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">מספר טלפון (פורמט בינלאומי ללא +):</label>
                <input type="tel" id="whatsapp-phone-input" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent text-center text-lg font-bold tracking-wider dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100" placeholder="דוגמה: 972501234567">
            </div>

            <div class="mb-4">
                <div class="message-option-header" onclick="toggleMessageOptions()">
                    <label class="font-semibold text-lg cursor-pointer">בחר הודעה מובנית:</label>
                    <i class="fas fa-chevron-down transform transition-transform duration-200"></i>
                </div>
                <div id="whatsapp-message-options" class="message-option-list-container">
                    <input type="text" id="message-filter-input" class="w-full p-2 border-b border-gray-200 dark:border-gray-600 focus:outline-none focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100" placeholder="חפש הודעה..." onkeyup="filterMessageOptions()">
                    <div id="message-options-list" class="py-2">
                        <!-- Message options will be populated here by JS -->
                    </div>
                </div>
            </div>

            <div class="mb-4">
                <label for="whatsapp-message-textarea" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">תוכן ההודעה:</label>
                <div class="typing-effect-container">
                    <span id="typing-effect-display"></span><span class="typing-effect-cursor"></span>
                </div>
                <textarea id="whatsapp-message-textarea" class="w-full text-base font-medium" rows="6"></textarea>
            </div>

            <input type="hidden" id="whatsapp-current-order-sheet-row">

            <div class="flex justify-end gap-3 mt-6">
                <button class="btn btn-secondary" onclick="closeWhatsAppModal()">ביטול</button>
                <button class="whatsapp-share-btn" onclick="sendWhatsAppMessage()">
                    <i class="fab fa-whatsapp ml-2"></i> שלח הודעה
                </button>
            </div>
        </div>
    </div>


    <!-- Main CRM Dashboard Structure -->
    <div class="min-h-screen flex flex-col container-wrapper">
        <header class="mb-8 text-center flex flex-col items-center justify-center">
            <div class="flex items-center justify-center mb-4">
                <img src="https://i.postimg.cc/jqBVzJsq/1.png" alt="Company Logo" class="h-20 w-20 rounded-full shadow-lg border-2 border-purple-350 mr-4" aria-label="לוגו החברה">
                <h1 class="text-4xl font-extrabold text-gray-900 dark:text-gray-100 m-0">לוח בקרה למנהל CRM</h1>
            </div>
            <p class="text-lg text-gray-600 dark:text-gray-300 mb-2">תובנות עמוקות וניהול חכם של המערכת</p>
            <div class="text-sm text-gray-500 dark:text-gray-400 font-mono tracking-wide">
                <span id="current-date-crm" class="mr-2 text-purple-600 font-semibold"></span> |
                <span id="current-time-crm" class="ml-2 text-blue-600 font-semibold animate-pulse"></span>
            </div>
            <!-- Dark/Light Mode Toggle (re-used from style.css) -->
            <button id="theme-toggle-crm" class="mt-4 px-4 py-2 rounded-full bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-200 transition-colors flex items-center gap-2" aria-label="החלף מצב כהה/בהיר">
                <i class="fas fa-sun" id="sun-icon-crm"></i><i class="fas fa-moon hidden" id="moon-icon-crm"></i>
                <span>מצב בהיר</span>
            </button>
        </header>

        <!-- Notification Board with Ticker Effect -->
        <section id="notification-board" class="mb-8">
            <h2 class="text-2xl font-bold mb-4 text-center">
                <i class="fas fa-bullhorn ml-2"></i> לוח מודעות והתראות קריטיות
            </h2>
            <div id="notifications-ticker-container">
                <div id="notifications-list">
                    <!-- Notifications will be loaded here by JavaScript -->
                </div>
            </div>
            <p id="no-notifications-msg" class="text-center text-gray-500 dark:text-gray-400 mt-4 hidden">אין התראות חדשות. כל הכבוד! 🎉</p>
        </section>
        <hr class="my-8 border-gray-200 dark:border-gray-700">
        
        <!-- Order Status Filter -->
        <div class="flex justify-center mb-6">
            <div class="bg-white dark:bg-gray-700 rounded-lg shadow-md p-4 flex items-center gap-4">
                <label for="order-status-filter" class="text-lg font-semibold text-gray-700 dark:text-gray-200">
                    <i class="fas fa-filter ml-2"></i> סנן לפי סטטוס הזמנה:
                </label>
                <select id="order-status-filter" onchange="applyOrderStatusFilter()" 
                        class="px-4 py-2 border border-gray-300 rounded-md bg-white dark:bg-gray-800 dark:text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="all">כל ההזמנות</option>
                    <option value="open">פתוח</option>
                    <option value="closed">סגור</option>
                    <option value="overdue">חורג</option>
                </select>
            </div>
        </div>

        <!-- Flight Board Style Report Buttons -->
        <section id="report-buttons" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <button class="btn-metric bg-blue" onclick="showReportTable('orders-per-customer-table')">
                <span class="metric-value-container">
                    <div class="metric-value-flip" id="total-orders-count-flip">
                        <span class="metric-value-front" id="total-orders-count">0</span>
                        <span class="metric-value-back">0</span>
                    </div>
                </span>
                <span class="metric-label">סה"כ הזמנות</span>
            </button>
            <button class="btn-metric bg-green" onclick="showReportTable('action-type-counts-table')">
                <span class="metric-value-container">
                    <div class="metric-value-flip" id="unique-action-types-count-flip">
                        <span class="metric-value-front" id="unique-action-types-count">0</span>
                        <span class="metric-value-back">0</span>
                    </div>
                </span>
                <span class="metric-label">סוגי פעולות ייחודיים</span>
            </button>
            <button class="btn-metric bg-purple" onclick="showReportTable('customers-multiple-containers-table')">
                <span class="metric-value-container">
                    <div class="metric-value-flip" id="customers-multiple-count-flip">
                        <span class="metric-value-front" id="customers-multiple-count">0</span>
                        <span class="metric-value-back">0</span>
                    </div>
                </span>
                <span class="metric-label">לקוחות עם מכולות מרובות</span>
            </button>
            <button class="btn-metric bg-red" onclick="showReportTable('overdue-summary-table')">
                <span class="metric-value-container">
                    <div class="metric-value-flip" id="overdue-orders-display-count-flip">
                        <span class="metric-value-front" id="overdue-orders-display-count">0</span>
                        <span class="metric-value-back">0</span>
                    </div>
                </span>
                <span class="metric-label">הזמנות חורגות בטיפול</span>
            </button>
        </section>

        <!-- New Custom Report Buttons -->
        <section id="custom-report-buttons" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <button class="btn-metric bg-yellow-500" onclick="openTopMovingContainersModal()">
                <span class="metric-value-container">
                     <div class="metric-value-flip" id="top-moving-container-display-flip">
                        <span class="metric-value-front" id="top-moving-container-display">
                            📦 <span id="top-moving-container-number">אין</span> (<span id="top-moving-container-count">0</span>)
                        </span>
                        <span class="metric-value-back">
                            📦 <span id="top-moving-container-number-back">אין</span> (<span id="top-moving-container-count-back">0</span>)
                        </span>
                    </div>
                </span>
                <span class="metric-label">מספר מכולה מוביל בתזוזה</span>
            </button>
            <button class="btn-metric bg-indigo-500" onclick="openReturningCustomersModal()">
                <span class="metric-value-container">
                    <div class="metric-value-flip" id="returning-customers-display-flip">
                        <span class="metric-value-front" id="returning-customers-display">
                            <i class="fas fa-redo-alt"></i> <span id="returning-customers-count">0</span>
                        </span>
                        <span class="metric-value-back">
                            <i class="fas fa-redo-alt"></i> <span id="returning-customers-count-back">0</span>
                        </span>
                    </div>
                </span>
                <span class="metric-label">לקוחות חוזרים</span>
            </button>
        </section>
        <hr class="my-8 border-gray-200 dark:border-gray-700">

        <!-- Charts Section -->
        <section id="charts-section" class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div id="chart-orders-per-customer" class="chart-container-crm">
                <h3>כמות הזמנות לכל לקוח (הכי פעילים)</h3>
                <div class="chart-canvas-container">
                    <canvas id="canvas-orders-per-customer"></canvas>
                </div>
                <p id="no-data-orders-per-customer" class="text-center text-gray-500 dark:text-gray-400 hidden">אין נתונים להצגה.</p>
            </div>
            <div id="chart-action-type-distribution" class="chart-container-crm">
                <h3>חלוקת סוגי פעולות</h3>
                <div class="chart-canvas-container">
                    <canvas id="canvas-action-type-distribution"></canvas>
                </div>
                <p id="no-data-action-type" class="text-center text-gray-500 dark:text-gray-400 hidden">אין נתונים להצגה.</p>
            </div>
            <div id="chart-monthly-orders" class="chart-container-crm">
                <h3>הזמנות לפי חודש</h3>
                <div class="chart-canvas-container">
                    <canvas id="canvas-monthly-orders"></canvas>
                </div>
                <p id="no-data-monthly-orders" class="text-center text-gray-500 dark:text-gray-400 hidden">אין נתונים להצגה.</p>
            </div>
            <!-- New Chart: Overdue Trend Chart -->
            <div id="chart-overdue-trend" class="chart-container-crm">
                <h3>מגמת הזמנות חורגות</h3>
                <div class="chart-canvas-container">
                    <canvas id="canvas-overdue-trend"></canvas>
                </div>
                <p id="no-data-overdue-trend" class="text-center text-gray-500 dark:text-gray-400 hidden">אין נתונים להצגה.</p>
            </div>
        </section>
        <hr class="my-8 border-gray-200 dark:border-gray-700">

        <!-- Reports & Tables Section -->
        <section id="reports-tables-section" class="space-y-8">
            <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-gray-100 text-center">
                <i class="fas fa-file-invoice-dollar text-green-500 ml-2"></i> דוחות מפורטים
            </h2>

            <!-- Orders Per Customer Table -->
            <div id="orders-per-customer-table" class="report-table-section card p-6 hidden">
                <h3 class="text-xl font-bold mb-4 text-gray-700 dark:text-gray-200">
                    <i class="fas fa-users-cog ml-2"></i> דוח: כמות הזמנות לכל לקוח
                </h3>
                <div class="flex justify-end gap-3 mb-4">
                    <button class="whatsapp-share-btn" onclick="shareReportToWhatsApp('orders-per-customer-table')">
                        <i class="fab fa-whatsapp ml-2"></i> שתף לווצאפ
                    </button>
                    <button class="btn btn-secondary" onclick="exportTableToExcel('orders-per-customer-table-data', 'orders_per_customer')">
                        <i class="fas fa-file-excel ml-2"></i> יצא לאקסל
                    </button>
                    <button class="btn btn-secondary" onclick="printReport('orders-per-customer-table')"> <!-- Updated print call -->
                        <i class="fas fa-print ml-2"></i> הדפס
                    </button>
                </div>
                <div class="table-container">
                    <table id="orders-per-customer-table-data" class="min-w-full display compact">
                        <thead>
                            <tr>
                                <th>שם לקוח</th>
                                <th>כתובת</th>
                                <th>כמות הזמנות</th>
                                <th>כמות מכולות פעילות</th>
                                <th>WhatsApp</th> <!-- New Column -->
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be loaded here by JS and DataTables -->
                        </tbody>
                    </table>
                </div>
                <p id="no-data-orders-per-customer-table" class="text-center text-gray-500 dark:text-gray-400 mt-4 hidden">אין נתונים להצגה.</p>
            </div>

            <!-- Action Type Counts Table -->
            <div id="action-type-counts-table" class="report-table-section card p-6 hidden">
                <h3 class="text-xl font-bold mb-4 text-gray-700 dark:text-gray-200">
                    <i class="fas fa-cogs ml-2"></i> דוח: כמות סוגי פעולות
                </h3>
                <div class="flex justify-end gap-3 mb-4">
                    <button class="whatsapp-share-btn" onclick="shareReportToWhatsApp('action-type-counts-table')">
                        <i class="fab fa-whatsapp ml-2"></i> שתף לווצאפ
                    </button>
                    <button class="btn btn-secondary" onclick="exportTableToExcel('action-type-counts-table-data', 'action_type_counts')">
                        <i class="fas fa-file-excel ml-2"></i> יצא לאקסל
                    </button>
                    <button class="btn btn-secondary" onclick="printReport('action-type-counts-table')"> <!-- Updated print call -->
                        <i class="fas fa-print ml-2"></i> הדפס
                    </button>
                </div>
                <div class="table-container">
                    <table id="action-type-counts-table-data" class="min-w-full display compact">
                        <thead>
                            <tr>
                                <th>סוג פעולה</th>
                                <th>כמות</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be loaded here by JS and DataTables -->
                        </tbody>
                    </table>
                </div>
                 <p id="no-data-action-type-table" class="text-center text-gray-500 dark:text-gray-400 mt-4 hidden">אין נתונים להצגה.</p>
            </div>

            <!-- Customers with Multiple Containers Table -->
            <div id="customers-multiple-containers-table" class="report-table-section card p-6 hidden">
                <h3 class="text-xl font-bold mb-4 text-gray-700 dark:text-gray-200">
                    <i class="fas fa-cubes ml-2"></i> דוח: לקוחות עם יותר ממכולה אחת
                </h3>
                <div class="flex justify-end gap-3 mb-4">
                    <button class="whatsapp-share-btn" onclick="shareReportToWhatsApp('customers-multiple-containers-table')">
                        <i class="fab fa-whatsapp ml-2"></i> שתף לווצאפ
                    </button>
                    <button class="btn btn-secondary" onclick="exportTableToExcel('customers-multiple-containers-table-data', 'customers_multiple_containers')">
                        <i class="fas fa-file-excel ml-2"></i> יצא לאקסל
                    </button>
                    <button class="btn btn-secondary" onclick="printReport('customers-multiple-containers-table')"> <!-- Updated print call -->
                        <i class="fas fa-print ml-2"></i> הדפס
                    </button>
                </div>
                <div class="table-container">
                    <table id="customers-multiple-containers-table-data" class="min-w-full display compact">
                        <thead>
                            <tr>
                                <th>שם לקוח</th>
                                <th>כתובת</th>
                                <th>כמות מכולות פעילות</th>
                                <th>מספרי מכולות</th>
                                <th>WhatsApp</th> <!-- New Column -->
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be loaded here by JS and DataTables -->
                        </tbody>
                    </table>
                </div>
                <p id="no-data-customers-multiple-containers-table" class="text-center text-gray-500 dark:text-gray-400 mt-4 hidden">אין נתונים להצגה.</p>
            </div>

             <!-- Overdue Summary Table (Detailed view for the button) -->
            <div id="overdue-summary-table" class="report-table-section card p-6 hidden">
                <h3 class="text-xl font-bold mb-4 text-gray-700 dark:text-gray-200">
                    <i class="fas fa-calendar-times ml-2"></i> דוח: סיכום הזמנות חורגות
                </h3>
                <div class="flex justify-end gap-3 mb-4">
                    <button class="whatsapp-share-btn" onclick="shareReportToWhatsApp('overdue-summary-table')">
                        <i class="fab fa-whatsapp ml-2"></i> שתף לווצאפ
                    </button>
                    <button class="btn btn-secondary" onclick="exportTableToExcel('overdue-summary-table-data', 'overdue_orders_summary')">
                        <i class="fas fa-file-excel ml-2"></i> יצא לאקסל
                    </button>
                    <button class="btn btn-secondary" onclick="printReport('overdue-summary-table')"> <!-- Updated print call -->
                        <i class="fas fa-print ml-2"></i> הדפס
                    </button>
                </div>
                <div class="table-container">
                    <table id="overdue-summary-table-data" class="min-w-full display compact">
                        <thead>
                            <tr>
                                <th>תעודה</th>
                                <th>שם לקוח</th>
                                <th>כתובת</th>
                                <th>סוג פעולה</th>
                                <th>ימים שעברו</th>
                                <th>מכולות קשורות</th>
                                <th>הערות</th>
                                <th>WhatsApp</th> <!-- New Column -->
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be loaded here by JS and DataTables -->
                        </tbody>
                    </table>
                </div>
                <p id="no-data-overdue-summary-table" class="text-center text-gray-500 dark:text-gray-400 mt-4 hidden">אין נתונים להצגה.</p>
            </div>


        </section>

        <footer class="mt-12 text-center text-gray-500 dark:text-gray-400 text-sm">
            <p>&copy; 2025 מערכת CRM למכולות. כל הזכויות שמורות.</p>
        </footer>
    </div>

    <!-- Floating Back to Top Button -->
    <button id="back-to-top-btn" title="חזרה למעלה">
        <i class="fas fa-arrow-up"></i>
    </button>


    <script>
        // Define Google Apps Script URL (replace with your actual deployment URL)
        const SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxiS3wXwXCyh8xM1EdTiwXy0T-UyBRQgfrnRRis531lTxmgtJIGawfsPeetX5nVJW3V/exec'; 

        let allOrders = []; // Raw data of all orders (unfiltered)
        let filteredOrders = []; // Data filtered by selected status
        let notifications = []; // Store active notifications
        let currentOrderFilter = 'all'; // Default filter: 'all', 'open', 'closed', 'overdue'

        const WHATSAPP_PHONE_NUMBER = '972508860896'; // WhatsApp number for main shares, not for individual customers

        // Chart.js instances
        let ordersPerCustomerChartInstance;
        let actionTypeDistributionChartInstance;
        let monthlyOrdersChartInstance;
        let overdueTrendChartInstance;

        // DataTables instances
        let ordersPerCustomerDataTable;
        let actionTypeCountsDataTable;
        let customersMultipleContainersDataTable;
        let overdueSummaryDataTable;
        let containerHistoryDataTable;
        let topMovingContainersDataTable;
        let returningCustomersDataTable;


        // Utility Functions
        function showLoader() { document.getElementById('loader-overlay').classList.add('active'); }
        function hideLoader() { document.getElementById('loader-overlay').classList.remove('active'); }

        /**
         * Determines if the current device is mobile based on screen width.
         * @returns {boolean} True if mobile, false if desktop.
         */
        function isMobile() {
            return window.innerWidth <= 768; // Tailwind's 'md' breakpoint
        }

        /**
         * Toggles between Dark Mode and Light Mode for this specific page.
         */
        function toggleThemeCrm() {
            const isDarkMode = document.body.classList.toggle('dark');
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
            updateThemeToggleButtonCrm(isDarkMode);
            // Re-draw charts when theme changes
            drawCharts();
            // Re-initialize DataTables to apply theme-specific styling (if any)
            initializeDataTables();
        }

        /**
         * Updates the theme toggle button icon and text for this page.
         * @param {boolean} isDarkMode - True if dark mode is active, false otherwise.
         */
        function updateThemeToggleButtonCrm(isDarkMode) {
            const themeToggle = document.getElementById('theme-toggle-crm');
            const sunIcon = document.getElementById('sun-icon-crm');
            const moonIcon = document.getElementById('moon-icon-crm');

            if (isDarkMode) {
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
                themeToggle.querySelector('span').textContent = 'מצב כהה';
                themeToggle.setAttribute('aria-label', 'החלף למצב בהיר');
            } else {
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
                themeToggle.querySelector('span').textContent = 'מצב בהיר';
                themeToggle.setAttribute('aria-label', 'החלף למצב כהה');
            }
        }

        /**
         * Initializes the theme based on system preferences or local storage for this page.
         */
        function initializeThemeCrm() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            if (savedTheme === 'dark' || (savedTheme === null && prefersDark)) {
                document.body.classList.add('dark');
                updateThemeToggleButtonCrm(true);
            } else {
                document.body.classList.remove('dark');
                updateThemeToggleButtonCrm(false);
            }

            document.getElementById('theme-toggle-crm').addEventListener('click', toggleThemeCrm);
        }

        /**
         * Displays a toast notification.
         * @param {string} message - The message to display.
         * @param {'success'|'error'|'warning'|'info'} type - Type of notification.
         * @param {number} duration - Duration in milliseconds (default 5000).
         */
        function showAlert(message, type = 'info', duration = 5000) {
            const container = document.getElementById('alert-container');
            const alertItem = document.createElement('div');
            alertItem.className = `alert-item alert-${type} flex items-center gap-2`;
            alertItem.setAttribute('role', 'alert');
            alertItem.innerHTML = `
                ${type === 'success' ? '<i class="fas fa-check-circle text-green-600" aria-hidden="true"></i>' : ''}
                ${type === 'error' ? '<i class="fas fa-times-circle text-red-600" aria-hidden="true"></i>' : ''}
                ${type === 'warning' ? '<i class="fas fa-exclamation-triangle text-orange-600" aria-hidden="true"></i>' : ''}
                ${type === 'info' ? '<i class="fas fa-info-circle text-blue-600" aria-hidden="true"></i>' : ''}
                <p class="text-sm font-medium text-gray-800 flex-grow">${message}</p>
                <button class="close-alert-btn" onclick="this.closest('.alert-item').remove()" aria-label="סגור התראה"><i class="fas fa-times" aria-hidden="true"></i></button>
            `;
            container.appendChild(alertItem);

            setTimeout(() => {
                alertItem.style.opacity = '0';
                alertItem.style.transform = 'translateX(-100%)';
                setTimeout(() => alertItem.remove(), 300);
            }, duration);
        }

        /**
         * Sends a Fetch request to Google Apps Script with retry logic.
         * @param {string} action The action to perform in the script.
         * @param {Object} params Additional parameters for the request.
         * @param {number} retries Current retry attempt (default 0).
         * @returns {Promise<Object>} Response object from the server.
         */
        async function fetchData(action, params = {}, retries = 0) {
            showLoader();
            const urlParams = new URLSearchParams({ action, ...params });
            const url = `${SCRIPT_WEB_APP_URL}?${urlParams.toString()}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                hideLoader();
                if (!data.success) {
                    if (data.message && data.message.includes('Service invoked too many times')) {
                        const delay = Math.pow(2, retries) * 1000;
                        console.warn(`API rate limit hit. Retrying in ${delay / 1000} seconds... (attempt ${retries + 1})`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        if (retries < 5) {
                            return fetchData(action, params, retries + 1);
                        } else {
                            showAlert('הגענו למגבלת הקריאות לשרת. אנא נסה שוב מאוחר יותר.', 'error');
                        }
                    } else {
                        showAlert(data.message || 'שגיאה בביצוע הפעולה.', 'error');
                    }
                }
                return data;
            } catch (error) {
                hideLoader();
                console.error('Fetch error:', error);
                showAlert('שגיאה בתקשורת עם השרת: ' + error.message, 'error');
                return { success: false, message: 'שגיאה בתקשורת עם השרת: ' + error.message };
            }
        }

        /**
         * Loads all orders from the sheet and updates all UI components.
         * This function now loads all data and then applies the filter.
         */
        async function loadAllData() {
            const response = await fetchData('list', { status: 'all' });
            if (response.success) {
                allOrders = response.data; // Keep all orders in `allOrders`
                applyOrderStatusFilter(); // Apply initial filter and render
            }
        }

        /**
         * Applies the selected order status filter and updates all UI elements.
         */
        function applyOrderStatusFilter() {
            currentOrderFilter = document.getElementById('order-status-filter').value;
            console.log(`Applying filter: ${currentOrderFilter}`);
            
            if (currentOrderFilter === 'all') {
                filteredOrders = [...allOrders];
            } else if (currentOrderFilter === 'open') {
                // 'פתוח' and 'ממתין/לא תקין' are considered open
                filteredOrders = allOrders.filter(o => o['סטטוס'] === 'פתוח' || o['סטטוס'] === 'ממתין/לא תקין');
            } else if (currentOrderFilter === 'closed') {
                filteredOrders = allOrders.filter(o => o['סטטוס'] === 'סגור');
            } else if (currentOrderFilter === 'overdue') {
                filteredOrders = allOrders.filter(o => o['סטטוס'] === 'חורג');
            }

            processDataForDashboard();
            updateReportButtons();
            drawCharts();
            generateAndRenderNotifications(); // Re-render notifications based on new filter
            // Hide all report tables initially after filter change, user can click to reveal
            document.querySelectorAll('.report-table-section').forEach(section => section.classList.add('hidden'));
        }

        /**
         * Animates a metric value with a flip effect.
         * @param {HTMLElement} flipContainer - The .metric-value-flip element.
         * @param {string|number} newValue - The new value to display.
         */
        function animateMetricFlip(flipContainer, newValue) {
            const frontSpan = flipContainer.querySelector('.metric-value-front');
            const backSpan = flipContainer.querySelector('.metric-value-back');

            // Set the back face to the new value before flipping
            backSpan.textContent = newValue;

            // Add 'flipped' class to start the animation
            flipContainer.classList.add('flipped');

            // After half the animation, swap content and remove 'flipped' class
            setTimeout(() => {
                frontSpan.textContent = newValue;
                flipContainer.classList.remove('flipped');
            }, 300); // Half of the transition duration
        }


        /**
         * Processes data to populate dashboard metrics based on filtered orders.
         */
        function processDataForDashboard() {
            // Updated to use animateMetricFlip
            animateMetricFlip(document.getElementById('total-orders-count-flip'), filteredOrders.length);
            
            const actionTypes = new Set(filteredOrders.map(order => order['סוג פעולה']).filter(Boolean));
            animateMetricFlip(document.getElementById('unique-action-types-count-flip'), actionTypes.size);

            const customersWithMultipleContainersCount = calculateCustomersWithMultipleContainers(filteredOrders).length;
            animateMetricFlip(document.getElementById('customers-multiple-count-flip'), customersWithMultipleContainersCount);

            const overdueOrdersCount = allOrders.filter(o => o['סטטוס'] === 'חורג').length; // Always show total overdue count regardless of filter
            animateMetricFlip(document.getElementById('overdue-orders-display-count-flip'), overdueOrdersCount);

            const topContainer = getTopMovingContainer(filteredOrders);
            const topMovingContainerFlip = document.getElementById('top-moving-container-display-flip');
            topMovingContainerFlip.querySelector('#top-moving-container-number-back').textContent = topContainer.container || 'אין';
            topMovingContainerFlip.querySelector('#top-moving-container-count-back').textContent = topContainer.count;
            animateMetricFlip(topMovingContainerFlip, `📦 ${topContainer.container || 'אין'} (${topContainer.count})`);

            const returningCustomersCount = getReturningCustomers(filteredOrders).length;
            const returningCustomersFlip = document.getElementById('returning-customers-display-flip');
            returningCustomersFlip.querySelector('#returning-customers-count-back').textContent = returningCustomersCount;
            animateMetricFlip(returningCustomersFlip, `<i class="fas fa-redo-alt"></i> ${returningCustomersCount}`);
        }

        /**
         * Formats date for display.
         * @param {Date|string} dateInput Date or date string.
         * @returns {string} Date in DD/MM/YYYY format.
         */
        function formatDate(dateInput) {
            if (!dateInput) return '';
            const date = new Date(dateInput);
            if (isNaN(date.getTime())) return dateInput;
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        /**
         * Formats a date and time string for display.
         * @param {string} dateTimeString - Date and time in YYYY-MM-DDTHH:mm format.
         * @returns {string} Formatted date and time.
         */
        function formatDateTime(dateTimeString) {
            if (!dateTimeString) return '';
            const date = new Date(dateTimeString);
            if (isNaN(date.getTime())) return dateTimeString;
            const options = { year: 'numeric', month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            return date.toLocaleString('he-IL', options);
        }

        /**
         * Updates current date and time in the header.
         */
        function updateDateTimeCrm() {
            const now = new Date();
            const dateOptions = { year: 'numeric', month: 'long', day: 'numeric' };
            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };

            document.getElementById('current-date-crm').textContent = now.toLocaleDateString('he-IL', dateOptions);
            document.getElementById('current-time-crm').textContent = now.toLocaleTimeString('he-IL', timeOptions);
        }

        // --- Notifications Logic with Ticker ---
        let notificationTickerInterval;
        let currentNotificationIndex = 0;

        /**
         * Generates and renders notifications based on current data and filter.
         */
        function generateAndRenderNotifications() {
            notifications = []; // Clear existing notifications
            clearInterval(notificationTickerInterval); // Clear any existing ticker

            // Apply filter to notifications based on currentOrderFilter
            let ordersForNotifications = [];
            if (currentOrderFilter === 'all') {
                ordersForNotifications = allOrders; // All orders show all notifications
            } else if (currentOrderFilter === 'overdue') {
                // Only show overdue/pending notifications when 'overdue' filter is active
                ordersForNotifications = allOrders.filter(o => o['סטטוס'] === 'חורג' || o['סטטוס'] === 'ממתין/לא תקין');
            } else {
                ordersForNotifications = []; 
            }

            const activeOrdersForNotif = ordersForNotifications.filter(o => o['סטטוס'] !== 'סגור');
            
            // Check for potential container mismatches (e.g., container taken but not returned after a long time)
            const containerStatus = {}; 

            const sortedOrders = [...ordersForNotifications].sort((a, b) => new Date(a['תאריך הזמנה']) - new Date(b['תאריך הזמנה']));

            sortedOrders.forEach(order => {
                const orderDate = new Date(order['תאריך הזמנה']);

                const containersTaken = (String(order['מספר מכולה ירדה'] || '')).split(',').map(c => c.trim()).filter(c => c);
                const containersBrought = (String(order['מספר מכולה עלתה'] || '')).split(',').map(c => c.trim()).filter(c => c);

                containersTaken.forEach(containerNum => {
                    const current = containerStatus[containerNum] || { action: null, order: null, date: new Date(0) };
                    if (orderDate >= current.date) {
                         containerStatus[containerNum] = { action: 'taken', order: order, date: orderDate };
                    }
                });

                containersBrought.forEach(containerNum => {
                    const current = containerStatus[containerNum] || { action: null, order: null, date: new Date(0) };
                    if (orderDate >= current.date) {
                        containerStatus[containerNum] = { action: 'returned', order: order, date: orderDate };
                    }
                });
            });

            for (const containerNum in containerStatus) {
                const status = containerStatus[containerNum];
                if (status.action === 'taken' && status.order['סטטוס'] !== 'סגור') {
                    const daysPassed = status.order['ימים שעברו'];
                    if (daysPassed && parseInt(daysPassed) > 120) {
                        notifications.push({
                            id: `container-mismatch-${containerNum}-${status.order.sheetRow}`,
                            message: `**התראה:** מכולה מספר ${containerNum} ירדה אצל לקוח **${status.order['שם לקוח']}** בתעודה **${status.order['תעודה']}** לפני ${daysPassed} ימים וטרם הוחזרה/נסגרה! 🚨`,
                            type: 'error',
                            isHandled: false,
                            orderId: status.order.sheetRow,
                            customerName: status.order['שם לקוח'],
                            customerPhone: status.order['טלפון לקוח'], 
                            containers: containerNum, 
                            docId: status.order['תעודה'], 
                            expectedEndDate: status.order['תאריך סיום צפוי']
                        });
                    }
                }
            }
            
            activeOrdersForNotif.filter(o => o['סטטוס'] === 'ממתין/לא תקין').forEach(order => {
                const lastNoteUpdate = order['תאריך וזמן עדכון הערה'] ? new Date(order['תאריך וזמן עדכון הערה']) : new Date(order['תאריך הזמנה']);
                const daysSinceLastUpdate = Math.floor((new Date() - lastNoteUpdate) / (1000 * 60 * 60 * 24));
                if (daysSinceLastUpdate > 30) { 
                    notifications.push({
                        id: `pending-no-update-${order.sheetRow}`,
                        message: `**בטיפול:** הזמנה **${order['תעודה']}** של לקוח **${order['שם לקוח']}** מסומנת "בטיפול" ולא עודכנה ${daysSinceLastUpdate} ימים. דורש בדיקה! ⚠️`,
                        type: 'warning',
                        isHandled: false,
                        orderId: order.sheetRow,
                        customerName: order['שם לקוח'],
                        customerPhone: order['טלפון לקוח'], 
                        docId: order['תעודה'], 
                        expectedEndDate: order['תאריך סיום צפוי'] 
                    });
                }
            });

            if (currentOrderFilter === 'all' || currentOrderFilter === 'overdue') {
                ordersForNotifications.filter(o => o['סטטוס'] === 'חורג').forEach(order => { 
                    notifications.push({
                        id: `overdue-order-${order.sheetRow}`,
                        message: `**חורג:** הזמנה **${order['תעודה']}** של לקוח **${order['שם לקוח']}** חורגת ב-${order['ימים שעברו']} ימים. ⏰`,
                        type: 'warning',
                        isHandled: false,
                        orderId: order.sheetRow,
                        customerName: order['שם לקוח'],
                        customerPhone: order['טלפון לקוח'], 
                        daysOverdue: order['ימים שעברו'],
                        docId: order['תעודה'], 
                        expectedEndDate: order['תאריך סיום צפוי']
                    });
                });
            }

            renderNotifications(); // Render initial state
            currentNotificationIndex = 0;
            if (notifications.length > 0) {
                startNotificationTicker();
            } else {
                 document.getElementById('no-notifications-msg').classList.remove('hidden');
                 document.getElementById('notifications-list').innerHTML = ''; // Ensure list is empty
            }
        }

        /**
         * Renders the current list of notifications and starts the ticker.
         */
        function renderNotifications() {
            const notificationsListDiv = document.getElementById('notifications-list');
            const noNotificationsMsg = document.getElementById('no-notifications-msg'); 

            notificationsListDiv.innerHTML = ''; // Clear existing notifications

            if (notifications.length === 0) {
                noNotificationsMsg.classList.remove('hidden');
                clearInterval(notificationTickerInterval);
            } else {
                noNotificationsMsg.classList.add('hidden');
                notifications.forEach(notif => {
                    const notifItem = document.createElement('div');
                    notifItem.id = `notif-${notif.id}`;
                    notifItem.className = `notification-item ${notif.type} ${notif.isHandled ? 'handled' : ''}`;
                    notifItem.setAttribute('role', 'alert');
                    notifItem.innerHTML = `
                        <i class="fas ${getNotificationIcon(notif.type)} notification-icon" aria-hidden="true"></i>
                        <span class="notification-message">${notif.message}</span>
                        <i class="fas fa-thumbtack pin-icon" onclick="event.stopPropagation(); markNotificationAsHandled('${notif.id}')" aria-label="סמן כטופל"></i>
                        <i class="fab fa-whatsapp whatsapp-btn-icon" title="שלח WhatsApp" onclick="event.stopPropagation(); openWhatsAppModalFromNotification('${notif.id}')"></i>
                    `;
                    notifItem.addEventListener('dblclick', (e) => {
                        e.stopPropagation();
                        markNotificationAsHandled(notif.id);
                    });
                    notificationsListDiv.appendChild(notifItem);
                });
            }
        }

        /**
         * Starts the notification ticker animation.
         */
        function startNotificationTicker() {
            const notificationsListDiv = document.getElementById('notifications-list');
            const tickerContainer = document.getElementById('notifications-ticker-container');
            const itemHeight = notificationsListDiv.children[0] ? notificationsListDiv.children[0].offsetHeight + 8 : 0; // Item height + margin-bottom

            if (notifications.length === 0 || itemHeight === 0) return;

            notificationTickerInterval = setInterval(() => {
                currentNotificationIndex = (currentNotificationIndex + 1) % notifications.length;
                notificationsListDiv.style.transform = `translateY(-${currentNotificationIndex * itemHeight}px)`;

                // If we've looped, reset position instantly to simulate continuous scroll
                if (currentNotificationIndex === 0 && notifications.length > 1) {
                    setTimeout(() => {
                        notificationsListDiv.style.transition = 'none'; // Disable transition for instant jump
                        notificationsListDiv.style.transform = 'translateY(0)';
                        setTimeout(() => {
                            notificationsListDiv.style.transition = 'transform 0.5s ease-in-out'; // Re-enable transition
                        }, 50);
                    }, 500); // Wait for the transition to finish
                }
            }, 5000); // Change notification every 5 seconds
        }

        /**
         * Opens WhatsApp modal directly from a notification item.
         * @param {string} notificationId - The ID of the notification.
         */
        function openWhatsAppModalFromNotification(notificationId) {
            const notification = notifications.find(n => n.id === notificationId);
            if (notification && notification.customerPhone) {
                const suggestedMessageId = getSuggestedMessageIdFromNotification(notification);
                openWhatsAppModal(notification.customerPhone, suggestedMessageId, notification.orderId, notification.customerName, notification.daysOverdue, notification.containers, notification.docId, notification.expectedEndDate, notification.address);
            } else {
                showAlert('לא ניתן לשלוח הודעה: חסר מספר טלפון או פרטי הזמנה בהתראה.', 'warning');
            }
        }

        /**
         * Gets the suggested message ID based on notification type and data.
         * @param {Object} notification - The notification object.
         * @returns {string} The ID of the suggested message.
         */
        function getSuggestedMessageIdFromNotification(notification) {
            if (notification.type === 'error' && notification.id.startsWith('container-mismatch')) {
                return 'container_mismatch';
            } else if (notification.type === 'warning' && notification.id.startsWith('pending-no-update')) {
                return 'pending_order_reminder';
            } else if (notification.type === 'warning' && notification.id.startsWith('overdue-order')) {
                if (notification.daysOverdue <= 7) return 'overdue_7_days';
                if (notification.daysOverdue <= 30) return 'overdue_30_days';
                return 'overdue_long';
            }
            return 'general_inquiry'; 
        }

        /**
         * Returns the appropriate Font Awesome icon class for a notification type.
         * @param {string} type - 'error', 'warning', 'info'.
         * @returns {string} Icon class.
         */
        function getNotificationIcon(type) {
            switch (type) {
                case 'error': return 'fa-exclamation-circle';
                case 'warning': return 'fa-exclamation-triangle';
                case 'info': return 'fa-info-circle';
                default: return 'fa-bell';
            }
        }

        /**
         * Marks a notification as handled, visually updating it.
         * @param {string} notificationId - The ID of the notification to mark.
         */
        function markNotificationAsHandled(notificationId) {
            const notification = notifications.find(n => n.id === notificationId);
            if (notification) {
                notification.isHandled = !notification.isHandled;
                renderNotifications();
                showAlert(`ההתראה סומנה כ${notification.isHandled ? 'טופלה' : 'לא טופלה'}.`, 'success', 3000);
            }
        }

        // --- Report Buttons Logic (now with flip animations) ---
        function updateReportButtons() {
            processDataForDashboard(); // This function now handles the flip animations
        }

        /**
         * Shows the selected report table and hides others.
         * @param {string} tableId - The ID of the report table section to show.
         */
        function showReportTable(tableId) {
            document.querySelectorAll('.report-table-section').forEach(section => {
                section.classList.add('hidden');
            });
            const targetSection = document.getElementById(tableId);
            targetSection.classList.remove('hidden');

            // Render specific table data based on the selected filter
            if (tableId === 'orders-per-customer-table') {
                renderOrdersPerCustomerTable(filteredOrders);
            } else if (tableId === 'action-type-counts-table') {
                renderActionTypeCountsTable(filteredOrders);
            } else if (tableId === 'customers-multiple-containers-table') {
                renderCustomersWithMultipleContainersTable(filteredOrders);
            } else if (tableId === 'overdue-summary-table') {
                renderOverdueSummaryTable(allOrders.filter(o => o['סטטוס'] === 'חורג')); 
            }

            setTimeout(() => {
                targetSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }

        /**
         * Helper function to get the current primary brand color dynamically based on the active theme.
         * This ensures Chart.js colors match the theme.
         * @returns {string} The computed color string.
         */
        function getCurrentChartPrimaryColor() {
            if (document.body.classList.contains('dark')) {
                return getComputedStyle(document.body).getPropertyValue('--dark-primary-brand').trim();
            }
            return getComputedStyle(document.body).getPropertyValue('--primary-brand').trim();
        }

        /**
         * Helper function to get the current accent color dynamically based on the active theme.
         * @returns {string} The computed color string.
         */
        function getCurrentChartAccentColor() {
            if (document.body.classList.contains('dark')) {
                return getComputedStyle(document.body).getPropertyValue('--dark-accent-color').trim();
            }
            return getComputedStyle(document.body).getPropertyValue('--accent-color').trim();
        }

        /**
         * Helper function to get the current text color dynamically based on the active theme for labels.
         * @returns {string} The computed color string.
         */
        function getCurrentChartTextColor() {
            if (document.body.classList.contains('dark')) {
                return getComputedStyle(document.body).getPropertyValue('--dark-text-medium').trim();
            }
            return getComputedStyle(document.body).getPropertyValue('--text-medium').trim();
        }

        // --- Charts Logic (Now with Chart.js) ---

        /**
         * Draws all charts for the dashboard based on `filteredOrders`.
         */
        function drawCharts() {
            drawOrdersPerCustomerChart(filteredOrders);
            drawActionTypeDistributionChart(filteredOrders);
            drawMonthlyOrdersChart(filteredOrders);
            drawOverdueTrendChart(allOrders); // Overdue trend should always use all orders
        }

        /**
         * Destroys existing Chart.js instances.
         */
        function destroyChartInstances() {
            if (ordersPerCustomerChartInstance) ordersPerCustomerChartInstance.destroy();
            if (actionTypeDistributionChartInstance) actionTypeDistributionChartInstance.destroy();
            if (monthlyOrdersChartInstance) monthlyOrdersChartInstance.destroy();
            if (overdueTrendChartInstance) overdueTrendChartInstance.destroy();
        }

        /**
         * Draws the "Orders Per Customer" bar chart using Chart.js.
         * @param {Array<Object>} dataToUse - The array of orders to use for the chart.
         */
        function drawOrdersPerCustomerChart(dataToUse) {
            if (ordersPerCustomerChartInstance) ordersPerCustomerChartInstance.destroy();

            const customerOrderCounts = {};
            dataToUse.forEach(order => {
                const customer = order['שם לקוח'];
                if (customer) {
                    customerOrderCounts[customer] = (customerOrderCounts[customer] || 0) + 1;
                }
            });

            const data = Object.entries(customerOrderCounts)
                .map(([customer, count]) => ({ customer, count }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 10);

            const noDataMsg = document.getElementById('no-data-orders-per-customer');
            if (data.length === 0) {
                noDataMsg.classList.remove('hidden');
                return;
            } else {
                noDataMsg.classList.add('hidden');
            }

            const ctx = document.getElementById('canvas-orders-per-customer').getContext('2d');
            ordersPerCustomerChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.customer),
                    datasets: [{
                        label: 'כמות הזמנות',
                        data: data.map(d => d.count),
                        backgroundColor: getCurrentChartPrimaryColor(),
                        borderColor: getCurrentChartPrimaryColor(),
                        borderWidth: 1,
                        borderRadius: 5, // Rounded bars
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false,
                        },
                        title: {
                            display: false,
                        },
                        tooltip: {
                            rtl: true, // Enable RTL for tooltips
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: getCurrentChartTextColor(),
                                font: {
                                    family: 'Heebo',
                                },
                                autoSkip: false,
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)',
                                borderColor: getCurrentChartTextColor(),
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: getCurrentChartTextColor(),
                                font: {
                                    family: 'Heebo',
                                },
                                precision: 0 // Ensure integer ticks
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)',
                                borderColor: getCurrentChartTextColor(),
                            }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart'
                    }
                }
            });
        }

        /**
         * Draws the "Action Type Distribution" pie chart using Chart.js.
         * @param {Array<Object>} dataToUse - The array of orders to use for the chart.
         */
        function drawActionTypeDistributionChart(dataToUse) {
            if (actionTypeDistributionChartInstance) actionTypeDistributionChartInstance.destroy();

            const actionTypeCounts = {};
            dataToUse.forEach(order => {
                const actionType = order['סוג פעולה'];
                if (actionType) {
                    actionTypeCounts[actionType] = (actionTypeCounts[actionType] || 0) + 1;
                }
            });

            const data = Object.entries(actionTypeCounts).map(([type, count]) => ({ type, count }));

            const noDataMsg = document.getElementById('no-data-action-type');
            if (data.length === 0) {
                noDataMsg.classList.remove('hidden');
                return;
            } else {
                noDataMsg.classList.add('hidden');
            }

            // Generate a dynamic color palette
            const backgroundColors = [
                getCurrentChartPrimaryColor(),
                getCurrentChartAccentColor(),
                '#ff8a65', // Lighter orange
                '#64b5f6', // Light blue
                '#81c784', // Light green
                '#ba68c8', // Light purple
                '#ffb74d', // Light amber
                '#795548', // Brown
                '#9e9e9e', // Grey
                '#f06292'  // Pink
            ];

            const ctx = document.getElementById('canvas-action-type-distribution').getContext('2d');
            actionTypeDistributionChartInstance = new Chart(ctx, {
                type: 'doughnut', // Changed to doughnut for a modern look
                data: {
                    labels: data.map(d => d.type),
                    datasets: [{
                        data: data.map(d => d.count),
                        backgroundColor: backgroundColors.slice(0, data.length), // Use subset of colors
                        borderColor: 'transparent',
                        borderWidth: 1,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right', // Place legend on the right
                            labels: {
                                color: getCurrentChartTextColor(),
                                font: {
                                    family: 'Heebo',
                                    size: 14 // Larger legend text
                                },
                                boxWidth: 20,
                                boxHeight: 12,
                                usePointStyle: true, // Use circle for legend markers
                            },
                            rtl: true, // Enable RTL for legend
                            textDirection: 'rtl',
                        },
                        tooltip: {
                            rtl: true,
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += context.parsed;
                                        const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                                        const percentage = ((context.parsed / total) * 100).toFixed(1) + '%';
                                        label += ` (${percentage})`;
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    animation: {
                        animateRotate: true,
                        animateScale: true,
                        duration: 1000,
                        easing: 'easeOutQuart'
                    },
                    cutout: '60%', // Make it a thicker donut
                }
            });
        }

        /**
         * Draws the "Monthly Orders" line chart using Chart.js.
         * @param {Array<Object>} dataToUse - The array of orders to use for the chart.
         */
        function drawMonthlyOrdersChart(dataToUse) {
            if (monthlyOrdersChartInstance) monthlyOrdersChartInstance.destroy();

            const monthlyCounts = {};
            dataToUse.forEach(order => {
                const orderDate = new Date(order['תאריך הזמנה']);
                if (!isNaN(orderDate.getTime())) {
                    const monthKey = `${orderDate.getFullYear()}-${String(orderDate.getMonth() + 1).padStart(2, '0')}`;
                    monthlyCounts[monthKey] = (monthlyCounts[monthKey] || 0) + 1;
                }
            });

            const data = Object.entries(monthlyCounts)
                .map(([month, count]) => ({ month: month, date: new Date(month + '-01'), count: count }))
                .sort((a, b) => a.date - b.date);

            const noDataMsg = document.getElementById('no-data-monthly-orders');
            if (data.length === 0) {
                noDataMsg.classList.remove('hidden');
                return;
            } else {
                noDataMsg.classList.add('hidden');
            }

            const ctx = document.getElementById('canvas-monthly-orders').getContext('2d');
            monthlyOrdersChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date.toLocaleDateString('he-IL', { month: 'short', year: '2-digit' })),
                    datasets: [{
                        label: 'כמות הזמנות',
                        data: data.map(d => d.count),
                        fill: true, // Fill area under the line
                        backgroundColor: 'rgba(0, 188, 212, 0.2)', // Light blue fill
                        borderColor: getCurrentChartPrimaryColor(),
                        tension: 0.3, // Smoothen the line
                        pointBackgroundColor: getCurrentChartPrimaryColor(),
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false,
                        },
                        title: {
                            display: false,
                        },
                        tooltip: {
                            rtl: true,
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: getCurrentChartTextColor(),
                                font: {
                                    family: 'Heebo',
                                },
                                autoSkip: true,
                                maxTicksLimit: 12,
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)',
                                borderColor: getCurrentChartTextColor(),
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: getCurrentChartTextColor(),
                                font: {
                                    family: 'Heebo',
                                },
                                precision: 0
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)',
                                borderColor: getCurrentChartTextColor(),
                            }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart'
                    }
                }
            });
        }

        /**
         * Draws the "Overdue Trend" line chart using Chart.js.
         * @param {Array<Object>} dataToUse - The array of all orders to analyze for overdue trend.
         */
        function drawOverdueTrendChart(dataToUse) {
            if (overdueTrendChartInstance) overdueTrendChartInstance.destroy();

            const monthlyOverdueCounts = {};
            dataToUse.filter(order => order['סטטוס'] === 'חורג').forEach(order => {
                const orderDate = new Date(order['תאריך הזמנה']);
                if (!isNaN(orderDate.getTime())) {
                    const monthKey = `${orderDate.getFullYear()}-${String(orderDate.getMonth() + 1).padStart(2, '0')}`;
                    monthlyOverdueCounts[monthKey] = (monthlyOverdueCounts[monthKey] || 0) + 1;
                }
            });

            const data = Object.entries(monthlyOverdueCounts)
                .map(([month, count]) => ({ month: month, date: new Date(month + '-01'), count: count }))
                .sort((a, b) => a.date - b.date);

            const noDataMsg = document.getElementById('no-data-overdue-trend');
            if (data.length === 0) {
                noDataMsg.classList.remove('hidden');
                return;
            } else {
                noDataMsg.classList.add('hidden');
            }

            const ctx = document.getElementById('canvas-overdue-trend').getContext('2d');
            overdueTrendChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date.toLocaleDateString('he-IL', { month: 'short', year: '2-digit' })),
                    datasets: [{
                        label: 'כמות הזמנות חורגות',
                        data: data.map(d => d.count),
                        fill: true,
                        backgroundColor: 'rgba(239, 83, 80, 0.2)', // Light red fill
                        borderColor: '#ef5350', // Red border
                        tension: 0.3,
                        pointBackgroundColor: '#ef5350',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false,
                        },
                        title: {
                            display: false,
                        },
                        tooltip: {
                            rtl: true,
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: getCurrentChartTextColor(),
                                font: {
                                    family: 'Heebo',
                                },
                                autoSkip: true,
                                maxTicksLimit: 12,
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)',
                                borderColor: getCurrentChartTextColor(),
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: getCurrentChartTextColor(),
                                font: {
                                    family: 'Heebo',
                                },
                                precision: 0
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)',
                                borderColor: getCurrentChartTextColor(),
                            }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart'
                    }
                }
            });
        }


        // --- DataTables Initialization ---
        /**
         * Initializes DataTables for all report tables.
         * This ensures styling and functionality are applied.
         */
        function initializeDataTables() {
            // Destroy existing instances if they exist
            if (ordersPerCustomerDataTable) ordersPerCustomerDataTable.destroy();
            if (actionTypeCountsDataTable) actionTypeCountsDataTable.destroy();
            if (customersMultipleContainersDataTable) customersMultipleContainersDataTable.destroy();
            if (overdueSummaryDataTable) overdueSummaryDataTable.destroy();
            if (containerHistoryDataTable) containerHistoryDataTable.destroy();
            if (topMovingContainersDataTable) topMovingContainersDataTable.destroy();
            if (returningCustomersDataTable) returningCustomersDataTable.destroy();

            // Common DataTables options for RTL support and styling
            const commonOptions = {
                language: {
                    url: 'https://cdn.datatables.net/plug-ins/2.0.8/i18n/he.json' // Hebrew language file
                },
                paging: true,
                searching: true,
                ordering: true,
                info: true,
                responsive: true,
                autoWidth: false,
                destroy: true, // Allow reinitialization
                pageLength: 10,
                lengthMenu: [ [10, 25, 50, -1], [10, 25, 50, "הכל"] ],
                layout: {
                    topStart: {
                        buttons: ['copy', 'excel', 'pdf', 'print']
                    }
                }
            };

            ordersPerCustomerDataTable = new DataTable('#orders-per-customer-table-data', commonOptions);
            actionTypeCountsDataTable = new DataTable('#action-type-counts-table-data', commonOptions);
            customersMultipleContainersDataTable = new DataTable('#customers-multiple-containers-table-data', commonOptions);
            overdueSummaryDataTable = new DataTable('#overdue-summary-table-data', commonOptions);
            containerHistoryDataTable = new DataTable('#container-history-table', commonOptions);
            topMovingContainersDataTable = new DataTable('#top-moving-containers-table', commonOptions);
            returningCustomersDataTable = new DataTable('#returning-customers-table', commonOptions);

            // Re-render DataTables content after initialization if needed
            renderOrdersPerCustomerTable(filteredOrders);
            renderActionTypeCountsTable(filteredOrders);
            renderCustomersWithMultipleContainersTable(filteredOrders);
            renderOverdueSummaryTable(allOrders.filter(o => o['סטטוס'] === 'חורג'));
        }

        /**
         * Renders the "Orders Per Customer" table using DataTables.
         * @param {Array<Object>} dataToUse - The array of orders to use for the table.
         */
        function renderOrdersPerCustomerTable(dataToUse) {
            const noDataMsg = document.getElementById('no-data-orders-per-customer-table');
            noDataMsg.classList.add('hidden');

            const customerData = {}; 
            dataToUse.forEach(order => {
                const customerName = order['שם לקוח'] || 'לא ידוע';
                const address = order['כתובת'] || 'לא ידוע';
                const phone = order['טלפון לקוח'] || ''; 
                const key = `${customerName}|${address}`;

                if (!customerData[key]) {
                    customerData[key] = {
                        customerName: customerName,
                        address: address,
                        ordersCount: 0,
                        activeContainers: new Set(),
                        phone: phone,
                        lastOrderDate: new Date(0), 
                        firstOrderDate: new Date()
                    };
                }
                customerData[key].ordersCount++;

                const currentOrderDate = new Date(order['תאריך הזמנה']);
                if (currentOrderDate > customerData[key].lastOrderDate) {
                    customerData[key].lastOrderDate = currentOrderDate;
                }
                if (currentOrderDate < customerData[key].firstOrderDate) {
                    customerData[key].firstOrderDate = currentOrderDate;
                }

                if (order['סטטוס'] !== 'סגור') {
                    if (order['סוג פעולה'] === 'הורדה' || (order['סוג פעולה'] === 'החלפה' && order['מספר מכולה ירדה'])) {
                        const containersTaken = (String(order['מספר מכולה ירדה'] || '')).split(',').map(c => c.trim()).filter(c => c);
                        containersTaken.forEach(c => customerData[key].activeContainers.add(c));
                    }
                     if (order['סוג פעולה'] === 'העלאה' || (order['סוג פעולה'] === 'החלפה' && order['מספר מכולה עלתה'])) {
                        const containersBrought = (String(order['מספר מכולה עלתה'] || '')).split(',').map(c => c.trim()).filter(c => c);
                        containersBrought.forEach(c => customerData[key].activeContainers.delete(c)); 
                    }
                }
            });

            const sortedCustomers = Object.values(customerData).sort((a, b) => b.ordersCount - a.ordersCount);

            const tableData = [];
            if (sortedCustomers.length === 0) {
                noDataMsg.classList.remove('hidden');
            } else {
                sortedCustomers.forEach(data => {
                    const containersHtml = data.activeContainers.size > 0 ?
                        Array.from(data.activeContainers).map(c => 
                            `<span class="container-pill" onclick="event.stopPropagation(); openContainerHistoryModal('${c}')">${c}</span>`
                        ).join(' ') : 'אין';
                    const suggestedMsgId = data.ordersCount === 1 && (new Date() - data.firstOrderDate) / (1000 * 60 * 60 * 24) < 30 ? 'new_customer_welcome' : 'general_inquiry';
                    const whatsappHtml = data.phone ?
                        `<i class="fab fa-whatsapp whatsapp-btn-icon" title="שלח WhatsApp" onclick="event.stopPropagation(); openWhatsAppModal('${data.phone}', '${suggestedMsgId}', null, '${data.customerName}', null, null, null, null, '${data.address}')"></i>` : 'אין טלפון';
                    
                    tableData.push([
                        data.customerName,
                        data.address,
                        data.ordersCount,
                        containersHtml,
                        whatsappHtml
                    ]);
                });
            }
            ordersPerCustomerDataTable.clear().rows.add(tableData).draw();
        }

        /**
         * Renders the "Action Type Counts" table using DataTables.
         * @param {Array<Object>} dataToUse - The array of orders to use for the table.
         */
        function renderActionTypeCountsTable(dataToUse) {
            const noDataMsg = document.getElementById('no-data-action-type-table');
            noDataMsg.classList.add('hidden');

            const actionTypeCounts = {};
            dataToUse.forEach(order => {
                const actionType = order['סוג פעולה'] || 'לא ידוע';
                actionTypeCounts[actionType] = (actionTypeCounts[actionType] || 0) + 1;
            });

            const sortedActionTypes = Object.entries(actionTypeCounts).sort((a, b) => b[1] - a[1]);

            const tableData = [];
            if (sortedActionTypes.length === 0) {
                noDataMsg.classList.remove('hidden');
            } else {
                sortedActionTypes.forEach(([type, count]) => {
                    tableData.push([type, count]);
                });
            }
            actionTypeCountsDataTable.clear().rows.add(tableData).draw();
        }

        /**
         * Renders the "Customers with Multiple Containers" table using DataTables.
         * @param {Array<Object>} dataToUse - The array of orders to use for the table.
         */
        function renderCustomersWithMultipleContainersTable(dataToUse) {
            const noDataMsg = document.getElementById('no-data-customers-multiple-containers-table');
            noDataMsg.classList.add('hidden');

            const customersWithMultiple = calculateCustomersWithMultipleContainers(dataToUse); 

            const tableData = [];
            if (customersWithMultiple.length === 0) {
                noDataMsg.classList.remove('hidden');
            } else {
                customersWithMultiple.forEach(data => {
                    const containersHtml = Array.from(data.containers).map(c => 
                            `<span class="container-pill" onclick="event.stopPropagation(); openContainerHistoryModal('${c}')">${c}</span>`
                        ).join(' ');
                    const customerOrder = allOrders.find(o => o['שם לקוח'] === data.customerName && o['כתובת'] === data.address && o['טלפון לקוח']);
                    const whatsappHtml = (customerOrder && customerOrder['טלפון לקוח']) ?
                        `<i class="fab fa-whatsapp whatsapp-btn-icon" title="שלח WhatsApp" onclick="event.stopPropagation(); openWhatsAppModal('${customerOrder['טלפון לקוח']}', 'multi_container_reminder', null, '${data.customerName}', null, data.containers.join(', '), customerOrder['תעודה'] || '', formatDate(customerOrder['תאריך סיום צפוי']) || '', '${data.address}')"></i>` : 'אין טלפון';

                    tableData.push([
                        data.customerName,
                        data.address,
                        data.containerCount,
                        containersHtml,
                        whatsappHtml
                    ]);
                });
            }
            customersMultipleContainersDataTable.clear().rows.add(tableData).draw();
        }

        /**
         * Helper function to calculate customers with multiple active containers.
         * @param {Array<Object>} ordersToAnalyze - The array of orders to analyze.
         * @returns {Array<Object>} List of customers with more than one active container.
         */
        function calculateCustomersWithMultipleContainers(ordersToAnalyze) {
            const customerActiveContainers = {}; 

            ordersToAnalyze.filter(o => o['סטטוס'] !== 'סגור').forEach(order => {
                const customerName = order['שם לקוח'] || 'לא ידוע';
                const address = order['כתובת'] || 'לא ידוע';
                const key = `${customerName}|${address}`;

                if (!customerActiveContainers[key]) {
                    customerActiveContainers[key] = {
                        customerName: customerName,
                        address: address,
                        containers: new Set(),
                        latestOrderDate: new Date(0)
                    };
                }

                const orderDate = new Date(order['תאריך הזמנה']);
                if (orderDate > customerActiveContainers[key].latestOrderDate) {
                    customerActiveContainers[key].latestOrderDate = orderDate;
                }

                if (order['סוג פעולה'] === 'הורדה' || (order['סוג פעולה'] === 'החלפה' && order['מספר מכולה ירדה'])) {
                    const containersTaken = (String(order['מספר מכולה ירדה'] || '')).split(',').map(c => c.trim()).filter(c => c);
                    containersTaken.forEach(c => customerActiveContainers[key].containers.add(c));
                }

                if (order['סוג פעולה'] === 'העלאה' || (order['סוג פעולה'] === 'החלפה' && order['מספר מכולה עלתה'])) {
                    const containersBrought = (String(order['מספר מכולה עלתה'] || '')).split(',').map(c => c.trim()).filter(c => c);
                    containersBrought.forEach(c => {
                        if (customerActiveContainers[key].containers.has(c)) {
                            customerActiveContainers[key].containers.delete(c);
                        }
                    });
                }
            });

            const result = Object.values(customerActiveContainers)
                .filter(data => data.containers.size > 1)
                .map(data => ({
                    customerName: data.customerName,
                    address: data.address,
                    containerCount: data.containers.size,
                    containers: Array.from(data.containers)
                }))
                .sort((a, b) => b.containerCount - a.containerCount); 

            return result;
        }

        /**
         * Renders the "Overdue Summary" table using DataTables.
         * @param {Array<Object>} dataToUse - The array of orders to use for the table.
         */
        function renderOverdueSummaryTable(dataToUse) {
            const noDataMsg = document.getElementById('no-data-overdue-summary-table');
            noDataMsg.classList.add('hidden');

            const overdueOrders = dataToUse; 
            overdueOrders.sort((a, b) => (parseInt(b['ימים שעברו']) || 0) - (parseInt(a['ימים שעברו']) || 0));

            const tableData = [];
            if (overdueOrders.length === 0) {
                noDataMsg.classList.remove('hidden');
            } else {
                overdueOrders.forEach(order => {
                    let containersText = '';
                    if (order['סוג פעולה'] === 'החלפה') {
                        const taken = String(order['מספר מכולה ירדה'] || '');
                        const brought = String(order['מספר מכולה עלתה'] || '');
                        if (taken && brought) containersText = `ירדה: ${taken}, עלתה: ${brought}`;
                        else if (taken) containersText = `ירדה: ${taken}`;
                        else if (brought) containersText = `עלתה: ${brought}`;
                    } else if (order['סוג פעולה'] === 'הורדה') {
                        containersText = String(order['מספר מכולה ירדה'] || '');
                    } else if (order['סוג פעולה'] === 'העלאה') {
                        containersText = String(order['מספר מכולה עלתה'] || '');
                    } else {
                        containersText = String(order['מספרי מכולות'] || '');
                    }
                    const suggestedMsgId = getSuggestedMessageIdForOrder(order);
                    const whatsappHtml = order['טלפון לקוח'] ?
                        `<i class="fab fa-whatsapp whatsapp-btn-icon" title="שלח WhatsApp" onclick="event.stopPropagation(); openWhatsAppModal('${order['טלפון לקוח']}', '${suggestedMsgId}', ${order.sheetRow}, '${order['שם לקוח']}', ${order['ימים שעברו']}, '${containersText}', '${order['תעודה'] || ''}', '${formatDate(order['תאריך סיום צפוי']) || ''}', '${order['כתובת'] || ''}')"></i>` : 'אין טלפון';

                    tableData.push([
                        order['תעודה'] || '',
                        order['שם לקוח'] || '',
                        order['כתובת'] || '',
                        order['סוג פעולה'] || '',
                        order['ימים שעברו'] !== undefined ? order['ימים שעברו'] : '',
                        containersText,
                        order['הערות'] || '',
                        whatsappHtml
                    ]);
                });
            }
            overdueSummaryDataTable.clear().rows.add(tableData).draw();
        }

        /**
         * Calculates the top moving container.
         * A "movement" is defined as any order where the container is taken or brought.
         * @param {Array<Object>} ordersToAnalyze - The array of orders to use for analysis.
         * @returns {Object} { container: string, count: number }
         */
        function getTopMovingContainer(ordersToAnalyze) {
            const containerMovementCounts = {};

            ordersToAnalyze.forEach(order => {
                const containersTaken = (String(order['מספר מכולה ירדה'] || '')).split(',').map(c => c.trim()).filter(c => c);
                const containersBrought = (String(order['מספר מכולה עלתה'] || '')).split(',').map(c => c.trim()).filter(c => c);

                containersTaken.forEach(c => {
                    containerMovementCounts[c] = (containerMovementCounts[c] || 0) + 1;
                });
                containersBrought.forEach(c => {
                    containerMovementCounts[c] = (containerMovementCounts[c] || 0) + 1;
                });
            });

            let topContainer = { container: 'אין', count: 0 };
            for (const c in containerMovementCounts) {
                if (containerMovementCounts[c] > topContainer.count) {
                    topContainer = { container: c, count: containerMovementCounts[c] };
                }
            }
            return topContainer;
        }

        /**
         * Opens the modal to display top moving containers using DataTables.
         */
        function openTopMovingContainersModal() {
            const modal = document.getElementById('top-moving-containers-modal');
            const noDataMsg = document.getElementById('no-top-moving-containers');
            noDataMsg.classList.add('hidden');

            const containerMovementCounts = {};
            filteredOrders.forEach(order => { 
                const containersTaken = (String(order['מספר מכולה ירדה'] || '')).split(',').map(c => c.trim()).filter(c => c);
                const containersBrought = (String(order['מספר מכולה עלתה'] || '')).split(',').map(c => c.trim()).filter(c => c);

                containersTaken.forEach(c => {
                    containerMovementCounts[c] = (containerMovementCounts[c] || 0) + 1;
                });
                containersBrought.forEach(c => {
                    containerMovementCounts[c] = (containerMovementCounts[c] || 0) + 1;
                });
            });

            const sortedContainers = Object.entries(containerMovementCounts)
                .map(([container, count]) => ({ container, count }))
                .sort((a, b) => b.count - a.count);

            const tableData = [];
            if (sortedContainers.length === 0) {
                noDataMsg.classList.remove('hidden');
            } else {
                sortedContainers.forEach(data => {
                    const historyBtnHtml = `<button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); openContainerHistoryModal('${data.container}')">הצג היסטוריה</button>`;
                    tableData.push([
                        `📦 ${data.container}`,
                        data.count,
                        historyBtnHtml
                    ]);
                });
            }
            topMovingContainersDataTable.clear().rows.add(tableData).draw();

            if (isMobile()) {
                modal.classList.add('mobile-drawer');
            } else {
                modal.classList.remove('mobile-drawer');
            }
            modal.classList.add('active');
        }

        function closeTopMovingContainersModal() {
            document.getElementById('top-moving-containers-modal').classList.remove('active');
        }

        /**
         * Calculates and returns a list of returning customers based on `ordersToAnalyze`.
         * A returning customer is defined as someone with more than 1 order.
         * @param {Array<Object>} ordersToAnalyze - The array of orders to use for analysis.
         * @returns {Array<Object>} List of returning customers with their data.
         */
        function getReturningCustomers(ordersToAnalyze) {
            const customerOrderData = {}; 

            ordersToAnalyze.forEach(order => { 
                const customerName = order['שם לקוח'] || 'לא ידוע';
                const address = order['כתובת'] || 'לא ידוע';
                const phone = order['טלפון לקוח'] || '';
                const key = `${customerName}|${address}`;

                if (!customerOrderData[key]) {
                    customerOrderData[key] = {
                        customerName: customerName,
                        address: address,
                        orderCount: 0,
                        activeContainers: new Set(),
                        overdueOrders: [], 
                        phone: phone,
                        lastOrderDate: new Date(0),
                        firstOrderDate: new Date()
                    };
                }
                customerOrderData[key].orderCount++;

                const currentOrderDate = new Date(order['תאריך הזמנה']);
                if (currentOrderDate > customerOrderData[key].lastOrderDate) {
                    customerOrderData[key].lastOrderDate = currentOrderDate;
                }
                if (currentOrderDate < customerOrderData[key].firstOrderDate) {
                    customerOrderData[key].firstOrderDate = currentOrderDate;
                }

                if (order['סטטוס'] !== 'סגור') {
                    if (order['סוג פעולה'] === 'הורדה' || (order['סוג פעולה'] === 'החלפה' && order['מספר מכולה ירדה'])) {
                        const containersTaken = (String(order['מספר מכולה ירדה'] || '')).split(',').map(c => c.trim()).filter(c => c);
                        containersTaken.forEach(c => customerOrderData[key].activeContainers.add(c));
                    }
                     if (order['סוג פעולה'] === 'העלאה' || (order['סוג פעולה'] === 'החלפה' && order['מספר מכולה עלתה'])) {
                        const containersBrought = (String(order['מספר מכולה עלתה'] || '')).split(',').map(c => c.trim()).filter(c => c);
                        containersBrought.forEach(c => {
                            if (customerOrderData[key].activeContainers.has(c)) {
                                customerOrderData[key].activeContainers.delete(c);
                            }
                        });
                    }
                }
                const fullOrder = allOrders.find(o => o.sheetRow === order.sheetRow); 
                if (fullOrder && fullOrder['סטטוס'] === 'חורג') {
                    customerOrderData[key].overdueOrders.push(fullOrder);
                }
            });

            const returningCustomers = Object.values(customerOrderData)
                .filter(data => data.orderCount > 1)
                .sort((a, b) => b.orderCount - a.orderCount);

            return returningCustomers;
        }

        /**
         * Opens the modal to display returning customers using DataTables.
         */
        function openReturningCustomersModal() {
            const modal = document.getElementById('returning-customers-modal');
            const noDataMsg = document.getElementById('no-returning-customers');
            noDataMsg.classList.add('hidden');

            const returningCustomers = getReturningCustomers(filteredOrders);

            const tableData = [];
            if (returningCustomers.length === 0) {
                noDataMsg.classList.remove('hidden');
            } else {
                returningCustomers.forEach(customer => {
                    const containersHtml = customer.activeContainers.size > 0 ?
                        Array.from(customer.activeContainers).map(c => 
                            `<span class="container-pill" onclick="event.stopPropagation(); openContainerHistoryModal('${c}')">${c}</span>`
                        ).join(' ') : 'אין';
                    const statusText = customer.overdueOrders.length > 0 ?
                        `<span class="text-red-600 font-bold">חורג (${customer.overdueOrders.length})</span>` : 'תקין';
                    const suggestedMsgId = 'general_inquiry';
                    const whatsappHtml = customer.phone ?
                        `<i class="fab fa-whatsapp whatsapp-btn-icon" title="שלח WhatsApp" onclick="event.stopPropagation(); openWhatsAppModal('${customer.phone}', '${suggestedMsgId}', null, '${customer.customerName}', null, customer.containers.join(', ') || '', null, null, '${customer.address}')"></i>` : 'אין טלפון';

                    tableData.push([
                        customer.customerName,
                        customer.address,
                        customer.orderCount,
                        containersHtml,
                        statusText,
                        whatsappHtml
                    ]);
                });
            }
            returningCustomersDataTable.clear().rows.add(tableData).draw();

            if (isMobile()) {
                modal.classList.add('mobile-drawer');
            } else {
                modal.classList.remove('mobile-drawer');
            }
            modal.classList.add('active');
        }

        function closeReturningCustomersModal() {
            document.getElementById('returning-customers-modal').classList.remove('active');
        }

        /**
         * Shows a detailed history/anomaly report for a specific customer in the order-details-modal.
         * @param {Object} customerData - Data for the selected customer.
         */
        function showCustomerAnomalyHistory(customerData) {
            const modal = document.getElementById('order-details-modal');
            const orderCard = document.getElementById('current-order-card');
            
            let htmlContent = `
                <h3 class="text-xl font-bold mb-4 text-gray-700 dark:text-gray-200">
                    היסטוריית לקוח: ${customerData.customerName} - ${customerData.address}
                </h3>
                <p class="mb-2"><strong>סה"כ הזמנות:</strong> ${customerData.orderCount}</p>
            `;

            if (customerData.overdueOrders && customerData.overdueOrders.length > 0) {
                htmlContent += `<p class="text-red-600 font-bold mb-4">
                    <i class="fas fa-exclamation-triangle ml-1"></i> הזמנות חורגות בעבר / בהווה (${customerData.overdueOrders.length}):
                </p>`;
                customerData.overdueOrders.forEach(order => {
                    htmlContent += `
                        <div class="card p-3 mb-2 border border-red-300 dark:border-red-600">
                            <p><strong>תעודה:</strong> ${order['תעודה']}</p>
                            <p><strong>תאריך הזמנה:</strong> ${formatDate(order['תאריך הזמנה'])}</p>
                            <p><strong>סוג פעולה:</strong> ${order['סוג פעולה']}</p>
                            <p><strong>ימים שעברו:</strong> ${order['ימים שעברו']}</p>
                            <p><strong>הערות:</strong> ${order['הערות'] || 'אין'}</p>
                        </div>
                    `;
                });
            } else {
                htmlContent += `<p class="text-green-600 font-bold mb-4">
                    <i class="fas fa-check-circle ml-1"></i> אין היסטוריה חריגה ידועה ללקוח זה. לקוח פוטנציאלי טוב!
                </p>`;
            }

            htmlContent += `
                <h4 class="text-lg font-bold mt-6 mb-3 text-gray-700 dark:text-gray-200">
                    כל ההזמנות של הלקוח:
                </h4>
                <div class="table-container">
                    <table id="customer-all-orders-table" class="min-w-full display compact">
                        <thead>
                            <tr>
                                <th>תאריך</th>
                                <th>תעודה</th>
                                <th>פעולה</th>
                                <th>סטטוס</th>
                                <th>מכולה ירדה</th>
                                <th>מכולה עלתה</th>
                                <th>WhatsApp</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            `;

            orderCard.innerHTML = htmlContent;
            document.getElementById('details-modal-title').textContent = 'פרטי היסטוריית לקוח';

            // Populate the nested table with DataTables
            const customerOrdersTableData = allOrders.filter(o => o['שם לקוח'] === customerData.customerName && o['כתובת'] === customerData.address)
                .sort((a,b) => new Date(b['תאריך הזמנה']) - new Date(a['תאריך הזמנה']))
                .map(order => {
                    let statusClass = '';
                    switch (order['סטטוס']) {
                        case 'פתוח': statusClass = 'text-blue-500'; break;
                        case 'סגור': statusClass = 'text-green-500'; break;
                        case 'חורג': statusClass = 'text-red-500'; break;
                        default: statusClass = 'text-gray-500'; break;
                    }
                    const whatsappHtml = order['טלפון לקוח'] ? `<i class="fab fa-whatsapp whatsapp-btn-icon" title="שלח WhatsApp" onclick="event.stopPropagation(); openWhatsAppModal('${order['טלפון לקוח']}', '${getSuggestedMessageIdForOrder(order)}', ${order.sheetRow}, '${order['שם לקוח']}', ${order['ימים שעברו']}, '${order['מספר מכולה ירדה'] || order['מספר מכולה עלתה'] || ''}', '${order['תעודה'] || ''}', '${formatDate(order['תאריך סיום צפוי']) || ''}', '${order['כתובת'] || ''}')"></i>` : 'אין טלפון';
                    return [
                        formatDate(order['תאריך הזמנה']),
                        order['תעודה'],
                        order['סוג פעולה'],
                        `<span class="${statusClass}">${order['סטטוס']}</span>`,
                        order['מספר מכולה ירדה'] || '',
                        order['מספר מכולה עלתה'] || '',
                        whatsappHtml
                    ];
                });
            
            // Initialize DataTables for the nested table
            new DataTable('#customer-all-orders-table', {
                language: { url: 'https://cdn.datatables.net/plug-ins/2.0.8/i18n/he.json' },
                data: customerOrdersTableData,
                paging: true,
                searching: true,
                ordering: true,
                info: true,
                responsive: true,
                autoWidth: false,
                destroy: true, // Allow reinitialization
                pageLength: 5,
                lengthMenu: [ [5, 10, 25, -1], [5, 10, 25, "הכל"] ]
            });


            if (isMobile()) {
                modal.classList.add('mobile-drawer');
            } else {
                modal.classList.remove('mobile-drawer');
            }
            modal.classList.add('active');
        }

        function closeOrderDetailsModal() {
            document.getElementById('order-details-modal').classList.remove('active');
        }

        // --- Export, Print, Share Logic ---

        /**
         * Exports displayed table data to an Excel (CSV) file.
         * @param {string} tableId - The ID of the table HTML element.
         * @param {string} filename - The desired filename for the export.
         */
        function exportTableToExcel(tableId, filename = 'report') {
            const tableElement = document.getElementById(tableId);
            if (!tableElement) {
                showAlert('טבלה לייצוא לא נמצאה.', 'error');
                return;
            }

            // Get DataTables instance if it exists, otherwise fall back to direct DOM
            const dataTable = DataTable.getInstance(tableElement);
            let headers, rowsData;

            if (dataTable) {
                // Get data directly from DataTables for accuracy
                headers = dataTable.columns().header().toArray().map(th => th.textContent.trim());
                rowsData = dataTable.rows({ search: 'applied' }).data().toArray();
            } else {
                // Fallback for non-DataTables tables or if initialization failed
                const rows = Array.from(tableElement.querySelectorAll('tr'));
                if (rows.length <= 1) { // Only header row
                    showAlert('אין נתונים לייצוא בטבלה זו.', 'warning');
                    return;
                }
                headers = Array.from(rows[0].querySelectorAll('th')).map(th => th.textContent.trim());
                rowsData = [];
                for (let i = 1; i < rows.length; i++) {
                    const rowCells = Array.from(rows[i].querySelectorAll('td'));
                    rowsData.push(rowCells.map(cell => cell.textContent.trim()));
                }
            }

            let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // UTF-8 BOM for Hebrew

            // Filter out the WhatsApp column from headers and rowsData
            const whatsappColIndex = headers.indexOf('WhatsApp');
            if (whatsappColIndex !== -1) {
                headers = headers.filter((_, index) => index !== whatsappColIndex);
                rowsData = rowsData.map(row => row.filter((_, index) => index !== whatsappColIndex));
            }
            // Filter out the "הצג היסטוריה" column from headers and rowsData if it exists
            const historyColIndex = headers.indexOf('הצג היסטוריה');
            if (historyColIndex !== -1) {
                headers = headers.filter((_, index) => index !== historyColIndex);
                rowsData = rowsData.map(row => row.filter((_, index) => index !== historyColIndex));
            }
            // Remove "container-pill" spans from data when exporting
            rowsData = rowsData.map(row => row.map(cell => {
                if (typeof cell === 'string') {
                    // Use a temporary div to parse HTML and get clean text
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = cell;
                    return tempDiv.textContent || tempDiv.innerText || cell;
                }
                return cell;
            }));


            csvContent += headers.join(',') + '\n';

            for (let i = 0; i < rowsData.length; i++) {
                const row = rowsData[i];
                const rowFormatted = row.map(cell => {
                    let value = String(cell).trim();
                    value = value.replace(/"/g, '""');
                    if (value.includes(',') || value.includes('\n')) {
                        value = `"${value}"`;
                    }
                    return value;
                });
                csvContent += rowFormatted.join(',') + '\n';
            }

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `${filename}_${new Date().toISOString().slice(0, 10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showAlert('הנתונים יוצאו לאקסל בהצלחה!', 'success');
        }


        /**
         * Helper function to get structured data for printing for each report type.
         * This function centralizes the data retrieval logic for printing purposes,
         * ensuring consistent data format regardless of the current DOM state.
         * @param {string} reportType - The identifier for the type of report (e.g., 'orders-per-customer-table').
         * @returns {Object} An object containing headers (Array<string>), rows (Array<Array<string>>), and title (string).
         */
        function getReportDataForPrinting(reportType) {
            let headers = [];
            let rows = [];
            let title = '';
            let dataToProcess = filteredOrders; 

            if (reportType === 'orders-per-customer-table') {
                title = 'דוח: כמות הזמנות לכל לקוח';
                headers = ['שם לקוח', 'כתובת', 'כמות הזמנות', 'כמות מכולות פעילות'];
                const customerData = {}; 
                dataToProcess.forEach(order => {
                    const customerName = order['שם לקוח'] || 'לא ידוע';
                    const address = order['כתובת'] || 'לא ידוע';
                    const key = `${customerName}|${address}`;
                    if (!customerData[key]) {
                        customerData[key] = { customerName: customerName, address: address, ordersCount: 0, activeContainers: new Set() };
                    }
                    customerData[key].ordersCount++;
                    if (order['סטטוס'] !== 'סגור') {
                        if (order['סוג פעולה'] === 'הורדה' || (order['סוג פעולה'] === 'החלפה' && order['מספר מכולה ירדה'])) {
                            const containersTaken = (String(order['מספר מכולה ירדה'] || '')).split(',').map(c => c.trim()).filter(c => c);
                            containersTaken.forEach(c => customerData[key].activeContainers.add(c));
                        }
                        if (order['סוג פעולה'] === 'העלאה' || (order['סוג פעולה'] === 'החלפה' && order['מספר מכולה עלתה'])) {
                            const containersBrought = (String(order['מספר מכולה עלתה'] || '')).split(',').map(c => c.trim()).filter(c => c);
                            containersBrought.forEach(c => customerData[key].activeContainers.delete(c));
                        }
                    }
                });
                const sortedCustomers = Object.values(customerData).sort((a, b) => b.ordersCount - a.ordersCount);
                rows = sortedCustomers.map(data => [
                    data.customerName,
                    data.address,
                    data.ordersCount,
                    Array.from(data.activeContainers).join(', ') || 'אין'
                ]);
            } else if (reportType === 'action-type-counts-table') {
                title = 'דוח: כמות סוגי פעולות';
                headers = ['סוג פעולה', 'כמות'];
                const actionTypeCounts = {};
                dataToProcess.forEach(order => { 
                    const actionType = order['סוג פעולה'] || 'לא ידוע';
                    actionTypeCounts[actionType] = (actionTypeCounts[actionType] || 0) + 1;
                });
                const sortedActionTypes = Object.entries(actionTypeCounts).sort((a, b) => b[1] - a[1]);
                rows = sortedActionTypes; 
            } else if (reportType === 'customers-multiple-containers-table') {
                title = 'דוח: לקוחות עם יותר ממכולה אחת';
                headers = ['שם לקוח', 'כתובת', 'כמות מכולות פעילות', 'מספרי מכולות'];
                const customersWithMultiple = calculateCustomersWithMultipleContainers(dataToProcess); 
                rows = customersWithMultiple.map(data => [
                    data.customerName,
                    data.address,
                    data.containerCount,
                    data.containers.join(', ')
                ]);
            } else if (reportType === 'overdue-summary-table') {
                title = 'דוח: סיכום הזמנות חורגות';
                headers = ['תעודה', 'שם לקוח', 'כתובת', 'סוג פעולה', 'ימים שעברו', 'מכולות קשורות', 'הערות'];
                const overdueOrders = allOrders.filter(o => o['סטטוס'] === 'חורג'); 
                overdueOrders.sort((a, b) => (parseInt(b['ימים שעברו']) || 0) - (parseInt(a['ימים שעברו']) || 0));
                rows = overdueOrders.map(order => {
                    let containersText = '';
                    if (order['סוג פעולה'] === 'החלפה') {
                        const taken = String(order['מספר מכולה ירדה'] || '');
                        const brought = String(order['מספר מכולה עלתה'] || '');
                        if (taken && brought) containersText = `ירדה: ${taken}, עלתה: ${brought}`;
                        else if (taken) containersText = `ירדה: ${taken}`;
                        else if (brought) containersText = `עלתה: ${brought}`;
                    } else if (order['סוג פעולה'] === 'הורדה') {
                        containersText = String(order['מספר מכולה ירדה'] || '');
                    } else if (order['סוג פעולה'] === 'העלאה') {
                        containersText = String(order['מספר מכולה עלתה'] || '');
                    } else {
                        containersText = String(order['מספרי מכולות'] || '');
                    }
                    return [
                        order['תעודה'] || '',
                        order['שם לקוח'] || '',
                        order['כתובת'] || '',
                        order['סוג פעולה'] || '',
                        order['ימים שעברו'] !== undefined ? order['ימים שעברו'] : '',
                        containersText,
                        order['הערות'] || ''
                    ];
                });
            } else if (reportType === 'top-moving-containers-table') {
                title = 'מכולות מובילות בתזוזה';
                headers = ['מכולה', 'מספר תזוזות'];
                const containerMovementCounts = {};
                dataToProcess.forEach(order => { 
                    const containersTaken = (String(order['מספר מכולה ירדה'] || '')).split(',').map(c => c.trim()).filter(c => c);
                    const containersBrought = (String(order['מספר מכולה עלתה'] || '')).split(',').map(c => c.trim()).filter(c => c);
                    containersTaken.forEach(c => { containerMovementCounts[c] = (containerMovementCounts[c] || 0) + 1; });
                    containersBrought.forEach(c => { containerMovementCounts[c] = (containerMovementCounts[c] || 0) + 1; });
                });
                const sortedContainers = Object.entries(containerMovementCounts)
                    .map(([container, count]) => ({ container, count }))
                    .sort((a, b) => b.count - a.count);
                rows = sortedContainers.map(d => [d.container, d.count]);
            } else if (reportType === 'returning-customers-table') {
                title = 'לקוחות חוזרים (בעלי הזמנות רבות)';
                headers = ['שם לקוח', 'כתובת', 'כמות הזמנות', 'מכולות פעילות', 'היסטוריה חריגה'];
                const returningCustomers = getReturningCustomers(dataToProcess); 
                rows = returningCustomers.map(customer => [
                    customer.customerName,
                    customer.address,
                    customer.orderCount,
                    Array.from(customer.activeContainers).join(', ') || 'אין',
                    customer.overdueOrders && customer.overdueOrders.length > 0 ? `חורג (${customer.overdueOrders.length})` : 'תקין'
                ]);
            }

            return { headers, rows, title };
        }

        /**
         * Prints the content of a specific report table using a generated HTML structure.
         * @param {string} reportType - The identifier for the type of report to print.
         */
        function printReport(reportType) {
            const { headers, rows, title } = getReportDataForPrinting(reportType);

            if (rows.length === 0) {
                showAlert('אין נתונים להדפסה בדוח זה.', 'warning');
                return;
            }

            let tableHtml = `
                <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                    <thead>
                        <tr>
                            ${headers.map(h => `<th style="border: 1px solid #ddd; padding: 8px; text-align: right; background-color: #f2f2f2;">${h}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${rows.map(row => `
                            <tr>
                                ${row.map(cell => `<td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${cell}</td>`).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write('<html><head><title>הדפסת דוח</title>');
            printWindow.document.write('<style>');
            printWindow.document.write(`
                body { font-family: 'Heebo', sans-serif; direction: rtl; text-align: right; margin: 20px; }
                h1 { text-align: center; margin-bottom: 20px; color: #1f2937; }
                @media print {
                    body { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
                    table { page-break-inside: auto; }
                    tr { page-break-inside: avoid; page-break-after: auto; }
                    thead { display: table-header-group; }
                    tfoot { display: table-footer-group; }
                }
            `);
            printWindow.document.write('</style></head><body>');
            printWindow.document.write(`<h1>${title}</h1>`);
            printWindow.document.write(tableHtml);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
            showAlert('הדוח נשלח להדפסה.', 'success', 3000);
        }

        /**
         * Shares the content of a specific report table to WhatsApp.
         * @param {string} tableId - The ID of the table HTML element.
         */
        function shareReportToWhatsApp(tableId) {
            const tableElement = document.getElementById(tableId);
            if (!tableElement) {
                showAlert('טבלה לשיתוף לא נמצאה.', 'error');
                return;
            }

            const dataTable = DataTable.getInstance(tableElement);
            let headers, rowsData;

            if (dataTable) {
                headers = dataTable.columns().header().toArray().map(th => th.textContent.trim());
                rowsData = dataTable.rows({ search: 'applied' }).data().toArray();
            } else {
                const rows = Array.from(tableElement.querySelectorAll('tr'));
                if (rows.length <= 1) {
                    showAlert('אין נתונים לשיתוף בטבלה זו.', 'warning');
                    return;
                }
                headers = Array.from(rows[0].querySelectorAll('th')).map(th => th.textContent.trim());
                rowsData = [];
                for (let i = 1; i < rows.length; i++) {
                    const rowCells = Array.from(rows[i].querySelectorAll('td'));
                    rowsData.push(rowCells.map(cell => cell.textContent.trim()));
                }
            }

            const reportTitle = document.querySelector(`#${tableId}`).previousElementSibling.textContent.replace('דוח:', '').trim();
            let message = `*${reportTitle}*\n\n`;

            const whatsappColIndex = headers.indexOf('WhatsApp');
            if (whatsappColIndex !== -1) {
                headers = headers.filter((_, index) => index !== whatsappColIndex);
                rowsData = rowsData.map(row => row.filter((_, index) => index !== whatsappColIndex));
            }
             const historyColIndex = headers.indexOf('הצג היסטוריה');
            if (historyColIndex !== -1) {
                headers = headers.filter((_, index) => index !== historyColIndex);
                rowsData = rowsData.map(row => row.filter((_, index) => index !== historyColIndex));
            }

            for (let i = 0; i < rowsData.length; i++) {
                const row = rowsData[i];
                message += `${headers[0]}: ${row[0]}`;
                for (let j = 1; j < row.length; j++) {
                    message += `, ${headers[j]}: ${row[j]}`;
                }
                message += '\n';
            }

            const whatsappUrl = `https://wa.me/${WHATSAPP_PHONE_NUMBER}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            showAlert('הדוח נשלח לווצאפ.', 'success', 3000);
        }

        // --- Container History Modal (reused/adapted from script.js) ---
        function openContainerHistoryModal(containerNum) {
            const modal = document.getElementById('container-history-modal');
            const noHistoryMsg = document.getElementById('no-container-history');
            document.getElementById('history-container-number').textContent = containerNum;
            noHistoryMsg.classList.add('hidden');

            const containerHistory = allOrders.filter(order => 
                (String(order['מספר מכולה ירדה'] || '')).split(',').map(c => c.trim()).includes(containerNum.trim()) ||
                (String(order['מספר מכולה עלתה'] || '')).split(',').map(c => c.trim()).includes(containerNum.trim()) ||
                (String(order['מספרי מכולות'] || '')).split(',').map(c => c.trim()).includes(containerNum.trim())
            ).sort((a, b) => new Date(a['תאריך הזמנה']) - new Date(b['תאריך הזמנה']));

            const tableData = [];
            if (containerHistory.length === 0) {
                noHistoryMsg.classList.remove('hidden');
            } else {
                containerHistory.forEach(order => {
                    let statusClass = '';
                    switch (order['סטטוס']) {
                        case 'פתוח': statusClass = 'text-blue-500'; break;
                        case 'סגור': statusClass = 'text-green-500'; break;
                        case 'חורג': statusClass = 'text-red-500'; break;
                        case 'ממתין/לא תקין': statusClass = 'text-yellow-500'; break;
                        default: statusClass = 'text-gray-500'; break;
                    }
                    const whatsappHtml = order['טלפון לקוח'] ?
                        `<i class="fab fa-whatsapp whatsapp-btn-icon" title="שלח WhatsApp" onclick="event.stopPropagation(); openWhatsAppModal('${order['טלפון לקוח']}', '${getSuggestedMessageIdForOrder(order)}', ${order.sheetRow}, '${order['שם לקוח']}', ${order['ימים שעברו']}, '${order['מספר מכולה ירדה'] || order['מספר מכולה עלתה'] || ''}', '${order['תעודה'] || ''}', '${formatDate(order['תאריך סיום צפוי']) || ''}', '${order['כתובת'] || ''}')"></i>` : 'אין טלפון';

                    tableData.push([
                        formatDate(order['תאריך הזמנה']),
                        order['תעודה'] || '',
                        order['שם לקוח'] || '',
                        order['סוג פעולה'] || '',
                        String(order['מספר מכולה ירדה'] || order['מספרי מכולות'] || ''),
                        String(order['מספר מכולה עלתה'] || ''),
                        `<span class="${statusClass}">${order['סטטוס'] || ''}</span>`,
                        formatDate(order['תאריך סיום צפוי']),
                        whatsappHtml
                    ]);
                });
            }
            containerHistoryDataTable.clear().rows.add(tableData).draw();

             if (isMobile()) {
                modal.classList.add('mobile-drawer');
            } else {
                modal.classList.remove('mobile-drawer');
            }
            modal.classList.add('active');
        }

        function closeContainerHistoryModal() {
            document.getElementById('container-history-modal').classList.remove('active');
        }

        function showOrderDetails(orderData) {
            const modal = document.getElementById('order-details-modal');
            const orderCard = document.getElementById('current-order-card');
            
            let containersDisplay = '';
            if (orderData['סוג פעולה'] === 'הורדה') {
                containersDisplay = String(orderData['מספר מכולה ירדה'] || orderData['מספרי מכולות'] || '');
            } else if (orderData['סוג פעולה'] === 'העלאה') {
                containersDisplay = String(orderData['מספר מכולה עלתה'] || orderData['מספרי מכולות'] || '');
            } else if (orderData['סוג פעולה'] === 'החלפה') {
                const taken = String(orderData['מספר מכולה ירדה'] || '');
                const brought = String(orderData['מספר מכולה עלתה'] || '');
                if (taken && brought) {
                    containersDisplay = `ירדה: ${taken}, עלתה: ${brought}`;
                } else if (taken) {
                    containersDisplay = `ירדה: ${taken}`;
                } else if (brought) {
                    containersDisplay = `עלתה: ${brought}`;
                }
            } else {
                containersDisplay = String(orderData['מספרי מכולות'] || '');
            }

            orderCard.innerHTML = `
                <p><i class="fas fa-id-card icon" aria-hidden="true"></i> <strong>תעודה:</strong> ${orderData['תעודה'] || ''}</p>
                <p><i class="fas fa-calendar-alt icon" aria-hidden="true"></i> <strong>תאריך הזמנה:</strong> ${formatDate(orderData['תאריך הזמנה'])}</p>
                <p><i class="fas fa-user-tie icon" aria-hidden="true"></i> <strong>שם סוכן:</strong> ${orderData['שם סוכן'] || ''}</p>
                <p><i class="fas fa-user-circle icon" aria-hidden="true"></i> <strong>שם לקוח:</strong> ${orderData['שם לקוח'] || ''}</p>
                <p><i class="fas fa-map-marker-alt icon" aria-hidden="true"></i> <strong>כתובת:</strong> ${orderData['כתובת'] || ''}</p>
                <p><i class="fas fa-exchange-alt icon" aria-hidden="true"></i> <strong>סוג פעולה:</strong> ${orderData['סוג פעולה'] || ''}</p>
                <p><i class="fas fa-boxes icon" aria-hidden="true"></i> <strong>מכולות קשורות:</strong> ${containersDisplay}</p>
                <p><i class="fas fa-info-circle icon" aria-hidden="true"></i> <strong>סטטוס:</strong> <span class="${orderData['סטטוס'] === 'פתוח' ? 'status-open' : orderData['סטטוס'] === 'חורג' ? 'status-overdue' : 'status-closed'}">${orderData['סטטוס'] || ''}</span></p>
                <p><i class="fas fa-hourglass-half icon" aria-hidden="true"></i> <strong>ימים שעברו:</strong> ${orderData['ימים שעברו'] !== undefined ? orderData['ימים שעברו'] : ''}</p>
                <p><i class="fas fa-calendar-check icon" aria-hidden="true"></i> <strong>תאריך סיום צפוי:</strong> ${formatDate(orderData['תאריך סיום צפוי'])}</p>
                <p><i class="fas fa-comment-dots icon" aria-hidden="true"></i> <strong>הערות:</strong> <span class="note-text">${orderData['הערות'] || 'אין הערות'}</span></p>
                <p><i class="fas fa-calendar-times icon" aria-hidden="true"></i> <strong>תאריך סגירה:</strong> ${formatDate(orderData['תאריך סגירה'])}</p>
                <p><i class="fas fa-clock icon" aria-hidden="true"></i> <strong>עדכון הערה אחרון:</strong> ${formatDateTime(orderData['תאריך וזמן עדכון הערה'])}</p>
            `;

            if (isMobile()) {
                modal.classList.add('mobile-drawer');
            } else {
                modal.classList.remove('mobile-drawer');
            }
            modal.classList.add('active');
        }

        // --- WhatsApp Messaging Logic ---

        const whatsappMessages = [
            { id: 'new_customer_welcome', text: 'שלום **[שם לקוח]**,\nתודה שבחרת להתחיל שכירות מכולה אצלנו! 🥳 לכל פניה, בקשת החלפה או הוצאה של המכולה, אתה מוזמן ליצור קשר.\n\n📞 מספר ווטסאפ להזמנות: **972508860896**\n☎️ טלפון מחלקת הזמנות: **097602010**', category: 'כללי', placeholders: ['שם לקוח'], emoji: '👋' },
            { id: 'approaching_due_7_days', text: 'שלום **[שם לקוח]**,\n\nברצוננו להזכיר לך כי תקופת שכירות המכולה ([**מספר מכולה**]) מסתיימת בעוד **7 ימים** 🗓️. זה הזמן לנקוט פעולה!\n\nהאם תרצה להאריך את תקופת השכירות, להחליף את המכולה, או להזמין איסוף? ♻️', category: 'תזכורות', placeholders: ['שם לקוח', 'מספר מכולה'], emoji: '⏰' },
            { id: 'approaching_due_3_days', text: 'שלום **[שם לקוח]**,\n\nתקופת שכירות המכולה ([**מספר מכולה**]) מסתיימת ממש בקרוב, בעוד **3 ימים** ⚠️. אנא טפל בנושא כדי למנוע חריגות.\n\nאנו לרשותך לכל עזרה! 🙏', category: 'תזכורות', placeholders: ['שם לקוח', 'מספר מכולה'], emoji: '⏳' },
            { id: 'overdue_7_days', text: 'שלום **[שם לקוח]**,\n\nברצוננו להודיע לך על חריגה בימי שכירות של המכולה ([**מספר מכולה**]) ב-**[ימים שעברו] ימים** 🚨. נא ליצור קשר עם מחלקת הזמנות **097602010** או להשיב להודעה זו מה תרצה שנבצע (החלפה/הוצאה).', category: 'חריגות', placeholders: ['שם לקוח', 'מספר מכולה', 'ימים שעברו'], emoji: '❗️' },
            { id: 'overdue_30_days', text: '**התראה חמורה, [שם לקוח]:**\n\nהמכולה ([**מספר מכולה**]) שבשימושך חורגת ב-**[ימים שעברו] ימים**! יש לטפל בנושא בדחיפות כדי למנוע חיובים נוספים וסיבוכים משפטיים. ⚖️\n\n**צור קשר מיידית: 097602010.**', category: 'חריגות', placeholders: ['שם לקוח', 'מספר מכולה', 'ימים שעברו'], emoji: '🔴' },
            { id: 'overdue_long', text: '**לכבוד: [שם לקוח]**\n\n**הנדון: חוב בגין שכירות מכולה חורגת**\n\nאנו פונים אליך בהתייחס לחשבונך, הנמצא בחריגה משמעותית של [**ימים שעברו**] ימים עבור מכולה ([**מספר מכולה**]).\n\nבהיעדר הסדרה מיידית, אנו נאלצים לנקוט בצעדים משפטיים לגבייה. אנו קוראים לך ליצור קשר דחוף להסדר: **097602010**.', category: 'משפטי', placeholders: ['שם לקוח', 'מספר מכולה', 'ימים שעברו'], emoji: '' },
            { id: 'general_inquiry', text: 'שלום **[שם לקוח]**,\n\nאיך אנחנו יכולים לעזור לך היום? 🤔 אם יש לך שאלות, בקשות או תזכורות, אל תהסס לפנות אלינו. אנחנו כאן בשבילך! ✨', category: 'כללי', placeholders: ['שם לקוח'], emoji: '💬' },
            { id: 'payment_reminder', text: 'שלום **[שם לקוח]**,\n\nתזכורת ידידותית לגבי תשלום חשבונית מספר **[תעודה]** 💰. אנו מודים לך על תשומת הלב המהירה ועל המשך שיתוף הפעולה.', category: 'תזכורות', placeholders: ['שם לקוח', 'תעודה'], emoji: '💲' },
            { id: 'service_feedback', text: 'שלום **[שם לקוח]**,\n\nאנו מקווים ששירותינו עונים על ציפיותיך. נשמח לקבל משוב על החוויה שלך עם מכולה מספר **[מספר מכולה]** כדי שנוכל להשתפר ולהעניק לך שירות טוב יותר. ⭐', category: 'משוב', placeholders: ['שם לקוח', 'מספר מכולה'], emoji: '📝' },
            { id: 'holiday_greetings', text: 'חג שמח, **[שם לקוח]**! 🎉\n\nצוות [שם החברה] מאחל לך ולמשפחתך חג שמח, מלא שלווה, בריאות והמון שמחה! 🥳', category: 'עונתי', placeholders: ['שם לקוח'], emoji: '🎁' },
            { id: 'special_offer', text: 'שלום **[שם לקוח]**,\n\nיש לנו חדשות מרגשות! 🎁 מבצע מיוחד למכולות חדשות/נוספות עבורך. אל תחמיץ! לפרטים נוספים, השב להודעה זו או התקשר: **097602010**.', category: 'שיווק', placeholders: ['שם לקוח'], emoji: '✨' },
            { id: 'follow_up_issue', text: 'שלום **[שם לקוח]**,\n\nאנחנו חוזרים אליך לגבי הנושא שדיווחת עליו בתעודה **[תעודה]** 🛠️. האם הבעיה נפתרה לשביעות רצונך? אם לא, אנא הודע לנו כדי שנוכל להמשיך לטפל.', category: 'תמיכה', placeholders: ['שם לקוח', 'תעודה'], emoji: '✅' },
            { id: 'document_reminder', text: 'שלום **[שם לקוח]**,\n\nתזכורת לשליחת המסמכים החסרים עבור הזמנה **[תעודה]** 📄. אנא שלח אותם בהקדם כדי שנוכל להשלים את הטיפול בהזמנה.\n\nתודה על שיתוף הפעולה!', category: 'תזכורות', placeholders: ['שם לקוח', 'תעודה'], emoji: '📌' },
            { id: 'service_confirmation', text: 'שלום **[שם לקוח]**,\n\nהשירות שהוזמן (תעודה **[תעודה]**) אושר ויתבצע ב-**[תאריך סיום צפוי]** ✅. תודה שבחרת בנו ושיהיה יום נפלא!', category: 'אישור', placeholders: ['שם לקוח', 'תעודה', 'תאריך סיום צפוי'], emoji: '👍' },
            { id: 'service_delay', text: 'שלום **[שם לקוח]**,\n\nעקב נסיבות בלתי צפויות, ייתכן שיהיה עיכוב קל בטיפול בהזמנה **[תעודה]** ⏱️. אנו מתנצלים על אי הנוחות ונפעל לפתור זאת במהירות האפשרית.\n\nנודיע לך על כל עדכון! 🔜', category: 'מידע', placeholders: ['שם לקוח', 'תעודה'], emoji: '🚧' },
            { id: 'location_update_request', text: 'שלום **[שם לקוח]**,\n\nכדי שנוכל לתאם את השירות בצורה הטובה ביותר, אנא וודא שמיקום המכולה ([**מספר מכולה**]) מעודכן ומדויק 📍. זה חשוב להגעה יעילה!', category: 'תזכורות', placeholders: ['שם לקוח', 'מספר מכולה'], emoji: '🗺️' },
            { id: 'happy_birthday', text: 'יום הולדת שמח, **[שם לקוח]**! 🎉�\n\nצוות [שם החברה] מאחל לך יום מלא בשמחה, בריאות, הגשמה והרבה רגעים מתוקים! 🥳', category: 'עונתי', placeholders: ['שם לקוח'], emoji: '🎈' },
            { id: 'review_invitation', text: 'שלום **[שם לקוח]**,\n\nנהנית מהשירות שלנו? ✨ נשמח אם תוכל להקדיש רגע ולכתוב לנו ביקורת קצרה כאן: [**לינק לביקורת**]. תודה מראש על עזרתך להשתפר! 🙏', category: 'משוב', placeholders: ['שם לקוח', 'לינק לביקורת'], emoji: '🌟' },
            { id: 'tech_support_contact', text: 'שלום **[שם לקוח]**,\n\nלכל בעיה טכנית או תפעולית עם המכולה ([**מספר מכולה**]), מחלקת התמיכה שלנו זמינה עבורך 🧑‍🔧.\n\n**צור קשר: 097602010.**', category: 'תמיכה', placeholders: ['שם לקוח', 'מספר מכולה'], emoji: '🔧' },
            { id: 'general_thanks', text: 'תודה רבה לך, **[שם לקוח]**, על שיתוף הפעולה והאמון ב[שם החברה]! 🙏\n\nאנו מעריכים את בחירתך בנו ומקווים להמשיך לשרת אותך נאמנה. 💖', category: 'כללי', placeholders: ['שם לקוח'], emoji: '😊' },
            { id: 'multi_container_reminder', text: 'שלום **[שם לקוח]**,\n\nשמנו לב שברשותך **מספר מכולות פעילות** 🏗️. אנו כאן כדי לוודא שכל הצרכים שלך מסופקים.\n\nהאם יש משהו שנוכל לעזור בו בנוגע למכולות שלך? אל תהסס לפנות! 🤝', category: 'תזכורות', placeholders: ['שם לקוח'], emoji: '📦' }
        ];

        // Simulated city guidelines data (in a real app, this would come from a database)
        const cityGuidelines = {
            'הרצליה': {
                id: 'herzliya_permit',
                text: 'הנחיה חשובה לתושבי הרצליה:\nכדי להציב מכולת פסולת בניין ברחוב בהרצליה, יש להגיש בקשה מראש לאגף הפיקוח העירוני. הבקשה כרוכה בתשלום אגרה ונדרש אישור בכתב. מומלץ לוודא את כל הפרטים באתר העירייה או בטלפון.\n\nקישור למידע: https://www.herzliya.muni.il/pages/%D7%90%D7%92%D7%A8%D7%95%D7%AA%20%D7%95%D7%94%D7%99%D7%AA%D7%A8%D7%99%D7%9D',
                link: 'https://www.herzliya.muni.il/pages/%D7%90%D7%92%D7%A8%D7%95%D7%AA%20%D7%95%D7%94%D7%99%D7%AA%D7%A8%D7%99%D7%9D',
                category: 'היתרים עירוניים',
                placeholders: [],
                emoji: '📝'
            },
            'רעננה': {
                id: 'raanana_permit',
                text: 'הנחיה חשובה לתושבי רעננה:\nברעננה, חל איסור מוחלט להשאיר מכולות פסולת בניין במקום ציבורי (ברחוב) בסופי שבוע ובחגים. יש לדאוג להזמין פינוי לפני כניסת השבת/חג. קנסות יינתנו למפרים. אנא הקפד על הנחיות אלו.\n\nמידע נוסף: https://www.raanana.muni.il/pages/%D7%A4%D7%A1%D7%95%D7%9C%D7%AA-%D7%91%D7%A0%D7%99%D7%99%D7%9F',
                link: 'https://www.raanana.muni.il/pages/%D7%A4%D7%A1%D7%95%D7%9C%D7%AA-%D7%91%D7%A0%D7%99%D7%99%D7%9F',
                category: 'היתרים עירוניים',
                placeholders: [],
                emoji: '🚫'
            },
            'תל אביב': {
                id: 'telaviv_permit',
                text: 'הנחיה חשובה לתושבי תל אביב:\nבתל אביב, הצבת מכולות פסולת ברחוב מחייבת קבלת היתר מהעירייה. יש להגיש בקשה מקוונת ולצרף את כל המסמכים הנדרשים. שימו לב להנחיות המדויקות לגבי סימון המכולה ומשך ההצבה.\n\nלמידע והגשת בקשה: https://www.tel-aviv.muni.il/Bussiness/Construction/Pages/WasteContainers.aspx',
                link: 'https://www.tel-aviv.muni.il/Bussiness/Construction/Pages/WasteContainers.aspx',
                category: 'היתרים עירוניים',
                placeholders: [],
                emoji: '🏛️'
            }
        };


        let typingInterval;
        let currentMessageFullText = '';
        let typingIndex = 0;

        /**
         * Selects a message and displays it with a typing effect.
         * @param {string} messageId - The ID of the message to display.
         * @param {Object} placeholders - Object with placeholder values.
         */
        function selectAndTypeMessage(messageId, placeholders = {}) {
            clearInterval(typingInterval);
            const message = whatsappMessages.find(msg => msg.id === messageId);
            const textarea = document.getElementById('whatsapp-message-textarea');
            const typingDisplay = document.getElementById('typing-effect-display');

            if (message) {
                currentMessageFullText = message.text;
                // Replace placeholders
                for (const key in placeholders) {
                    currentMessageFullText = currentMessageFullText.replace(new RegExp(`\\[${key}\\]`, 'g'), placeholders[key]);
                }
                
                typingIndex = 0;
                typingDisplay.textContent = '';
                textarea.value = ''; // Clear textarea initially

                typingInterval = setInterval(() => {
                    if (typingIndex < currentMessageFullText.length) {
                        typingDisplay.textContent += currentMessageFullText.charAt(typingIndex);
                        typingIndex++;
                    } else {
                        clearInterval(typingInterval);
                        textarea.value = currentMessageFullText; // Put full text in textarea for editing
                        typingDisplay.textContent = ''; // Clear typing display
                    }
                }, 30); // Typing speed in ms
            }
        }

        /**
         * Extracts city name from a given address string.
         * This is a simplified approach, assuming the city is often the last part of the address.
         * @param {string} address - The full address string.
         * @returns {string|null} The extracted city name or null if not found.
         */
        function getCityFromAddress(address) {
            if (!address) return null;
            const parts = address.split(',').map(s => s.trim());
            const israeliCities = [
                "תל אביב", "ירושלים", "חיפה", "ראשון לציון", "פתח תקווה", "אשדוד", "באר שבע",
                "נתניה", "בני ברק", "חולון", "רמת גן", "רחובות", "אשקלון", "בת ים", "הרצליה",
                "כפר סבא", "חדרה", "בית שמש", "מודיעין-מכבים-רעות", "לוד", "רמלה", "רעננה",
                "נהריה", "קריית גת", "אילת", "עכו", "צפת", "טבריה", "נצרת", "אום אל-פאחם",
                "בני ציון", "אבן יהודה", "אור יהודה", "אור עקיבא", "אריאל", "אשקלון", "באקה אל-גרבייה",
                "גבעתיים", "דימונה", "הוד השרון", "זכרון יעקב", "יבנה", "יהוד-מונוסון", "יוקנעם עילית",
                "כוכב יאיר", "כפר יונה", "כפר קאסם", "כרמיאל", "מגדל העמק", "מכבים", "מעלה אדומים",
                "מצפה רמון", "נהריה", "נס ציונה", "נשר", "עפולה", "ערד", "פרדס חנה-כרכור",
                "קריית אונו", "קריית ביאליק", "קריית ים", "קריית מוצקין", "קריית שמונה",
                "שוהם", "שדרות", "רמת השרון"
            ].sort((a,b) => b.length - a.length);

            for (const city of israeliCities) {
                if (address.includes(city)) {
                    return city;
                }
            }
            if (parts.length > 0) {
                return parts[parts.length - 1];
            }
            return null;
        }

        /**
         * Populates message options and opens the WhatsApp modal.
         * @param {string} phoneNumber - The customer's phone number.
         * @param {string} suggestedMessageId - The ID of the message to pre-select.
         * @param {number|null} orderSheetRow - The sheet row of the order, for logging.
         * @param {string} customerName - The customer's name for placeholders.
         * @param {number|null} daysOverdue - Days overdue for overdue messages.
         * @param {string} containerNum - Container number for relevant messages.
         * @param {string|null} docId - Document ID (תעודה) for messages.
         * @param {string|null} expectedEndDate - Expected end date for messages.
         * @param {string|null} customerAddress - Customer's full address to derive city for guidelines.
         * @param {string|null} reviewLink - Link for review requests.
         */
        function openWhatsAppModal(phoneNumber, suggestedMessageId = 'general_inquiry', orderSheetRow = null, customerName = 'לקוח יקר', daysOverdue = 0, containerNum = '', docId = '', expectedEndDate = '', customerAddress = '', reviewLink = 'https://example.com/review') {
            const modal = document.getElementById('whatsapp-modal');
            const phoneInput = document.getElementById('whatsapp-phone-input');
            const messageOptionsListDiv = document.getElementById('message-options-list');
            const currentOrderSheetRowInput = document.getElementById('whatsapp-current-order-sheet-row');
            
            const phoneString = String(phoneNumber);
            phoneInput.value = phoneString.startsWith('972') ? phoneString : `972${phoneString.substring(1)}`;
            currentOrderSheetRowInput.value = orderSheetRow !== null ? orderSheetRow : '';

            const customerCity = getCityFromAddress(customerAddress);
            let dynamicMessages = [];
            if (customerCity && cityGuidelines[customerCity]) {
                const guideline = cityGuidelines[customerCity];
                dynamicMessages.push({
                    id: `city_guideline_${customerCity}`,
                    text: `**הנחיית עיריית ${customerCity}:**\n${guideline.text}\n\nלמידע וטפסים נוספים: ${guideline.link}`,
                    category: 'היתרים עירוניים',
                    placeholders: [],
                    emoji: guideline.emoji
                });
            }

            const allAvailableMessages = [...whatsappMessages];
            if (dynamicMessages.length > 0) {
                allAvailableMessages.unshift(...dynamicMessages);
            }

            messageOptionsListDiv.innerHTML = '';
            allAvailableMessages.forEach(msg => {
                const optionDiv = document.createElement('div');
                optionDiv.className = `message-option-item`;
                if (msg.id === suggestedMessageId) {
                    optionDiv.classList.add('selected');
                }
                const displayEmoji = msg.category === 'משפטי' ? '' : (msg.emoji || '');
                const displayMsg = `**${displayEmoji} ${msg.category}:** ${msg.text.replace(/\[.*?\]/g, '...').substring(0, 60)}...`;
                optionDiv.innerHTML = displayMsg;

                optionDiv.onclick = () => {
                    document.querySelectorAll('.message-option-item').forEach(item => item.classList.remove('selected'));
                    optionDiv.classList.add('selected');
                    const placeholders = {
                        'שם לקוח': customerName,
                        'ימים שעברו': daysOverdue,
                        'מספר מכולה': containerNum,
                        'תעודה': docId,
                        'תאריך סיום צפוי': expectedEndDate,
                        'לינק לביקורת': reviewLink
                    };
                    selectAndTypeMessage(msg.id, placeholders);
                };
                messageOptionsListDiv.appendChild(optionDiv);
            });

            const defaultSelectedOption = messageOptionsListDiv.querySelector(`.message-option-item.selected`);
            if (defaultSelectedOption) {
                defaultSelectedOption.click();
            } else if (allAvailableMessages.length > 0) {
                messageOptionsListDiv.querySelector('.message-option-item').click();
            }

            const messageOptionsContainer = document.getElementById('whatsapp-message-options');
            messageOptionsContainer.classList.add('expanded');
            messageOptionsContainer.style.maxHeight = messageOptionsContainer.scrollHeight + "px";
            document.querySelector('.message-option-header').classList.remove('collapsed');


            if (isMobile()) {
                modal.classList.add('mobile-drawer');
            } else {
                modal.classList.remove('mobile-drawer');
            }
            modal.classList.add('active');
        }

        function closeWhatsAppModal() {
            document.getElementById('whatsapp-modal').classList.remove('active');
            clearInterval(typingInterval); // Stop typing effect
        }

        /**
         * Toggles the visibility of the message options accordion.
         */
        function toggleMessageOptions() {
            const container = document.getElementById('whatsapp-message-options');
            const header = document.querySelector('.message-option-header');
            if (container.classList.contains('expanded')) {
                container.classList.remove('expanded');
                container.style.maxHeight = null;
                header.classList.add('collapsed');
            } else {
                container.classList.add('expanded');
                container.style.maxHeight = container.scrollHeight + "px";
                header.classList.remove('collapsed');
            }
        }

        /**
         * Filters the message options based on user input.
         */
        function filterMessageOptions() {
            const input = document.getElementById('message-filter-input');
            const filter = input.value.toLowerCase();
            const messageItems = document.querySelectorAll('#message-options-list .message-option-item');

            messageItems.forEach(item => {
                const text = item.textContent || item.innerText;
                if (text.toLowerCase().indexOf(filter) > -1) {
                    item.style.display = "";
                } else {
                    item.style.display = "none";
                }
            });
            const container = document.getElementById('whatsapp-message-options');
            if (container.classList.contains('expanded')) {
                container.style.maxHeight = container.scrollHeight + "px";
            }
        }


        /**
         * Sends the WhatsApp message to the entered number.
         */
        function sendWhatsAppMessage() {
            const phoneInput = document.getElementById('whatsapp-phone-input');
            const messageTextarea = document.getElementById('whatsapp-message-textarea');
            const orderSheetRow = document.getElementById('whatsapp-current-order-sheet-row').value;

            const phoneNumber = phoneInput.value.trim().replace(/\D/g, ''); 
            const message = messageTextarea.value.trim();

            if (!phoneNumber) {
                showAlert('אנא הזן מספר טלפון תקין.', 'error');
                return;
            }
            if (!message) {
                showAlert('תוכן ההודעה לא יכול להיות ריק.', 'error');
                return;
            }

            const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            showAlert('ההודעה נשלחה ל-WhatsApp (נפתח חלון חדש).', 'success', 5000);
            closeWhatsAppModal();

            if (orderSheetRow) {
                logWhatsAppMessage(parseInt(orderSheetRow), message);
            }
        }

        /**
         * Logs the sent WhatsApp message to the order's notes in the backend.
         * @param {number} sheetRow - The row number of the order in the Google Sheet.
         * @param {string} message - The message text that was sent.
         */
        async function logWhatsAppMessage(sheetRow, message) {
            const timestamp = new Date().toLocaleString('he-IL', { year: 'numeric', month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            const noteToLog = `[נשלח וואטסאפ: ${timestamp}] ${message}`;

            const orderIndex = allOrders.findIndex(order => order.sheetRow === sheetRow);
            if (orderIndex !== -1) {
                const currentNotes = allOrders[orderIndex]['הערות'] || '';
                allOrders[orderIndex]['הערות'] = currentNotes ? `${currentNotes}\n${noteToLog}` : noteToLog;
            }

            const response = await fetchData('updateOrderNote', { sheetRow: sheetRow, note: noteToLog });
            if (response.success) {
                console.log('WhatsApp message logged to backend successfully.');
            } else {
                console.error('Failed to log WhatsApp message to backend:', response.message);
                showAlert('שגיאה בתיעוד ההודעה במערכת.', 'error');
            }
        }

        /**
         * Determines the most appropriate WhatsApp message ID for a given order.
         * @param {Object} order - The order object.
         * @returns {string} The ID of the suggested message.
         */
        function getSuggestedMessageIdForOrder(order) {
            const daysOverdue = parseInt(order['ימים שעברו']) || 0;
            const orderDate = new Date(order['תאריך הזמנה']);
            const today = new Date();
            const daysSinceOrder = Math.floor((today - orderDate) / (1000 * 60 * 60 * 24));

            if (order['סטטוס'] === 'חורג') {
                if (daysOverdue <= 7) return 'overdue_7_days';
                if (daysOverdue <= 30) return 'overdue_30_days';
                return 'overdue_long'; 
            }
            
            if (order['סטטוס'] === 'פתוח' && order['תאריך סיום צפוי']) {
                const expectedEndDate = new Date(order['תאריך סיום צפוי']);
                const daysUntilDue = Math.floor((expectedEndDate - today) / (1000 * 60 * 60 * 24));
                if (daysUntilDue <= 3 && daysUntilDue >= 0) return 'approaching_due_3_days';
                if (daysUntilDue <= 7 && daysUntilDue > 3) return 'approaching_due_7_days';
            }

            if (daysSinceOrder <= 30 && order['מספר מכולה ירדה'] && order['סוג פעולה'] === 'הורדה') {
                const customerOrders = allOrders.filter(o => o['שם לקוח'] === order['שם לקוח'] && o['כתובת'] === order['כתובת']);
                if (customerOrders.length === 1) { 
                    return 'new_customer_welcome';
                }
            }
            
            const customerCity = getCityFromAddress(order['כתובת']);
            if (customerCity && cityGuidelines[customerCity]) {
                return `city_guideline_${customerCity}`;
            }

            return 'general_inquiry';
        }


        // --- Back to Top Button Logic ---
        const backToTopBtn = document.getElementById("back-to-top-btn");

        window.onscroll = function() { scrollFunction() };

        function scrollFunction() {
            if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
                backToTopBtn.style.display = "block";
            } else {
                backToTopBtn.style.display = "none";
            }
        }

        backToTopBtn.addEventListener('click', topFunction);

        function topFunction() {
            window.scrollTo({ top: 0, behavior: 'smooth' }); 
        }

        // Initial Load and Event Listeners
        window.onload = () => {
            initializeThemeCrm(); // Initialize theme for this page
            initializeDataTables(); // Initialize DataTables at load
            loadAllData(); // Loads all data and applies default filter
            updateDateTimeCrm();
            setInterval(updateDateTimeCrm, 1000);
            
            // Re-draw charts on resize to make them responsive
            window.addEventListener('resize', () => {
                destroyChartInstances(); // Destroy before redraw
                drawCharts();
            });
        };
    </script>
</body>
</html>

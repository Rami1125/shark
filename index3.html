<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>לוח בקרה לניהול מכולות - עיצוב משודרג</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
  /* הגדרות כלליות */
  body {
    font-family: 'Heebo', sans-serif;
    direction: rtl;
    background: linear-gradient(135deg, #e0f2f7, #f0f8ff); /* רקע בהיר: כחול בהיר מאוד ולבן */
    color: #333; /* טקסט כהה */
    min-height: 100vh;
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  h1 {
    color: #4f46e5; /* כחול כהה לכותרות */
    text-align: center;
    margin-bottom: 25px;
    font-weight: 700;
    font-size: 2.5rem;
    text-shadow: 1px 1px 3px rgba(0,0,0,0.1);
  }

  /* כפתורים, אינפוטים וסלקטים בעיצוב מודרני */
  .controls button, .controls input, .controls select {
    border: none;
    border-radius: 12px;
    padding: 12px 20px;
    font-size: 1rem;
    outline: none;
    transition: all 0.3s ease;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1); /* צל עדין */
  }

  .controls button {
    background: #7c3aed; /* סגול נוצץ */
    color: #fff;
    cursor: pointer;
    font-weight: 600;
    position: relative;
    overflow: hidden;
  }
  .controls button:hover {
    background: #8b5cf6; /* סגול בהיר יותר במעבר עכבר */
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.2);
  }
  .controls button:active {
    transform: translateY(0);
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  }

  /* אפקט נצנצים על כפתור */
  .controls button::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(120deg, transparent, rgba(255,255,255,0.4), transparent);
    transition: all 0.6s ease;
  }
  .controls button:hover::before {
    left: 100%;
  }

  .controls input, .controls select {
    background: #f0f8ff; /* לבן בהיר */
    color: #333;
    border: 1px solid #d1d5db;
  }
  .controls input::placeholder {
    color: #6b7280;
  }

  /* מדדים */
  .metric {
    background: #fff;
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 25px;
    text-align: center;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    box-shadow: 0 6px 15px rgba(0,0,0,0.1);
    border: 1px solid #e2e8f0;
  }
  .metric:hover {
    transform: translateY(-8px);
    box-shadow: 0 12px 30px rgba(0,0,0,0.2);
  }
  .metric span {
    display: block;
    margin-top: 10px;
    font-size: 2.2rem;
    font-weight: 700;
    color: #7c3aed; /* סגול */
  }

  /* גרפים */
  canvas {
    background: #fff;
    backdrop-filter: blur(10px);
    border-radius: 20px;
    margin-bottom: 25px;
    padding: 15px;
    box-shadow: 0 6px 15px rgba(0,0,0,0.1);
    border: 1px solid #e2e8f0;
  }

  /* טבלה */
  .table-wrapper {
    overflow-x: auto; /* מאפשר גלילה אופקית במידת הצורך */
    margin-bottom: 30px;
    width: 100%;
    max-width: 1200px;
    border-radius: 20px;
    box-shadow: 0 6px 15px rgba(0,0,0,0.1);
  }
  table {
    width: 100%; /* הטבלה תמיד תמלא את רוחב ההורה שלה */
    border-collapse: separate; /* מאפשר border-radius על tr */
    border-spacing: 0;
    /* min-width: 1000px; -- הוסר כדי לאפשר לטבלה להצטמצם במסכים קטנים */
    background: #fff;
    border-radius: 20px;
    overflow: hidden; /* חיוני ל-border-radius */
  }
  th, td {
    padding: 15px 12px;
    text-align: center;
    transition: background 0.3s ease;
    border-bottom: 1px solid #f0f0f0; /* קו הפרדה דק */
    color: #333;
    white-space: nowrap; /* מונע שבירת שורות בתאים כדי לשמור על קריאות */
  }
  th {
    background: #e9d5ff; /* סגול בהיר מאוד לכותרות עמודות */
    font-weight: 600;
    color: #5b21b6; /* סגול כהה יותר */
    position: sticky;
    top: 0;
    z-index: 1;
  }
  tr:nth-child(even) {
    background: #f8fafc; /* רקע פסים לטבלה */
  }
  tr:hover td {
    background: #eef7ff; /* כחול בהיר במעבר עכבר */
  }

  button.edit-btn {
    background: #f97316;
    color: #fff;
    border-radius: 10px;
    padding: 8px 14px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
    box-shadow: 0 3px 8px rgba(0,0,0,0.2);
  }
  button.edit-btn:hover {
    transform: scale(1.08);
    background: #fb923c;
    box-shadow: 0 6px 15px rgba(0,0,0,0.3);
  }

  /* Popup */
  .popup-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.6); /* רקע כהה יותר */
    justify-content: center;
    align-items: center;
    z-index: 1000;
    animation: fadeIn 0.3s ease-out;
  }
  .popup {
    background: #fff;
    backdrop-filter: blur(20px);
    padding: 30px;
    border-radius: 25px;
    width: 90%;
    max-width: 550px;
    position: relative;
    box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    border: 1px solid #e2e8f0;
    animation: slideIn 0.4s ease-out;
  }
  .popup h2 {
    color: #4f46e5;
    text-align: center;
    margin-bottom: 20px;
    font-size: 2rem;
    font-weight: 700;
  }
  .popup label {
    display: block;
    margin: 12px 0 6px;
    font-weight: 500;
    color: #555;
  }
  .popup input {
    width: 100%;
    padding: 10px 12px;
    border-radius: 10px;
    border: 1px solid #d1d5db;
    background: #f8fafc;
    color: #333;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
  }
  .popup input:focus {
    border-color: #7c3aed;
    box-shadow: 0 0 0 3px rgba(124,58,237,0.2);
  }
  .popup button {
    margin-top: 25px;
    width: 100%;
    padding: 12px;
    border-radius: 12px;
    background: #7c3aed;
    color: #fff;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  }
  .popup button:hover {
    background: #8b5cf6;
    transform: translateY(-2px);
    box-shadow: 0 6px 15px rgba(0,0,0,0.2);
  }
  .popup .close {
    position: absolute;
    top: 15px;
    left: 15px;
    cursor: pointer;
    font-size: 28px;
    font-weight: 300;
    color: #666;
    transition: color 0.3s ease;
  }
  .popup .close:hover {
    color: #e04c4c;
  }

  /* אנימציות */
  @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }
  @keyframes slideIn { from{transform:translateY(-50px); opacity:0;} to{transform:translateY(0); opacity:1;} }

  /* רספונסיביות */
  @media(max-width: 1024px) {
    .controls {
      flex-direction: column;
      align-items: center;
    }
    .controls button, .controls input, .controls select {
      width: 100%;
      margin-bottom: 10px;
    }
    .metrics {
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
    }
    h1 { font-size: 2rem; }
    .metric span { font-size: 1.8rem; }
  }

  @media(max-width: 600px){
    body { padding: 10px; }
    h1 { font-size: 1.8rem; margin-bottom: 20px; }
    .metrics { grid-template-columns: 1fr; }
    .metric { padding: 20px; }
    .table-wrapper { border-radius: 15px; }
    /* table { min-width: unset; } -- כבר לא נחוץ כי הסרנו את min-width הכללי מהטבלה */
    th, td { padding: 10px 8px; font-size: 0.9rem; }
    .popup { padding: 20px; border-radius: 20px; }
    .popup h2 { font-size: 1.8rem; }
  }

  /* הודעות משתמש (במקום alert) */
  #messageBox {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #333;
    color: #fff;
    padding: 15px 30px;
    border-radius: 10px;
    z-index: 1001;
    font-size: 1.1rem;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    text-align: center;
  }
</style>
</head>
<body>

<div id="messageBox"></div>

<h1><span class="text-indigo-600">לוח בקרה</span> <span class="text-purple-600">לניהול מכולות</span></h1>

<!-- Controls -->
<div class="controls flex flex-wrap gap-4 justify-center mb-6 w-full max-w-4xl">
  <button id="newOrderBtn" class="flex-grow">➕ הזמנה חדשה</button>
  <button id="refreshBtn" class="flex-grow">🔄 רענן נתונים</button>
  <input type="text" id="searchInput" placeholder="הקלד לחיפוש..." class="flex-grow min-w-[200px]">
  <select id="actionFilter" class="flex-grow min-w-[150px]"></select>
  <input type="number" id="daysMax" placeholder="ימים שעברו (מקסימום)" class="flex-grow min-w-[180px]">
</div>

<!-- Metrics -->
<div class="metrics grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6 w-full max-w-4xl">
  <div class="metric">סה"כ פתוחות: <span id="totalOpen">0</span></div>
  <div class="metric">חריגות (&gt; 10 ימים): <span id="overdue">0</span></div>
  <div class="metric">פעולות איסוף היום: <span id="todayActions">0</span></div>
  <div class="metric">ממוצע ימים שעברו: <span id="avgDays">0.0</span></div>
</div>

<!-- Graphs -->
<canvas id="actionChart" height="200" class="w-full max-w-4xl mb-6"></canvas>
<canvas id="daysChart" height="200" class="w-full max-w-4xl mb-6"></canvas>

<!-- Table -->
<div class="table-wrapper">
  <table id="ordersTable">
    <thead>
      <tr>
        <th>תעודה</th>
        <th>שם לקוח</th>
        <th>שם סוכן</th>
        <th>מתאריך</th>
        <th>סוג פעולה</th>
        <th>ימים שעברו</th>
        <th>מס" מכולה ירדה</th>
        <th>מס" מכולה עלתה</th>
        <th>ימים שעברו (עלתה)</th>
        <th>פעולות</th>
      </tr>
    </thead>
    <tbody><tr><td colspan="10">לא נמצאו הזמנות תואמות.</td></tr></tbody>
  </table>
</div>

<!-- Popup -->
<div class="popup-overlay" id="popupOverlay">
  <div class="popup" id="popup">
    <span class="close" onclick="closePopup()">×</span>
    <h2>עריכת פרטי הזמנה</h2>
    <div id="popupFields"></div>
    <button onclick="savePopup()">שמור שינויים</button>
  </div>
</div>

<script>
  // URL לסקריפט של Google Apps Script
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx7E0OrpJc7Yq4xhFTj376xVMo9VfvhLAjDZ6zdt8QGzXvlzKkANZxn4cV5AfvDPQ0m/exec';
  let allOrders = [];
  let currentEdit = null;
  let actionChartInstance = null; // משתנה לשמירת מופע הגרף
  let daysChartInstance = null; // משתנה לשמירת מופע הגרף

  // פונקציה להצגת הודעות למשתמש (במקום alert)
  function showMessage(message, duration = 3000) {
    const messageBox = document.getElementById('messageBox');
    messageBox.textContent = message;
    messageBox.style.display = 'block';
    setTimeout(() => {
      messageBox.style.display = 'none';
    }, duration);
  }

  // אירועי לחיצה וקלט
  document.getElementById('refreshBtn').addEventListener('click', fetchOrders);
  document.getElementById('searchInput').addEventListener('input', filterOrders);
  document.getElementById('actionFilter').addEventListener('change', filterOrders);
  document.getElementById('daysMax').addEventListener('input', filterOrders); // הוספת האזנה גם לשדה ימים מקסימום
  document.getElementById('newOrderBtn').addEventListener('click', newOrder);

  // פונקציה לטעינת הזמנות מהשרת
  async function fetchOrders() {
    showMessage('טוען נתונים...');
    try {
      const res = await fetch(`${SCRIPT_URL}?action=list`);
      const data = await res.json();
      if (data.success) {
        allOrders = data.data;
        populateActionFilter();
        updateDashboard(allOrders);
        showMessage('הנתונים נטענו בהצלחה!', 2000);
      } else {
        showMessage('שגיאה בטעינת הנתונים: ' + (data.message || 'שגיאה לא ידועה'), 5000);
      }
    } catch (error) {
      console.error('שגיאה ב-fetchOrders:', error);
      showMessage('שגיאה בתקשורת עם השרת. אנא נסה שוב מאוחר יותר.', 5000);
    }
  }

  // פונקציה למילוי פילטר הפעולות
  function populateActionFilter() {
    const select = document.getElementById('actionFilter');
    // יצירת מערך ייחודי של סוגי פעולות
    const actions = [...new Set(allOrders.map(o => o['סוג פעולה']).filter(a => a))];
    // מנקה את האפשרויות הקיימות ומוסיף אפשרות "כל סוגי הפעולה"
    select.innerHTML = '<option value="">כל סוגי הפעולה</option>';
    actions.forEach(a => {
      const option = document.createElement('option');
      option.value = a;
      option.textContent = a;
      select.appendChild(option);
    });
  }

  // פונקציה לסינון הזמנות
  function filterOrders() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const actionFilter = document.getElementById('actionFilter').value;
    const daysMaxInput = document.getElementById('daysMax').value;
    const daysMax = daysMaxInput === '' ? Infinity : parseInt(daysMaxInput); // אם ריק, אין הגבלת ימים

    const filtered = allOrders.filter(o => {
      const matchesSearch = o['שם לקוח'] && o['שם לקוח'].toLowerCase().includes(searchTerm) ||
                            o['שם סוכן'] && o['שם סוכן'].toLowerCase().includes(searchTerm) ||
                            o['תעודה'] && o['תעודה'].toLowerCase().includes(searchTerm);
      const matchesAction = actionFilter ? (o['סוג פעולה'] === actionFilter) : true;
      const daysPassed = parseInt(o['ימים שעברו']) || 0; // טיפול במקרה של ערך ריק או לא מספרי
      const matchesDays = daysPassed <= daysMax;
      return matchesSearch && matchesAction && matchesDays;
    });
    updateDashboard(filtered);
  }

  // פונקציה לעדכון לוח הבקרה (טבלה, מדדים, גרפים)
  function updateDashboard(orders) {
    const tbody = document.querySelector('#ordersTable tbody');
    tbody.innerHTML = ''; // מנקה את הטבלה
    if (orders.length === 0) {
      tbody.innerHTML = '<tr><td colspan="10" class="text-gray-500 py-4">לא נמצאו הזמנות תואמות.</td></tr>';
    } else {
      orders.forEach(o => {
        const tr = document.createElement('tr');
        // שימוש בתנאי עבור o['תעודה'] וכו' כדי למנוע הצגת 'undefined'
        tr.innerHTML = `
          <td>${o['תעודה'] || ''}</td>
          <td>${o['שם לקוח'] || ''}</td>
          <td>${o['שם סוכן'] || ''}</td>
          <td>${formatDate(o['מתאריך'])}</td>
          <td>${o['סוג פעולה'] || ''}</td>
          <td>${o['ימים שעברו'] || '0'}</td>
          <td>${o['מס" מכולה ירדה'] || ''}</td>
          <td>${o['מס" מכולה עלתה'] || ''}</td>
          <td>${o['ימים שעברו (עלתה)'] || '0'}</td>
          <td><button class="edit-btn" onclick="openPopup(${allOrders.indexOf(o)})">ערוך</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    // עדכון מדדים
    const totalOpen = orders.length;
    const overdue = orders.filter(o => (parseInt(o['ימים שעברו']) || 0) > 10).length;
    // יש לוודא שהתאריך של היום תואם את פורמט הנתונים
    const today = orders.filter(o => o['סוג פעולה'] === 'איסוף' && formatDate(o['מתאריך']) === new Date().toLocaleDateString('he-IL')).length;
    const sumDays = orders.reduce((sum, o) => sum + (parseInt(o['ימים שעברו']) || 0), 0);
    const avgDays = orders.length ? (sumDays / orders.length).toFixed(1) : '0.0';

    document.getElementById('totalOpen').textContent = totalOpen;
    document.getElementById('overdue').textContent = overdue;
    document.getElementById('todayActions').textContent = today;
    document.getElementById('avgDays').textContent = avgDays;

    renderActionChart(orders);
    renderDaysChart(orders);
  }

  // פונקציה לעיצוב תאריך
  function formatDate(dateStr) {
    if (!dateStr) return '';
    try {
      const d = new Date(dateStr);
      if (isNaN(d)) {
        // אם Date() לא הצליח לפרסר, ננסה פרסור ידני לפורמט dd/mm/yyyy
        const parts = dateStr.split('/');
        if (parts.length === 3) {
            const day = parseInt(parts[0]);
            const month = parseInt(parts[1]) - 1; // חודשים ב-JavaScript הם 0-11
            const year = parseInt(parts[2]);
            const dParsed = new Date(year, month, day);
            if (!isNaN(dParsed)) {
                return `${String(dParsed.getDate()).padStart(2, '0')}/${String(dParsed.getMonth() + 1).padStart(2, '0')}/${dParsed.getFullYear()}`;
            }
        }
        return dateStr; // מחזיר את המקור אם לא ניתן לפרסר
      }
      return `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`;
    } catch (e) {
      console.error("שגיאה בפורמט התאריך:", dateStr, e);
      return dateStr; // במקרה של שגיאה, מחזיר את המחרוזת המקורית
    }
  }


  // פונקציה לרינדור גרף התפלגות סוגי פעולה
  function renderActionChart(orders) {
    const ctx = document.getElementById('actionChart').getContext('2d');
    const counts = {};
    orders.forEach(o => {
      counts[o['סוג פעולה'] || 'לא מוגדר'] = (counts[o['סוג פעולה'] || 'לא מוגדר'] || 0) + 1;
    });

    if (actionChartInstance) {
      actionChartInstance.destroy(); // הורס את המופע הקודם של הגרף
    }

    actionChartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: Object.keys(counts),
        datasets: [{
          label: 'התפלגות סוגי פעולה',
          data: Object.values(counts),
          backgroundColor: 'rgba(124, 58, 237, 0.7)', // סגול
          borderColor: 'rgba(124, 58, 237, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: {
              color: '#333'
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: { color: '#555' },
            grid: { color: 'rgba(0,0,0,0.05)' }
          },
          x: {
            ticks: { color: '#555' },
            grid: { color: 'rgba(0,0,0,0.05)' }
          }
        }
      }
    });
  }

  // פונקציה לרינדור גרף היסטוגרמת ימים שעברו
  function renderDaysChart(orders) {
    const ctx = document.getElementById('daysChart').getContext('2d');
    // חשוב לוודא שערכים הם מספרים
    const days = orders.map(o => parseInt(o['ימים שעברו']) || 0).sort((a, b) => a - b);

    if (daysChartInstance) {
      daysChartInstance.destroy(); // הורס את המופע הקודם של הגרף
    }

    // יצירת תוויות דינמיות עבור ציר X (כמו טווחים או ימים ספציפיים)
    const uniqueDays = [...new Set(days)].sort((a,b) => a-b);

    daysChartInstance = new Chart(ctx, {
      type: 'line', // שינוי לגרף קו להצגת מגמה
      data: {
        labels: uniqueDays, // תווית ציר X
        datasets: [{
          label: 'היסטוגרמת ימים שעברו',
          data: uniqueDays.map(day => days.filter(d => d === day).length), // ספירת מופעים לכל יום
          backgroundColor: 'rgba(249, 115, 22, 0.7)', // כתום
          borderColor: 'rgba(249, 115, 22, 1)',
          borderWidth: 2,
          fill: true,
          tension: 0.4 // עושה את הקו חלק יותר
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: {
              color: '#333'
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: { color: '#555' },
            grid: { color: 'rgba(0,0,0,0.05)' }
          },
          x: {
            ticks: { color: '#555' },
            grid: { color: 'rgba(0,0,0,0.05)' }
          }
        }
      }
    });
  }

  // פונקציה לניקוי מפתח משדות טופס (ללא תווי פיסוק)
  function sanitizeKey(key) {
    return key.replace(/[^a-zA-Z0-9\u0590-\u05FF]/g, "_"); // תומך בעברית
  }

  // פונקציה לפתיחת חלון קופץ לעריכה
  function openPopup(index) {
    currentEdit = index;
    const order = allOrders[index];
    const container = document.getElementById('popupFields');
    container.innerHTML = ''; // מנקה שדות קיימים
    for (const key in order) {
      const safeKey = sanitizeKey(key);
      // שימוש בטקסט אריאה לשדות ארוכים יותר, או סלקט לשדות עם אפשרויות קבועות
      let inputField;
      if (key === 'סוג פעולה') {
        inputField = `<select id="popup_${safeKey}" class="w-full p-2 border rounded">
                        <option value="איסוף" ${order[key] === 'איסוף' ? 'selected' : ''}>איסוף</option>
                        <option value="החזרה" ${order[key] === 'החזרה' ? 'selected' : ''}>החזרה</option>
                        <option value="הובלה" ${order[key] === 'הובלה' ? 'selected' : ''}>הובלה</option>
                        <option value="ריקון" ${order[key] === 'ריקון' ? 'selected' : ''}>ריקון</option>
                        <option value="אחר" ${order[key] === 'אחר' ? 'selected' : ''}>אחר</option>
                      </select>`;
      } else {
        inputField = `<input type="text" id="popup_${safeKey}" value="${order[key] || ''}">`;
      }
      container.innerHTML += `<label>${key}</label>${inputField}`;
    }
    document.getElementById('popupOverlay').style.display = 'flex';
  }

  // פונקציה לסגירת חלון קופץ
  function closePopup() {
    document.getElementById('popupOverlay').style.display = 'none';
  }

  // פונקציה לשמירת שינויים בחלון קופץ
  async function savePopup() {
    if (currentEdit === null) return;
    const order = allOrders[currentEdit];
    const updatedOrder = {};

    for (const key in order) {
      const safeKey = sanitizeKey(key);
      const el = document.getElementById(`popup_${safeKey}`);
      if (el) {
        updatedOrder[key] = el.value;
      }
    }

    showMessage('שומר שינויים...', 0); // הצג הודעה ללא זמן מוגבל

    try {
      const res = await fetch(`${SCRIPT_URL}?action=update&index=${currentEdit}`, {
        method: 'POST',
        body: JSON.stringify(updatedOrder),
        headers: { 'Content-Type': 'application/json' }
      });
      const result = await res.json();
      if (result.success) {
        // עדכון אובייקט allOrders באופן מקומי עם הנתונים המעודכנים
        allOrders[currentEdit] = updatedOrder;
        updateDashboard(allOrders); // רענן את לוח הבקרה עם הנתונים המעודכנים
        closePopup();
        showMessage('ההזמנה עודכנה בהצלחה!', 2000);
      } else {
        showMessage('שגיאה בעדכון ההזמנה: ' + (result.message || 'שגיאה לא ידועה'), 5000);
      }
    } catch (error) {
      console.error('שגיאה ב-savePopup:', error);
      showMessage('שגיאה בתקשורת עם השרת בעת שמירה. אנא נסה שוב.', 5000);
    }
  }

  // פונקציה ליצירת הזמנה חדשה
  function newOrder() {
    const newO = {
      'תעודה': '',
      'שם לקוח': '',
      'שם סוכן': '',
      'מתאריך': '',
      'סוג פעולה': '',
      'ימים שעברו': '0',
      'מס" מכולה ירדה': '',
      'מס" מכולה עלתה': '',
      'ימים שעברו (עלתה)': '0'
    };
    allOrders.push(newO); // הוסף את ההזמנה החדשה למערך
    openPopup(allOrders.length - 1); // פתח את הפופאפ עבור ההזמנה החדשה
  }

  // טעינה ראשונית של הנתונים
  fetchOrders();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>×œ×•×— ×‘×§×¨×” ×œ× ×™×”×•×œ ××›×•×œ×•×ª - ×¢×™×¦×•×‘ ××©×•×“×¨×’</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
  /* ×”×’×“×¨×•×ª ×›×œ×œ×™×•×ª */
  body {
    font-family: 'Heebo', sans-serif;
    direction: rtl;
    background: linear-gradient(135deg, #e0f2f7, #f0f8ff); /* ×¨×§×¢ ×‘×”×™×¨: ×›×—×•×œ ×‘×”×™×¨ ×××•×“ ×•×œ×‘×Ÿ */
    color: #333; /* ×˜×§×¡×˜ ×›×”×” */
    min-height: 100vh;
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  h1 {
    color: #4f46e5; /* ×›×—×•×œ ×›×”×” ×œ×›×•×ª×¨×•×ª */
    text-align: center;
    margin-bottom: 25px;
    font-weight: 700;
    font-size: 2.5rem;
    text-shadow: 1px 1px 3px rgba(0,0,0,0.1);
  }

  /* ×›×¤×ª×•×¨×™×, ××™× ×¤×•×˜×™× ×•×¡×œ×§×˜×™× ×‘×¢×™×¦×•×‘ ××•×“×¨× ×™ */
  .controls button, .controls input, .controls select {
    border: none;
    border-radius: 12px;
    padding: 12px 20px;
    font-size: 1rem;
    outline: none;
    transition: all 0.3s ease;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1); /* ×¦×œ ×¢×“×™×Ÿ */
  }

  .controls button {
    background: #7c3aed; /* ×¡×’×•×œ × ×•×¦×¥ */
    color: #fff;
    cursor: pointer;
    font-weight: 600;
    position: relative;
    overflow: hidden;
  }
  .controls button:hover {
    background: #8b5cf6; /* ×¡×’×•×œ ×‘×”×™×¨ ×™×•×ª×¨ ×‘××¢×‘×¨ ×¢×›×‘×¨ */
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.2);
  }
  .controls button:active {
    transform: translateY(0);
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  }

  /* ××¤×§×˜ × ×¦× ×¦×™× ×¢×œ ×›×¤×ª×•×¨ */
  .controls button::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(120deg, transparent, rgba(255,255,255,0.4), transparent);
    transition: all 0.6s ease;
  }
  .controls button:hover::before {
    left: 100%;
  }

  .controls input, .controls select {
    background: #f0f8ff; /* ×œ×‘×Ÿ ×‘×”×™×¨ */
    color: #333;
    border: 1px solid #d1d5db;
  }
  .controls input::placeholder {
    color: #6b7280;
  }

  /* ××“×“×™× */
  .metric {
    background: #fff;
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 25px;
    text-align: center;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    box-shadow: 0 6px 15px rgba(0,0,0,0.1);
    border: 1px solid #e2e8f0;
  }
  .metric:hover {
    transform: translateY(-8px);
    box-shadow: 0 12px 30px rgba(0,0,0,0.2);
  }
  .metric span {
    display: block;
    margin-top: 10px;
    font-size: 2.2rem;
    font-weight: 700;
    color: #7c3aed; /* ×¡×’×•×œ */
  }

  /* ×’×¨×¤×™× */
  canvas {
    background: #fff;
    backdrop-filter: blur(10px);
    border-radius: 20px;
    margin-bottom: 25px;
    padding: 15px;
    box-shadow: 0 6px 15px rgba(0,0,0,0.1);
    border: 1px solid #e2e8f0;
  }

  /* ×˜×‘×œ×” */
  .table-wrapper {
    overflow-x: auto; /* ×××¤×©×¨ ×’×œ×™×œ×” ××•×¤×§×™×ª ×‘××™×“×ª ×”×¦×•×¨×š */
    margin-bottom: 30px;
    width: 100%;
    max-width: 1200px;
    border-radius: 20px;
    box-shadow: 0 6px 15px rgba(0,0,0,0.1);
  }
  table {
    width: 100%; /* ×”×˜×‘×œ×” ×ª××™×“ ×ª××œ× ××ª ×¨×•×—×‘ ×”×”×•×¨×” ×©×œ×” */
    border-collapse: separate; /* ×××¤×©×¨ border-radius ×¢×œ tr */
    border-spacing: 0;
    /* min-width: 1000px; -- ×”×•×¡×¨ ×›×“×™ ×œ××¤×©×¨ ×œ×˜×‘×œ×” ×œ×”×¦×˜××¦× ×‘××¡×›×™× ×§×˜× ×™× */
    background: #fff;
    border-radius: 20px;
    overflow: hidden; /* ×—×™×•× ×™ ×œ-border-radius */
  }
  th, td {
    padding: 15px 12px;
    text-align: center;
    transition: background 0.3s ease;
    border-bottom: 1px solid #f0f0f0; /* ×§×• ×”×¤×¨×“×” ×“×§ */
    color: #333;
    white-space: nowrap; /* ××•× ×¢ ×©×‘×™×¨×ª ×©×•×¨×•×ª ×‘×ª××™× ×›×“×™ ×œ×©××•×¨ ×¢×œ ×§×¨×™××•×ª */
  }
  th {
    background: #e9d5ff; /* ×¡×’×•×œ ×‘×”×™×¨ ×××•×“ ×œ×›×•×ª×¨×•×ª ×¢××•×“×•×ª */
    font-weight: 600;
    color: #5b21b6; /* ×¡×’×•×œ ×›×”×” ×™×•×ª×¨ */
    position: sticky;
    top: 0;
    z-index: 1;
  }
  tr:nth-child(even) {
    background: #f8fafc; /* ×¨×§×¢ ×¤×¡×™× ×œ×˜×‘×œ×” */
  }
  tr:hover td {
    background: #eef7ff; /* ×›×—×•×œ ×‘×”×™×¨ ×‘××¢×‘×¨ ×¢×›×‘×¨ */
  }

  button.edit-btn {
    background: #f97316;
    color: #fff;
    border-radius: 10px;
    padding: 8px 14px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
    box-shadow: 0 3px 8px rgba(0,0,0,0.2);
  }
  button.edit-btn:hover {
    transform: scale(1.08);
    background: #fb923c;
    box-shadow: 0 6px 15px rgba(0,0,0,0.3);
  }

  /* Popup */
  .popup-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.6); /* ×¨×§×¢ ×›×”×” ×™×•×ª×¨ */
    justify-content: center;
    align-items: center;
    z-index: 1000;
    animation: fadeIn 0.3s ease-out;
  }
  .popup {
    background: #fff;
    backdrop-filter: blur(20px);
    padding: 30px;
    border-radius: 25px;
    width: 90%;
    max-width: 550px;
    position: relative;
    box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    border: 1px solid #e2e8f0;
    animation: slideIn 0.4s ease-out;
  }
  .popup h2 {
    color: #4f46e5;
    text-align: center;
    margin-bottom: 20px;
    font-size: 2rem;
    font-weight: 700;
  }
  .popup label {
    display: block;
    margin: 12px 0 6px;
    font-weight: 500;
    color: #555;
  }
  .popup input {
    width: 100%;
    padding: 10px 12px;
    border-radius: 10px;
    border: 1px solid #d1d5db;
    background: #f8fafc;
    color: #333;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
  }
  .popup input:focus {
    border-color: #7c3aed;
    box-shadow: 0 0 0 3px rgba(124,58,237,0.2);
  }
  .popup button {
    margin-top: 25px;
    width: 100%;
    padding: 12px;
    border-radius: 12px;
    background: #7c3aed;
    color: #fff;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  }
  .popup button:hover {
    background: #8b5cf6;
    transform: translateY(-2px);
    box-shadow: 0 6px 15px rgba(0,0,0,0.2);
  }
  .popup .close {
    position: absolute;
    top: 15px;
    left: 15px;
    cursor: pointer;
    font-size: 28px;
    font-weight: 300;
    color: #666;
    transition: color 0.3s ease;
  }
  .popup .close:hover {
    color: #e04c4c;
  }

  /* ×× ×™××¦×™×•×ª */
  @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }
  @keyframes slideIn { from{transform:translateY(-50px); opacity:0;} to{transform:translateY(0); opacity:1;} }

  /* ×¨×¡×¤×•× ×¡×™×‘×™×•×ª */
  @media(max-width: 1024px) {
    .controls {
      flex-direction: column;
      align-items: center;
    }
    .controls button, .controls input, .controls select {
      width: 100%;
      margin-bottom: 10px;
    }
    .metrics {
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
    }
    h1 { font-size: 2rem; }
    .metric span { font-size: 1.8rem; }
  }

  @media(max-width: 600px){
    body { padding: 10px; }
    h1 { font-size: 1.8rem; margin-bottom: 20px; }
    .metrics { grid-template-columns: 1fr; }
    .metric { padding: 20px; }
    .table-wrapper { border-radius: 15px; }
    /* table { min-width: unset; } -- ×›×‘×¨ ×œ× × ×—×•×¥ ×›×™ ×”×¡×¨× ×• ××ª min-width ×”×›×œ×œ×™ ××”×˜×‘×œ×” */
    th, td { padding: 10px 8px; font-size: 0.9rem; }
    .popup { padding: 20px; border-radius: 20px; }
    .popup h2 { font-size: 1.8rem; }
  }

  /* ×”×•×“×¢×•×ª ××©×ª××© (×‘××§×•× alert) */
  #messageBox {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #333;
    color: #fff;
    padding: 15px 30px;
    border-radius: 10px;
    z-index: 1001;
    font-size: 1.1rem;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    text-align: center;
  }
</style>
</head>
<body>

<div id="messageBox"></div>

<h1><span class="text-indigo-600">×œ×•×— ×‘×§×¨×”</span> <span class="text-purple-600">×œ× ×™×”×•×œ ××›×•×œ×•×ª</span></h1>

<!-- Controls -->
<div class="controls flex flex-wrap gap-4 justify-center mb-6 w-full max-w-4xl">
  <button id="newOrderBtn" class="flex-grow">â• ×”×–×× ×” ×—×“×©×”</button>
  <button id="refreshBtn" class="flex-grow">ğŸ”„ ×¨×¢× ×Ÿ × ×ª×•× ×™×</button>
  <input type="text" id="searchInput" placeholder="×”×§×œ×“ ×œ×—×™×¤×•×©..." class="flex-grow min-w-[200px]">
  <select id="actionFilter" class="flex-grow min-w-[150px]"></select>
  <input type="number" id="daysMax" placeholder="×™××™× ×©×¢×‘×¨×• (××§×¡×™××•×)" class="flex-grow min-w-[180px]">
</div>

<!-- Metrics -->
<div class="metrics grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6 w-full max-w-4xl">
  <div class="metric">×¡×”"×› ×¤×ª×•×—×•×ª: <span id="totalOpen">0</span></div>
  <div class="metric">×—×¨×™×’×•×ª (&gt; 10 ×™××™×): <span id="overdue">0</span></div>
  <div class="metric">×¤×¢×•×œ×•×ª ××™×¡×•×£ ×”×™×•×: <span id="todayActions">0</span></div>
  <div class="metric">×××•×¦×¢ ×™××™× ×©×¢×‘×¨×•: <span id="avgDays">0.0</span></div>
</div>

<!-- Graphs -->
<canvas id="actionChart" height="200" class="w-full max-w-4xl mb-6"></canvas>
<canvas id="daysChart" height="200" class="w-full max-w-4xl mb-6"></canvas>

<!-- Table -->
<div class="table-wrapper">
  <table id="ordersTable">
    <thead>
      <tr>
        <th>×ª×¢×•×“×”</th>
        <th>×©× ×œ×§×•×—</th>
        <th>×©× ×¡×•×›×Ÿ</th>
        <th>××ª××¨×™×š</th>
        <th>×¡×•×’ ×¤×¢×•×œ×”</th>
        <th>×™××™× ×©×¢×‘×¨×•</th>
        <th>××¡" ××›×•×œ×” ×™×¨×“×”</th>
        <th>××¡" ××›×•×œ×” ×¢×œ×ª×”</th>
        <th>×™××™× ×©×¢×‘×¨×• (×¢×œ×ª×”)</th>
        <th>×¤×¢×•×œ×•×ª</th>
      </tr>
    </thead>
    <tbody><tr><td colspan="10">×œ× × ××¦××• ×”×–×× ×•×ª ×ª×•×××•×ª.</td></tr></tbody>
  </table>
</div>

<!-- Popup -->
<div class="popup-overlay" id="popupOverlay">
  <div class="popup" id="popup">
    <span class="close" onclick="closePopup()">Ã—</span>
    <h2>×¢×¨×™×›×ª ×¤×¨×˜×™ ×”×–×× ×”</h2>
    <div id="popupFields"></div>
    <button onclick="savePopup()">×©××•×¨ ×©×™× ×•×™×™×</button>
  </div>
</div>

<script>
  // URL ×œ×¡×§×¨×™×¤×˜ ×©×œ Google Apps Script
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx7E0OrpJc7Yq4xhFTj376xVMo9VfvhLAjDZ6zdt8QGzXvlzKkANZxn4cV5AfvDPQ0m/exec';
  let allOrders = [];
  let currentEdit = null;
  let actionChartInstance = null; // ××©×ª× ×” ×œ×©××™×¨×ª ××•×¤×¢ ×”×’×¨×£
  let daysChartInstance = null; // ××©×ª× ×” ×œ×©××™×¨×ª ××•×¤×¢ ×”×’×¨×£

  // ×¤×•× ×§×¦×™×” ×œ×”×¦×’×ª ×”×•×“×¢×•×ª ×œ××©×ª××© (×‘××§×•× alert)
  function showMessage(message, duration = 3000) {
    const messageBox = document.getElementById('messageBox');
    messageBox.textContent = message;
    messageBox.style.display = 'block';
    setTimeout(() => {
      messageBox.style.display = 'none';
    }, duration);
  }

  // ××™×¨×•×¢×™ ×œ×—×™×¦×” ×•×§×œ×˜
  document.getElementById('refreshBtn').addEventListener('click', fetchOrders);
  document.getElementById('searchInput').addEventListener('input', filterOrders);
  document.getElementById('actionFilter').addEventListener('change', filterOrders);
  document.getElementById('daysMax').addEventListener('input', filterOrders); // ×”×•×¡×¤×ª ×”××–× ×” ×’× ×œ×©×“×” ×™××™× ××§×¡×™××•×
  document.getElementById('newOrderBtn').addEventListener('click', newOrder);

  // ×¤×•× ×§×¦×™×” ×œ×˜×¢×™× ×ª ×”×–×× ×•×ª ××”×©×¨×ª
  async function fetchOrders() {
    showMessage('×˜×•×¢×Ÿ × ×ª×•× ×™×...');
    try {
      const res = await fetch(`${SCRIPT_URL}?action=list`);
      const data = await res.json();
      if (data.success) {
        allOrders = data.data;
        populateActionFilter();
        updateDashboard(allOrders);
        showMessage('×”× ×ª×•× ×™× × ×˜×¢× ×• ×‘×”×¦×œ×—×”!', 2000);
      } else {
        showMessage('×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×: ' + (data.message || '×©×’×™××” ×œ× ×™×“×•×¢×”'), 5000);
      }
    } catch (error) {
      console.error('×©×’×™××” ×‘-fetchOrders:', error);
      showMessage('×©×’×™××” ×‘×ª×§×©×•×¨×ª ×¢× ×”×©×¨×ª. ×× × × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨.', 5000);
    }
  }

  // ×¤×•× ×§×¦×™×” ×œ××™×œ×•×™ ×¤×™×œ×˜×¨ ×”×¤×¢×•×œ×•×ª
  function populateActionFilter() {
    const select = document.getElementById('actionFilter');
    // ×™×¦×™×¨×ª ××¢×¨×š ×™×™×—×•×“×™ ×©×œ ×¡×•×’×™ ×¤×¢×•×œ×•×ª
    const actions = [...new Set(allOrders.map(o => o['×¡×•×’ ×¤×¢×•×œ×”']).filter(a => a))];
    // ×× ×§×” ××ª ×”××¤×©×¨×•×™×•×ª ×”×§×™×™××•×ª ×•××•×¡×™×£ ××¤×©×¨×•×ª "×›×œ ×¡×•×’×™ ×”×¤×¢×•×œ×”"
    select.innerHTML = '<option value="">×›×œ ×¡×•×’×™ ×”×¤×¢×•×œ×”</option>';
    actions.forEach(a => {
      const option = document.createElement('option');
      option.value = a;
      option.textContent = a;
      select.appendChild(option);
    });
  }

  // ×¤×•× ×§×¦×™×” ×œ×¡×™× ×•×Ÿ ×”×–×× ×•×ª
  function filterOrders() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const actionFilter = document.getElementById('actionFilter').value;
    const daysMaxInput = document.getElementById('daysMax').value;
    const daysMax = daysMaxInput === '' ? Infinity : parseInt(daysMaxInput); // ×× ×¨×™×§, ××™×Ÿ ×”×’×‘×œ×ª ×™××™×

    const filtered = allOrders.filter(o => {
      const matchesSearch = o['×©× ×œ×§×•×—'] && o['×©× ×œ×§×•×—'].toLowerCase().includes(searchTerm) ||
                            o['×©× ×¡×•×›×Ÿ'] && o['×©× ×¡×•×›×Ÿ'].toLowerCase().includes(searchTerm) ||
                            o['×ª×¢×•×“×”'] && o['×ª×¢×•×“×”'].toLowerCase().includes(searchTerm);
      const matchesAction = actionFilter ? (o['×¡×•×’ ×¤×¢×•×œ×”'] === actionFilter) : true;
      const daysPassed = parseInt(o['×™××™× ×©×¢×‘×¨×•']) || 0; // ×˜×™×¤×•×œ ×‘××§×¨×” ×©×œ ×¢×¨×š ×¨×™×§ ××• ×œ× ××¡×¤×¨×™
      const matchesDays = daysPassed <= daysMax;
      return matchesSearch && matchesAction && matchesDays;
    });
    updateDashboard(filtered);
  }

  // ×¤×•× ×§×¦×™×” ×œ×¢×“×›×•×Ÿ ×œ×•×— ×”×‘×§×¨×” (×˜×‘×œ×”, ××“×“×™×, ×’×¨×¤×™×)
  function updateDashboard(orders) {
    const tbody = document.querySelector('#ordersTable tbody');
    tbody.innerHTML = ''; // ×× ×§×” ××ª ×”×˜×‘×œ×”
    if (orders.length === 0) {
      tbody.innerHTML = '<tr><td colspan="10" class="text-gray-500 py-4">×œ× × ××¦××• ×”×–×× ×•×ª ×ª×•×××•×ª.</td></tr>';
    } else {
      orders.forEach(o => {
        const tr = document.createElement('tr');
        // ×©×™××•×© ×‘×ª× ××™ ×¢×‘×•×¨ o['×ª×¢×•×“×”'] ×•×›×•' ×›×“×™ ×œ×× ×•×¢ ×”×¦×’×ª 'undefined'
        tr.innerHTML = `
          <td>${o['×ª×¢×•×“×”'] || ''}</td>
          <td>${o['×©× ×œ×§×•×—'] || ''}</td>
          <td>${o['×©× ×¡×•×›×Ÿ'] || ''}</td>
          <td>${formatDate(o['××ª××¨×™×š'])}</td>
          <td>${o['×¡×•×’ ×¤×¢×•×œ×”'] || ''}</td>
          <td>${o['×™××™× ×©×¢×‘×¨×•'] || '0'}</td>
          <td>${o['××¡" ××›×•×œ×” ×™×¨×“×”'] || ''}</td>
          <td>${o['××¡" ××›×•×œ×” ×¢×œ×ª×”'] || ''}</td>
          <td>${o['×™××™× ×©×¢×‘×¨×• (×¢×œ×ª×”)'] || '0'}</td>
          <td><button class="edit-btn" onclick="openPopup(${allOrders.indexOf(o)})">×¢×¨×•×š</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ×¢×“×›×•×Ÿ ××“×“×™×
    const totalOpen = orders.length;
    const overdue = orders.filter(o => (parseInt(o['×™××™× ×©×¢×‘×¨×•']) || 0) > 10).length;
    // ×™×© ×œ×•×•×“× ×©×”×ª××¨×™×š ×©×œ ×”×™×•× ×ª×•×× ××ª ×¤×•×¨××˜ ×”× ×ª×•× ×™×
    const today = orders.filter(o => o['×¡×•×’ ×¤×¢×•×œ×”'] === '××™×¡×•×£' && formatDate(o['××ª××¨×™×š']) === new Date().toLocaleDateString('he-IL')).length;
    const sumDays = orders.reduce((sum, o) => sum + (parseInt(o['×™××™× ×©×¢×‘×¨×•']) || 0), 0);
    const avgDays = orders.length ? (sumDays / orders.length).toFixed(1) : '0.0';

    document.getElementById('totalOpen').textContent = totalOpen;
    document.getElementById('overdue').textContent = overdue;
    document.getElementById('todayActions').textContent = today;
    document.getElementById('avgDays').textContent = avgDays;

    renderActionChart(orders);
    renderDaysChart(orders);
  }

  // ×¤×•× ×§×¦×™×” ×œ×¢×™×¦×•×‘ ×ª××¨×™×š
  function formatDate(dateStr) {
    if (!dateStr) return '';
    try {
      const d = new Date(dateStr);
      if (isNaN(d)) {
        // ×× Date() ×œ× ×”×¦×œ×™×— ×œ×¤×¨×¡×¨, × × ×¡×” ×¤×¨×¡×•×¨ ×™×“× ×™ ×œ×¤×•×¨××˜ dd/mm/yyyy
        const parts = dateStr.split('/');
        if (parts.length === 3) {
            const day = parseInt(parts[0]);
            const month = parseInt(parts[1]) - 1; // ×—×•×“×©×™× ×‘-JavaScript ×”× 0-11
            const year = parseInt(parts[2]);
            const dParsed = new Date(year, month, day);
            if (!isNaN(dParsed)) {
                return `${String(dParsed.getDate()).padStart(2, '0')}/${String(dParsed.getMonth() + 1).padStart(2, '0')}/${dParsed.getFullYear()}`;
            }
        }
        return dateStr; // ××—×–×™×¨ ××ª ×”××§×•×¨ ×× ×œ× × ×™×ª×Ÿ ×œ×¤×¨×¡×¨
      }
      return `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`;
    } catch (e) {
      console.error("×©×’×™××” ×‘×¤×•×¨××˜ ×”×ª××¨×™×š:", dateStr, e);
      return dateStr; // ×‘××§×¨×” ×©×œ ×©×’×™××”, ××—×–×™×¨ ××ª ×”××—×¨×•×–×ª ×”××§×•×¨×™×ª
    }
  }


  // ×¤×•× ×§×¦×™×” ×œ×¨×™× ×“×•×¨ ×’×¨×£ ×”×ª×¤×œ×’×•×ª ×¡×•×’×™ ×¤×¢×•×œ×”
  function renderActionChart(orders) {
    const ctx = document.getElementById('actionChart').getContext('2d');
    const counts = {};
    orders.forEach(o => {
      counts[o['×¡×•×’ ×¤×¢×•×œ×”'] || '×œ× ××•×’×“×¨'] = (counts[o['×¡×•×’ ×¤×¢×•×œ×”'] || '×œ× ××•×’×“×¨'] || 0) + 1;
    });

    if (actionChartInstance) {
      actionChartInstance.destroy(); // ×”×•×¨×¡ ××ª ×”××•×¤×¢ ×”×§×•×“× ×©×œ ×”×’×¨×£
    }

    actionChartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: Object.keys(counts),
        datasets: [{
          label: '×”×ª×¤×œ×’×•×ª ×¡×•×’×™ ×¤×¢×•×œ×”',
          data: Object.values(counts),
          backgroundColor: 'rgba(124, 58, 237, 0.7)', // ×¡×’×•×œ
          borderColor: 'rgba(124, 58, 237, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: {
              color: '#333'
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: { color: '#555' },
            grid: { color: 'rgba(0,0,0,0.05)' }
          },
          x: {
            ticks: { color: '#555' },
            grid: { color: 'rgba(0,0,0,0.05)' }
          }
        }
      }
    });
  }

  // ×¤×•× ×§×¦×™×” ×œ×¨×™× ×“×•×¨ ×’×¨×£ ×”×™×¡×˜×•×’×¨××ª ×™××™× ×©×¢×‘×¨×•
  function renderDaysChart(orders) {
    const ctx = document.getElementById('daysChart').getContext('2d');
    // ×—×©×•×‘ ×œ×•×•×“× ×©×¢×¨×›×™× ×”× ××¡×¤×¨×™×
    const days = orders.map(o => parseInt(o['×™××™× ×©×¢×‘×¨×•']) || 0).sort((a, b) => a - b);

    if (daysChartInstance) {
      daysChartInstance.destroy(); // ×”×•×¨×¡ ××ª ×”××•×¤×¢ ×”×§×•×“× ×©×œ ×”×’×¨×£
    }

    // ×™×¦×™×¨×ª ×ª×•×•×™×•×ª ×“×™× ××™×•×ª ×¢×‘×•×¨ ×¦×™×¨ X (×›××• ×˜×•×•×—×™× ××• ×™××™× ×¡×¤×¦×™×¤×™×™×)
    const uniqueDays = [...new Set(days)].sort((a,b) => a-b);

    daysChartInstance = new Chart(ctx, {
      type: 'line', // ×©×™× ×•×™ ×œ×’×¨×£ ×§×• ×œ×”×¦×’×ª ××’××”
      data: {
        labels: uniqueDays, // ×ª×•×•×™×ª ×¦×™×¨ X
        datasets: [{
          label: '×”×™×¡×˜×•×’×¨××ª ×™××™× ×©×¢×‘×¨×•',
          data: uniqueDays.map(day => days.filter(d => d === day).length), // ×¡×¤×™×¨×ª ××•×¤×¢×™× ×œ×›×œ ×™×•×
          backgroundColor: 'rgba(249, 115, 22, 0.7)', // ×›×ª×•×
          borderColor: 'rgba(249, 115, 22, 1)',
          borderWidth: 2,
          fill: true,
          tension: 0.4 // ×¢×•×©×” ××ª ×”×§×• ×—×œ×§ ×™×•×ª×¨
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: {
              color: '#333'
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: { color: '#555' },
            grid: { color: 'rgba(0,0,0,0.05)' }
          },
          x: {
            ticks: { color: '#555' },
            grid: { color: 'rgba(0,0,0,0.05)' }
          }
        }
      }
    });
  }

  // ×¤×•× ×§×¦×™×” ×œ× ×™×§×•×™ ××¤×ª×— ××©×“×•×ª ×˜×•×¤×¡ (×œ×œ× ×ª×•×•×™ ×¤×™×¡×•×§)
  function sanitizeKey(key) {
    return key.replace(/[^a-zA-Z0-9\u0590-\u05FF]/g, "_"); // ×ª×•××š ×‘×¢×‘×¨×™×ª
  }

  // ×¤×•× ×§×¦×™×” ×œ×¤×ª×™×—×ª ×—×œ×•×Ÿ ×§×•×¤×¥ ×œ×¢×¨×™×›×”
  function openPopup(index) {
    currentEdit = index;
    const order = allOrders[index];
    const container = document.getElementById('popupFields');
    container.innerHTML = ''; // ×× ×§×” ×©×“×•×ª ×§×™×™××™×
    for (const key in order) {
      const safeKey = sanitizeKey(key);
      // ×©×™××•×© ×‘×˜×§×¡×˜ ××¨×™××” ×œ×©×“×•×ª ××¨×•×›×™× ×™×•×ª×¨, ××• ×¡×œ×§×˜ ×œ×©×“×•×ª ×¢× ××¤×©×¨×•×™×•×ª ×§×‘×•×¢×•×ª
      let inputField;
      if (key === '×¡×•×’ ×¤×¢×•×œ×”') {
        inputField = `<select id="popup_${safeKey}" class="w-full p-2 border rounded">
                        <option value="××™×¡×•×£" ${order[key] === '××™×¡×•×£' ? 'selected' : ''}>××™×¡×•×£</option>
                        <option value="×”×—×–×¨×”" ${order[key] === '×”×—×–×¨×”' ? 'selected' : ''}>×”×—×–×¨×”</option>
                        <option value="×”×•×‘×œ×”" ${order[key] === '×”×•×‘×œ×”' ? 'selected' : ''}>×”×•×‘×œ×”</option>
                        <option value="×¨×™×§×•×Ÿ" ${order[key] === '×¨×™×§×•×Ÿ' ? 'selected' : ''}>×¨×™×§×•×Ÿ</option>
                        <option value="××—×¨" ${order[key] === '××—×¨' ? 'selected' : ''}>××—×¨</option>
                      </select>`;
      } else {
        inputField = `<input type="text" id="popup_${safeKey}" value="${order[key] || ''}">`;
      }
      container.innerHTML += `<label>${key}</label>${inputField}`;
    }
    document.getElementById('popupOverlay').style.display = 'flex';
  }

  // ×¤×•× ×§×¦×™×” ×œ×¡×’×™×¨×ª ×—×œ×•×Ÿ ×§×•×¤×¥
  function closePopup() {
    document.getElementById('popupOverlay').style.display = 'none';
  }

  // ×¤×•× ×§×¦×™×” ×œ×©××™×¨×ª ×©×™× ×•×™×™× ×‘×—×œ×•×Ÿ ×§×•×¤×¥
  async function savePopup() {
    if (currentEdit === null) return;
    const order = allOrders[currentEdit];
    const updatedOrder = {};

    for (const key in order) {
      const safeKey = sanitizeKey(key);
      const el = document.getElementById(`popup_${safeKey}`);
      if (el) {
        updatedOrder[key] = el.value;
      }
    }

    showMessage('×©×•××¨ ×©×™× ×•×™×™×...', 0); // ×”×¦×’ ×”×•×“×¢×” ×œ×œ× ×–××Ÿ ××•×’×‘×œ

    try {
      const res = await fetch(`${SCRIPT_URL}?action=update&index=${currentEdit}`, {
        method: 'POST',
        body: JSON.stringify(updatedOrder),
        headers: { 'Content-Type': 'application/json' }
      });
      const result = await res.json();
      if (result.success) {
        // ×¢×“×›×•×Ÿ ××•×‘×™×™×§×˜ allOrders ×‘××•×¤×Ÿ ××§×•××™ ×¢× ×”× ×ª×•× ×™× ×”××¢×•×“×›× ×™×
        allOrders[currentEdit] = updatedOrder;
        updateDashboard(allOrders); // ×¨×¢× ×Ÿ ××ª ×œ×•×— ×”×‘×§×¨×” ×¢× ×”× ×ª×•× ×™× ×”××¢×•×“×›× ×™×
        closePopup();
        showMessage('×”×”×–×× ×” ×¢×•×“×›× ×” ×‘×”×¦×œ×—×”!', 2000);
      } else {
        showMessage('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×”×–×× ×”: ' + (result.message || '×©×’×™××” ×œ× ×™×“×•×¢×”'), 5000);
      }
    } catch (error) {
      console.error('×©×’×™××” ×‘-savePopup:', error);
      showMessage('×©×’×™××” ×‘×ª×§×©×•×¨×ª ×¢× ×”×©×¨×ª ×‘×¢×ª ×©××™×¨×”. ×× × × ×¡×” ×©×•×‘.', 5000);
    }
  }

  // ×¤×•× ×§×¦×™×” ×œ×™×¦×™×¨×ª ×”×–×× ×” ×—×“×©×”
  function newOrder() {
    const newO = {
      '×ª×¢×•×“×”': '',
      '×©× ×œ×§×•×—': '',
      '×©× ×¡×•×›×Ÿ': '',
      '××ª××¨×™×š': '',
      '×¡×•×’ ×¤×¢×•×œ×”': '',
      '×™××™× ×©×¢×‘×¨×•': '0',
      '××¡" ××›×•×œ×” ×™×¨×“×”': '',
      '××¡" ××›×•×œ×” ×¢×œ×ª×”': '',
      '×™××™× ×©×¢×‘×¨×• (×¢×œ×ª×”)': '0'
    };
    allOrders.push(newO); // ×”×•×¡×£ ××ª ×”×”×–×× ×” ×”×—×“×©×” ×œ××¢×¨×š
    openPopup(allOrders.length - 1); // ×¤×ª×— ××ª ×”×¤×•×¤××¤ ×¢×‘×•×¨ ×”×”×–×× ×” ×”×—×“×©×”
  }

  // ×˜×¢×™× ×” ×¨××©×•× ×™×ª ×©×œ ×”× ×ª×•× ×™×
  fetchOrders();
</script>

</body>
</html>

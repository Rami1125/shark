<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>לוח בקרה לניהול מכולות</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700&display=swap');
    
    :root {
      --primary: #4f46e5;
      --primary-light: #818cf8;
      --secondary: #f97316;
      --danger: #ef4444;
      --success: #10b981;
      --warning: #f59e0b;
    }
    
    body {
      font-family: 'Rubik', Arial, sans-serif;
      direction: rtl;
      background-color: #f8fafc;
    }
    
    .container-fade {
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
    }
    
    .metric-card {
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    
    .metric-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    
    .table-row:hover {
      background-color: #f1f5f9 !important;
    }

    /* Conditional styling based on action type */
    .action-הצבה { background-color: #dcfce7 !important; } /* Light green */
    .action-הצבה:hover { background-color: #bbf7d0 !important; }

    .action-איסוף { background-color: #fee2e2 !important; } /* Light red */
    .action-איסוף:hover { background-color: #fecaca !important; }

    .action-פריקה { background-color: #eff6ff !important; } /* Light blue */
    .action-פריקה:hover { background-color: #dbeafe !important; }

    .action-טעינה { background-color: #fffbeb !important; } /* Light yellow */
    .action-טעינה:hover { background-color: #fef3c7 !important; }

    .action-החלפה { background-color: #ffedd5 !important; } /* Light orange */
    .action-החלפה:hover { background-color: #fed7aa !important; }

    .action-הוצאה { background-color: #fce7e7 !important; } /* Lighter red */
    .action-הוצאה:hover { background-color: #fcc2c2 !important; }

    .action-פינוי-במקום, .action-הזזה { background-color: #ede9fe !important; } /* Light purple */
    .action-פינוי-במקום:hover, .action-הזזה:hover { background-color: #ddd6fe !important; }

    /* General overdue and today rows */
    .overdue-row {
      background-color: #fee2e2 !important;
    }
    
    .overdue-row:hover {
      background-color: #fecaca !important;
    }
    
    .today-row {
      background-color: #ecfdf5 !important;
    }
    
    .today-row:hover {
      background-color: #d1fae5 !important;
    }

    /* Closed order styling */
    .closed-row {
      text-decoration: line-through;
      color: #888;
      background-color: #f0f0f0 !important;
    }
    
    .closed-row:hover {
      background-color: #e0e0e0 !important;
    }
    
    .chart-container {
      transition: all 0.3s ease;
    }
    
    .chart-container:hover {
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    
    .btn-primary {
      background-color: var(--primary);
      transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
      background-color: var(--primary-light);
    }
    
    .btn-secondary {
      background-color: var(--secondary);
      transition: all 0.3s ease;
    }
    
    .btn-secondary:hover {
      background-color: #fb923c;
    }

    .btn-danger {
      background-color: var(--danger);
      transition: all 0.3s ease;
    }

    .btn-danger:hover {
      background-color: #dc2626;
    }
    
    .badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .badge-primary {
      background-color: var(--primary-light);
      color: white;
    }
    
    .badge-danger {
      background-color: var(--danger);
      color: white;
    }
    
    .badge-success {
      background-color: var(--success);
      color: white;
    }
    
    .badge-warning {
      background-color: var(--warning);
      color: white;
    }
    
    .tooltip {
      position: relative;
      display: inline-block;
    }
    
    .tooltip .tooltip-text {
      visibility: hidden;
      width: 120px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -60px;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .tooltip:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }

    /* Modal styles */
    .modal {
      display: none; /* Hidden by default */
      position: fixed; /* Stay in place */
      z-index: 1000; /* Sit on top */
      left: 0;
      top: 0;
      width: 100%; /* Full width */
      height: 100%; /* Full height */
      overflow: auto; /* Enable scroll if needed */
      background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background-color: #fefefe;
      margin: auto;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      width: 80%;
      max-width: 400px;
      text-align: center;
    }

    .close-button {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }

    .close-button:hover,
    .close-button:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }
    
    @media (max-width: 768px) {
      .metrics-grid {
        grid-template-columns: repeat(2, 1fr) !important;
      }
      
      .chart-grid {
        grid-template-columns: 1fr !important;
      }
    }
    
    @media (max-width: 480px) {
      .metrics-grid {
        grid-template-columns: 1fr !important;
      }
    }
  </style>
</head>
<body class="min-h-screen">
  <div class="container mx-auto px-4 py-8 max-w-7xl">
    <!-- Header Section -->
    <header class="mb-8 text-center">
      <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2">לוח בקרה לניהול מכולות</h1>
      <p class="text-gray-600">ניהול וניתוח הזמנות מכולות בזמן אמת</p>
      <div id="overdueOrdersBanner" class="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg hidden">
        <h2 class="font-bold text-lg mb-2">הזמנות חריגות בתאריך קצה:</h2>
        <ul id="overdueOrdersList" class="list-disc list-inside text-sm">
          <!-- Overdue orders will be listed here -->
        </ul>
      </div>
    </header>
    
    <!-- Action Buttons and Filters -->
    <div class="bg-white rounded-lg shadow-md p-4 mb-6">
      <div class="flex flex-wrap items-center justify-between gap-4">
        <div class="flex flex-wrap gap-2">
          <button id="newOrderBtn" class="btn-primary text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
            </svg>
            הזמנה חדשה
          </button>
          <button id="refreshBtn" class="btn-secondary text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
            </svg>
            רענן נתונים
          </button>
        </div>
        
        <div class="flex flex-wrap gap-3 items-center">
          <div class="relative">
            <input type="text" id="searchInput" placeholder="חיפוש הזמנה..." 
                   class="border border-gray-300 rounded-lg px-4 py-2 pr-10 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-3 top-2.5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
            </svg>
          </div>
          
          <select id="actionFilter" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">כל סוגי הפעולה</option>
          </select>
          
          <div class="relative">
            <input type="number" id="daysMax" placeholder="ימים שעברו (מקסימום)" 
                   class="border border-gray-300 rounded-lg px-4 py-2 w-40 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <span class="absolute left-3 top-2.5 text-gray-500 text-sm">ימים</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Metrics Cards -->
    <div class="metrics-grid grid grid-cols-4 gap-4 mb-6">
      <div class="metric-card bg-white rounded-lg p-4 shadow-sm border-l-4 border-blue-500">
        <h3 class="text-gray-500 text-sm font-medium mb-1">סה"כ הזמנות פתוחות</h3>
        <div class="flex items-center justify-between">
          <span id="totalOpen" class="text-2xl font-bold text-gray-800">0</span>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
          </svg>
        </div>
      </div>
      
      <div class="metric-card bg-white rounded-lg p-4 shadow-sm border-l-4 border-red-500">
        <h3 class="text-gray-500 text-sm font-medium mb-1">הזמנות חריגות (> 10 ימים)</h3>
        <div class="flex items-center justify-between">
          <span id="overdue" class="text-2xl font-bold text-gray-800">0</span>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
      </div>
      
      <div class="metric-card bg-white rounded-lg p-4 shadow-sm border-l-4 border-green-500">
        <h3 class="text-gray-500 text-sm font-medium mb-1">פעולות איסוף היום</h3>
        <div class="flex items-center justify-between">
          <span id="todayActions" class="text-2xl font-bold text-gray-800">0</span>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
          </svg>
        </div>
      </div>
      
      <div class="metric-card bg-white rounded-lg p-4 shadow-sm border-l-4 border-orange-500">
        <h3 class="text-gray-500 text-sm font-medium mb-1">ממוצע ימים שעברו</h3>
        <div class="flex items-center justify-between">
          <span id="avgDays" class="text-2xl font-bold text-gray-800">0.0</span>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
      </div>
    </div>
    
    <!-- Charts Section -->
    <div class="chart-grid grid grid-cols-2 gap-6 mb-6">
      <div class="chart-container bg-white rounded-lg p-4 shadow-sm">
        <h3 class="text-gray-700 font-medium mb-3">התפלגות סוגי פעולה</h3>
        <canvas id="actionChart" height="150"></canvas>
      </div>
      <div class="chart-container bg-white rounded-lg p-4 shadow-sm">
        <h3 class="text-gray-700 font-medium mb-3">היסטוגרמת ימים שעברו</h3>
        <canvas id="daysChart" height="150"></canvas>
      </div>
    </div>
    
    <!-- Orders Table -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden mb-6">
      <div class="overflow-x-auto">
        <table id="ordersTable" class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">תעודה</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">שם לקוח</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">שם סוכן</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">מתאריך</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">סוג פעולה</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">ימים שעברו</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">מס" מכולה ירדה</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">מס" מכולה עלתה</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">ימים שעברו (עלתה)</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">פעולות</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <tr>
              <td colspan="10" class="px-6 py-4 text-center text-gray-500">טוען נתונים...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmModal" class="modal">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <p id="modalMessage" class="text-lg font-medium mb-4"></p>
      <div class="flex justify-center gap-4">
        <button id="modalConfirmBtn" class="btn-danger text-white px-4 py-2 rounded-lg font-medium">אשר</button>
        <button id="modalCancelBtn" class="btn-secondary text-white px-4 py-2 rounded-lg font-medium">בטל</button>
      </div>
    </div>
  </div>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx7E0OrpJc7Yq4xhFTj376xVMo9VfvhLAjDZ6zdt8QGzXvlzKkANZxn4cV5AfvDPQ0m/exec';
    let allOrders = [];
    let actionChartInstance = null;
    let daysChartInstance = null;

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
      // Add event listeners
      document.getElementById('refreshBtn').addEventListener('click', fetchOrders);
      document.getElementById('searchInput').addEventListener('input', debounce(filterOrders, 300));
      document.getElementById('actionFilter').addEventListener('change', filterOrders);
      document.getElementById('daysMax').addEventListener('input', debounce(filterOrders, 300));
      
      // Modal event listeners
      document.querySelector('.close-button').addEventListener('click', closeModal);
      document.getElementById('modalCancelBtn').addEventListener('click', closeModal);
      window.addEventListener('click', (event) => {
        if (event.target === document.getElementById('confirmModal')) {
          closeModal();
        }
      });

      // Initial fetch
      fetchOrders();
    });

    // Debounce function for better performance
    function debounce(func, wait) {
      let timeout;
      return function() {
        const context = this, args = arguments;
        clearTimeout(timeout);
        timeout = setTimeout(() => {
          func.apply(context, args);
        }, wait);
      };
    }

    // Function to format date from ISO string to DD/MM/YYYY
    function formatDate(isoString) {
      if (!isoString) return '-';
      try {
        const date = new Date(isoString);
        if (isNaN(date.getTime())) { // Check for invalid date
          return isoString; // Return original if invalid
        }
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0'); // Month is 0-indexed
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
      } catch (e) {
        console.error("Error parsing date:", isoString, e);
        return isoString; // Fallback to original if parsing fails
      }
    }

    // Fetch orders from Google Sheets
    async function fetchOrders() {
      try {
        // Show loading state
        const tbody = document.querySelector('#ordersTable tbody');
        tbody.innerHTML = '<tr><td colspan="10" class="px-6 py-4 text-center text-gray-500"><div class="flex justify-center"><svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> טוען נתונים...</div></td></tr>';
        
        const res = await fetch(`${SCRIPT_URL}?action=list`);
        const data = await res.json();
        
        if (data.success) {
          allOrders = data.data.map(order => ({ ...order, closed: order.closed === 'TRUE' })); // Convert 'closed' to boolean
          populateActionFilter();
          updateDashboard(allOrders);
        } else {
          showError('שגיאה בשליפת נתונים');
        }
      } catch (error) {
        showError('שגיאה בחיבור לשרת');
        console.error('Error fetching orders:', error);
      }
    }

    // Populate action filter dropdown
    function populateActionFilter() {
      const select = document.getElementById('actionFilter');
      const actions = [...new Set(allOrders.map(o => o['סוג פעולה']).filter(a => a))];
      select.innerHTML = '<option value="">כל סוגי הפעולה</option>';
      actions.forEach(a => {
        const option = document.createElement('option');
        option.value = a;
        option.textContent = a;
        select.appendChild(option);
      });
    }

    // Filter orders based on search criteria
    function filterOrders() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const actionFilter = document.getElementById('actionFilter').value;
      const daysMax = parseInt(document.getElementById('daysMax').value) || Infinity;

      const filtered = allOrders.filter(o => {
        // Exclude closed orders from calculations and display
        if (o.closed) return false; 

        const matchesSearch = o['שם לקוח']?.toLowerCase().includes(searchTerm) ||
                             o['שם סוכן']?.toLowerCase().includes(searchTerm) ||
                             o['תעודה']?.toLowerCase().includes(searchTerm);
        const matchesAction = actionFilter ? o['סוג פעולה'] === actionFilter : true;
        const matchesDays = parseInt(o['ימים שעברו'] || 0) <= daysMax;
        return matchesSearch && matchesAction && matchesDays;
      });

      updateDashboard(filtered);
    }

    // Update the dashboard with filtered orders
    function updateDashboard(orders) {
      // Update table - pass all orders, including closed, for display purposes
      updateOrdersTable(allOrders); 
      
      // Filter out closed orders for metrics and charts
      const activeOrders = orders.filter(o => !o.closed);

      // Update metrics
      updateMetrics(activeOrders);
      
      // Update charts
      updateCharts(activeOrders);

      // Update overdue banner
      updateOverdueBanner(activeOrders);
    }

    // Update the orders table
    function updateOrdersTable(orders) {
      const tbody = document.querySelector('#ordersTable tbody');
      tbody.innerHTML = '';
      
      if (orders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="px-6 py-4 text-center text-gray-500">לא נמצאו הזמנות תואמות.</td></tr>';
        return;
      }
      
      // Get today's date in DD/MM/YYYY format for comparison
      const today = new Date().toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit', year: 'numeric' });
      
      orders.forEach(o => {
        const daysPassed = parseInt(o['ימים שעברו'] || 0);
        const isOverdue = daysPassed > 10 && !o.closed; // Only active orders can be overdue
        const orderDateFormatted = formatDate(o['מתאריך']);
        const isToday = orderDateFormatted === today && !o.closed; // Only active orders can be "today"

        // Determine row class based on action type and status
        let actionTypeClass = '';
        if (o['סוג פעולה']) {
            actionTypeClass = `action-${o['סוג פעולה'].replace(/\s/g, '-')}`; // Replace spaces for CSS class names
        }

        let rowClass = `table-row ${actionTypeClass}`;
        if (o.closed) {
            rowClass = `table-row closed-row`;
        } else if (isOverdue) {
            rowClass += ` overdue-row`;
        } else if (isToday) {
            rowClass += ` today-row`;
        }
        
        const tr = document.createElement('tr');
        tr.className = rowClass;
        tr.setAttribute('data-order-id', o['תעודה']); // Store order ID on the row

        const closeButtonHtml = o.closed ? '' : `
            <button onclick="confirmCloseOrder('${o['תעודה']}')" class="text-red-600 hover:text-red-900 tooltip mr-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
              </svg>
              <span class="tooltip-text">סגור הזמנה</span>
            </button>
        `;

        tr.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${o['תעודה'] || '-'}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${o['שם לקוח'] || '-'}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${o['שם סוכן'] || '-'}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(o['מתאריך'])}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
            ${o['סוג פעולה'] || '-'}
            ${isToday ? '<span class="badge badge-success ml-2">היום</span>' : ''}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm ${isOverdue ? 'font-bold text-red-600' : 'text-gray-500'}">
            ${o['ימים שעברו'] || '0'}
            ${isOverdue ? '<span class="badge badge-danger ml-2">חריגה</span>' : ''}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${o['מס" מכולה ירדה'] || '-'}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${o['מס" מכולה עלתה'] || '-'}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${o['ימים שעברו (עלתה)'] || '-'}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 flex items-center">
            <button onclick="editOrder('${o['תעודה']}')" class="text-blue-600 hover:text-blue-900 tooltip">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
              </svg>
              <span class="tooltip-text">ערוך הזמנה</span>
            </button>
            ${closeButtonHtml}
          </td>
        `;
        
        tbody.appendChild(tr);
      });
    }

    // Update metrics cards
    function updateMetrics(orders) {
      // Filter out closed orders before calculating metrics
      const activeOrders = orders.filter(o => !o.closed);

      const totalOpen = activeOrders.length;
      const overdue = activeOrders.filter(o => parseInt(o['ימים שעברו'] || 0) > 10).length;
      
      const today = new Date().toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit', year: 'numeric' });
      const todayActions = activeOrders.filter(o => o['סוג פעולה'] === 'איסוף' && formatDate(o['מתאריך']) === today).length;
      
      const avgDays = activeOrders.length ? 
        (activeOrders.reduce((sum, o) => sum + parseInt(o['ימים שעברו'] || 0), 0) / activeOrders.length).toFixed(1) : 
        '0.0';

      document.getElementById('totalOpen').textContent = totalOpen;
      document.getElementById('overdue').textContent = overdue;
      document.getElementById('todayActions').textContent = todayActions;
      document.getElementById('avgDays').textContent = avgDays;
    }

    // Update charts
    function updateCharts(orders) {
      renderActionChart(orders);
      renderDaysChart(orders);
    }

    // Render action distribution chart
    function renderActionChart(orders) {
      const ctx = document.getElementById('actionChart').getContext('2d');
      const counts = {};
      
      orders.forEach(o => { 
        // Only count active (non-closed) orders
        if (!o.closed) {
          counts[o['סוג פעולה']] = (counts[o['סוג פעולה']] || 0) + 1; 
        }
      });
      
      const backgroundColors = generateColors(Object.keys(counts).length, 0.7);
      const borderColors = generateColors(Object.keys(counts).length, 1);

      if (actionChartInstance) actionChartInstance.destroy();
      
      actionChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(counts),
          datasets: [{
            label: 'מספר הזמנות',
            data: Object.values(counts),
            backgroundColor: backgroundColors,
            borderColor: borderColors,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'top',
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `${context.dataset.label}: ${context.raw}`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0
              }
            }
          }
        }
      });
    }

    // Render days passed histogram
    function renderDaysChart(orders) {
      const ctx = document.getElementById('daysChart').getContext('2d');
      // Filter out closed orders and get days passed for active orders
      const days = orders.filter(o => !o.closed).map(o => parseInt(o['ימים שעברו'] || 0)).sort((a, b) => a - b);
      
      // Group days into bins for histogram
      const bins = {};
      const maxDays = Math.max(...days, 0);
      const binSize = 5; // Group days into 5-day intervals
      
      for (let i = 0; i <= maxDays + binSize; i += binSize) {
        const binLabel = `${i}-${i + binSize - 1} ימים`;
        bins[binLabel] = 0;
      }

      days.forEach(d => {
        const binIndex = Math.floor(d / binSize) * binSize;
        const binLabel = `${binIndex}-${binIndex + binSize - 1} ימים`;
        if (bins[binLabel] !== undefined) {
            bins[binLabel]++;
        } else { // For cases where a day count might exceed predefined bins
            const lastBinKey = Object.keys(bins)[Object.keys(bins).length - 1];
            if (d >= parseInt(lastBinKey.split('-')[0])) {
                bins[lastBinKey]++;
            }
        }
      });

      // Remove empty bins for a cleaner chart
      for (const key in bins) {
          if (bins[key] === 0) {
              delete bins[key];
          }
      }

      const chartLabels = Object.keys(bins);
      const chartData = Object.values(bins);
      
      if (daysChartInstance) daysChartInstance.destroy();
      
      daysChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: chartLabels,
          datasets: [{
            label: 'מספר הזמנות',
            data: chartData,
            backgroundColor: 'rgba(249, 115, 22, 0.7)',
            borderColor: 'rgba(249, 115, 22, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'top',
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `טווח ימים: ${context.label}, מספר הזמנות: ${context.raw}`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0
              }
            },
            x: {
                title: {
                    display: true,
                    text: 'טווח ימים שעברו'
                }
            }
          }
        }
      });
    }

    // Generate random colors for charts
    function generateColors(count, opacity) {
      const colors = [];
      const hueStep = 360 / count;
      
      for (let i = 0; i < count; i++) {
        const hue = i * hueStep;
        colors.push(`hsla(${hue}, 70%, 60%, ${opacity})`);
      }
      
      return colors;
    }

    // Show custom modal message instead of alert
    function showModal(message, onConfirm = null) {
      document.getElementById('modalMessage').textContent = message;
      const confirmBtn = document.getElementById('modalConfirmBtn');
      if (onConfirm) {
        confirmBtn.style.display = 'inline-block';
        confirmBtn.onclick = () => {
          onConfirm();
          closeModal();
        };
      } else {
        confirmBtn.style.display = 'none'; // Hide confirm button for simple messages
      }
      document.getElementById('confirmModal').style.display = 'flex';
    }

    // Close custom modal
    function closeModal() {
      document.getElementById('confirmModal').style.display = 'none';
      document.getElementById('modalConfirmBtn').onclick = null; // Clear event listener
    }

    // Show error message
    function showError(message) {
      const tbody = document.querySelector('#ordersTable tbody');
      tbody.innerHTML = `<tr><td colspan="10" class="px-6 py-4 text-center text-red-600">${message}</td></tr>`;
      
      // Reset metrics
      document.getElementById('totalOpen').textContent = '0';
      document.getElementById('overdue').textContent = '0';
      document.getElementById('todayActions').textContent = '0';
      document.getElementById('avgDays').textContent = '0.0';
      
      // Clear charts if they exist
      if (actionChartInstance) {
        actionChartInstance.destroy();
        actionChartInstance = null;
      }
      if (daysChartInstance) {
        daysChartInstance.destroy();
        daysChartInstance = null;
      }
    }

    // Edit order function (using custom modal)
    function editOrder(orderId) {
      showModal(`עריכת הזמנה ${orderId} - פונקציונליות זו תפותח בהמשך`);
    }

    // Confirm close order function (using custom modal)
    function confirmCloseOrder(orderId) {
        showModal(`האם אתה בטוח שברצונך לסגור את הזמנה מספר ${orderId}?`, () => closeOrder(orderId));
    }

    // Close order function
    async function closeOrder(orderId) {
        try {
            // Update the status in the Google Sheet (assuming your script handles this)
            const res = await fetch(`${SCRIPT_URL}?action=close&orderId=${orderId}`);
            const data = await res.json();

            if (data.success) {
                // Update the local allOrders array
                const index = allOrders.findIndex(o => o['תעודה'] === orderId);
                if (index !== -1) {
                    allOrders[index].closed = true; // Mark as closed
                }
                showModal(`הזמנה ${orderId} נסגרה בהצלחה!`);
                filterOrders(); // Re-filter and update dashboard
            } else {
                showModal(`שגיאה בסגירת הזמנה ${orderId}: ${data.message || 'נסה שוב מאוחר יותר.'}`);
            }
        } catch (error) {
            console.error('Error closing order:', error);
            showModal(`שגיאה בחיבור לשרת בעת סגירת הזמנה ${orderId}.`);
        }
    }

    // Update overdue orders banner
    function updateOverdueBanner(orders) {
      const overdueList = document.getElementById('overdueOrdersList');
      const overdueBanner = document.getElementById('overdueOrdersBanner');
      
      overdueList.innerHTML = ''; // Clear previous list

      const overdueOrders = orders.filter(o => parseInt(o['ימים שעברו'] || 0) > 10 && !o.closed);

      if (overdueOrders.length > 0) {
        overdueBanner.classList.remove('hidden');
        overdueOrders.forEach(o => {
          const listItem = document.createElement('li');
          listItem.textContent = `תעודה: ${o['תעודה']}, לקוח: ${o['שם לקוח']}, ימים שעברו: ${o['ימים שעברו']}`;
          overdueList.appendChild(listItem);
        });
      } else {
        overdueBanner.classList.add('hidden');
      }
    }

    // Expose functions to global scope for button clicks
    window.editOrder = editOrder;
    window.confirmCloseOrder = confirmCloseOrder; // Expose the confirm function
  </script>
</body>
</html>
